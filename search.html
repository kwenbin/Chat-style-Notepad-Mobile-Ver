<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æœç´¢èŠå¤©è®°å½• - èŠå¤©å¼è®°äº‹æœ¬</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background-color: #f8f9fa;
            color: #2c3e50;
            height: 100vh;
        }

        /* é¡¶éƒ¨å¯¼èˆªæ  */
        .top-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 56px;
            background-color: #ffffff;
            display: flex;
            align-items: center;
            padding: 0 16px;
            border-bottom: 1px solid #eaeaea;
            z-index: 100;
        }

        .nav-btn {
            width: 44px;
            height: 44px;
            border: none;
            background: none;
            font-size: 20px;
            color: #2c3e50;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            transition: background-color 0.2s ease;
        }

        .nav-btn:hover {
            background-color: #f8f9fa;
        }

        .nav-title {
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
            text-align: center;
            flex: 1;
            margin: 0 8px;
        }

        /* æœç´¢åŒºåŸŸ */
        .search-container {
            margin-top: 70px;
            padding: 16px;
        }

        .search-box {
            position: relative;
            margin-bottom: 20px;
        }

        .search-input {
            width: 100%;
            padding: 14px 50px 14px 16px;
            border: 2px solid #eaeaea;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s ease;
            background-color: #ffffff;
        }

        .search-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .search-btn {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            width: 36px;
            height: 36px;
            border: none;
            border-radius: 8px;
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: #ffffff;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .search-btn:hover {
            transform: translateY(-50%) scale(1.05);
        }

        /* æœç´¢é€‰é¡¹ */
        .search-options {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .search-option-btn {
            padding: 8px 16px;
            border: 2px solid #eaeaea;
            background-color: #ffffff;
            color: #2c3e50;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .search-option-btn:hover {
            border-color: #3498db;
        }

        .search-option-btn.active {
            background-color: #3498db;
            color: #ffffff;
            border-color: #3498db;
        }

        /* æœç´¢ç»“æœåŒºåŸŸ */
        .results-container {
            height: calc(100vh - 200px);
            overflow-y: auto;
            padding-bottom: 20px;
        }

        .result-count {
            text-align: center;
            font-size: 14px;
            color: #7f8c8d;
            margin-bottom: 16px;
            padding: 8px;
            background-color: #f8f9fa;
            border-radius: 8px;
        }

        .result-item {
            background-color: #ffffff;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            border: 1px solid #eaeaea;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            transition: all 0.2s ease;
        }

        .result-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            border-color: #3498db;
        }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .result-tab {
            font-size: 12px;
            color: #ffffff;
            background-color: #3498db;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: 600;
        }

        .result-date {
            font-size: 12px;
            color: #7f8c8d;
        }

        .result-user {
            font-size: 14px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 4px;
        }

        .result-user.self {
            color: #3498db;
        }

        .result-user.assistant {
            color: #2ecc71;
        }

        .result-content {
            font-size: 16px;
            color: #2c3e50;
            line-height: 1.5;
            word-break: break-word;
        }

        .result-content .highlight {
            background-color: #ffeaa7;
            padding: 1px 2px;
            border-radius: 3px;
            font-weight: 600;
        }

        .result-tags {
            display: flex;
            gap: 6px;
            margin-top: 8px;
            flex-wrap: wrap;
        }

        .result-tag {
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 10px;
            font-weight: 600;
        }

        .result-tag.important {
            background-color: #ffeaa7;
            color: #d35400;
        }

        .result-tag.todo {
            background-color: #d5f4e6;
            color: #27ae60;
        }

        .result-tag.completed {
            background-color: #e8f6f3;
            color: #16a085;
            text-decoration: line-through;
        }

        /* ç©ºçŠ¶æ€ */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 300px;
            text-align: center;
        }

        .empty-icon {
            font-size: 60px;
            color: #bdc3c7;
            margin-bottom: 20px;
        }

        .empty-title {
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
        }

        .empty-text {
            font-size: 14px;
            color: #7f8c8d;
            line-height: 1.5;
        }

        /* åŠ è½½åŠ¨ç”» */
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .loading.show {
            display: block;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* å®‰å…¨åŒºåŸŸé€‚é… */
        @supports (padding-top: env(safe-area-inset-top)) {
            .top-bar {
                padding-top: env(safe-area-inset-top);
                height: calc(56px + env(safe-area-inset-top));
            }
            
            .search-container {
                margin-top: calc(70px + env(safe-area-inset-top));
            }
        }
    </style>
</head>
<body>
    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <div class="top-bar">
        <button class="nav-btn" id="backBtn" title="è¿”å›">
            <i class="fas fa-arrow-left"></i>
        </button>
        <div class="nav-title">æœç´¢èŠå¤©è®°å½•</div>
    </div>

    <!-- æœç´¢åŒºåŸŸ -->
    <div class="search-container">
        <div class="search-box">
            <input type="text" class="search-input" id="searchInput" placeholder="è¾“å…¥å…³é”®è¯æœç´¢..." autocomplete="off">
            <button class="search-btn" id="searchBtn">
                <i class="fas fa-search"></i>
            </button>
        </div>

        <!-- æœç´¢é€‰é¡¹ -->
        <div class="search-options">
            <button class="search-option-btn active" data-type="all">å…¨éƒ¨</button>
            <button class="search-option-btn" data-type="todo">å¾…åŠäº‹é¡¹</button>
            <button class="search-option-btn" data-type="completed">å·²å®Œæˆ</button>
            <button class="search-option-btn" data-type="important">é‡è¦äº‹é¡¹</button>
            <button class="search-option-btn" data-type="self">æˆ‘çš„æ¶ˆæ¯</button>
            <button class="search-option-btn" data-type="assistant">åŠ©æ‰‹å›å¤</button>
        </div>

        <!-- åŠ è½½åŠ¨ç”» -->
        <div class="loading" id="loading">
            <div class="loading-spinner"></div>
            <div>æœç´¢ä¸­...</div>
        </div>

        <!-- æœç´¢ç»“æœåŒºåŸŸ -->
        <div class="results-container" id="resultsContainer">
            <div class="empty-state" id="emptyState">
                <div class="empty-icon">
                    <i class="fas fa-search"></i>
                </div>
                <div class="empty-title">æœç´¢èŠå¤©è®°å½•</div>
                <div class="empty-text">
                    è¾“å…¥å…³é”®è¯æœç´¢æ‰€æœ‰æ ‡ç­¾çš„èŠå¤©è®°å½•<br>
                    æ”¯æŒæœç´¢æ–‡æœ¬ã€å¾…åŠäº‹é¡¹ã€é‡è¦æ ‡è®°ç­‰
                </div>
            </div>
        </div>
    </div>

    <script>
        // çŠ¶æ€ç®¡ç†
        const state = {
            searchKeyword: '',
            searchType: 'all',
            searchResults: [],
            allChatData: null
        };

        // DOMå…ƒç´ å¼•ç”¨
        const backBtn = document.getElementById('backBtn');
        const searchInput = document.getElementById('searchInput');
        const searchBtn = document.getElementById('searchBtn');
        const searchOptions = document.querySelectorAll('.search-option-btn');
        const loading = document.getElementById('loading');
        const resultsContainer = document.getElementById('resultsContainer');
        const emptyState = document.getElementById('emptyState');

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            // åŠ è½½èŠå¤©æ•°æ®
            loadChatData();
            
            // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
            setupEventListeners();
            
            // è‡ªåŠ¨èšç„¦åˆ°æœç´¢æ¡†
            setTimeout(() => {
                searchInput.focus();
            }, 300);
        });

        // åŠ è½½èŠå¤©æ•°æ®
        function loadChatData() {
            try {
                const saved = localStorage.getItem('chatNotepad_mobile');
                if (saved) {
                    state.allChatData = JSON.parse(saved);
                    console.log('èŠå¤©æ•°æ®åŠ è½½æˆåŠŸï¼Œæ ‡ç­¾æ•°:', state.allChatData.tabs.length);
                } else {
                    state.allChatData = { tabs: [] };
                    console.log('æœªæ‰¾åˆ°èŠå¤©æ•°æ®');
                }
            } catch (error) {
                console.error('åŠ è½½èŠå¤©æ•°æ®å¤±è´¥:', error);
                state.allChatData = { tabs: [] };
            }
        }

        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            // è¿”å›æŒ‰é’®
            backBtn.addEventListener('click', () => {
                window.history.back();
            });

            // æœç´¢æŒ‰é’®
            searchBtn.addEventListener('click', performSearch);

            // æœç´¢è¾“å…¥æ¡†æŒ‰Enteré”®æœç´¢
            searchInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    performSearch();
                }
            });

            // æœç´¢é€‰é¡¹ç‚¹å‡»
            searchOptions.forEach(option => {
                option.addEventListener('click', function() {
                    // ç§»é™¤å…¶ä»–é€‰é¡¹çš„activeç±»
                    searchOptions.forEach(opt => opt.classList.remove('active'));
                    // ç»™å½“å‰ç‚¹å‡»çš„é€‰é¡¹æ·»åŠ activeç±»
                    this.classList.add('active');
                    
                    // æ›´æ–°æœç´¢ç±»å‹
                    state.searchType = this.dataset.type;
                    
                    // å¦‚æœå·²ç»æœ‰æœç´¢å…³é”®è¯ï¼Œé‡æ–°æœç´¢
                    if (state.searchKeyword.trim()) {
                        performSearch();
                    }
                });
            });
        }

        // æ‰§è¡Œæœç´¢
        function performSearch() {
            const keyword = searchInput.value.trim();
            
            if (!keyword) {
                showEmptyState('è¯·è¾“å…¥æœç´¢å…³é”®è¯');
                return;
            }
            
            if (!state.allChatData || !state.allChatData.tabs.length) {
                showEmptyState('æœªæ‰¾åˆ°èŠå¤©è®°å½•');
                return;
            }
            
            state.searchKeyword = keyword;
            
            // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
            loading.classList.add('show');
            emptyState.style.display = 'none';
            resultsContainer.innerHTML = '';
            
            // æ¨¡æ‹Ÿå¼‚æ­¥æœç´¢ï¼ˆé¿å…é˜»å¡UIï¼‰
            setTimeout(() => {
                const results = searchChatData(keyword);
                displaySearchResults(results);
                loading.classList.remove('show');
            }, 300);
        }

        // æœç´¢èŠå¤©æ•°æ®
        function searchChatData(keyword) {
            const results = [];
            const keywordLower = keyword.toLowerCase();
            
            if (!state.allChatData || !state.allChatData.tabs) {
                return results;
            }
            
            // éå†æ‰€æœ‰æ ‡ç­¾
            state.allChatData.tabs.forEach(tab => {
                // æ£€æŸ¥æ ‡ç­¾åç§°æ˜¯å¦åŒ¹é…
                if (tab.name.toLowerCase().includes(keywordLower) && state.searchType === 'all') {
                    results.push({
                        tab: tab,
                        message: null, // æ ‡ç­¾åŒ¹é…ï¼Œä¸æ˜¯å…·ä½“æ¶ˆæ¯
                        matchType: 'tab'
                    });
                }
                
                // éå†æ ‡ç­¾ä¸­çš„æ‰€æœ‰æ¶ˆæ¯
                if (tab.messages && Array.isArray(tab.messages)) {
                    tab.messages.forEach(message => {
                        if (shouldIncludeMessage(message, keywordLower)) {
                            results.push({
                                tab: tab,
                                message: message,
                                matchType: 'content'
                            });
                        }
                    });
                }
            });
            
            return results;
        }

        // åˆ¤æ–­æ¶ˆæ¯æ˜¯å¦åº”è¯¥åŒ…å«åœ¨æœç´¢ç»“æœä¸­
        function shouldIncludeMessage(message, keywordLower) {
            // æ ¹æ®æœç´¢ç±»å‹è¿‡æ»¤
            switch (state.searchType) {
                case 'todo':
                    if (!message.content.includes('[å¾…åŠ]') || message.content.includes('[å¾…åŠå®Œæˆ]')) return false;
                    break;
                case 'completed':
                    if (!message.content.includes('[å¾…åŠå®Œæˆ]')) return false;
                    break;
                case 'important':
                    if (!message.content.includes('[é‡è¦]')) return false;
                    break;
                case 'self':
                    if (!message.isSelf) return false;
                    break;
                case 'assistant':
                    if (message.isSelf) return false;
                    break;
            }
            
            // æœç´¢å†…å®¹åŒ¹é…
            const contentLower = message.content.toLowerCase();
            
            // æ£€æŸ¥æ¶ˆæ¯å†…å®¹æ˜¯å¦åŒ…å«å…³é”®è¯
            if (contentLower.includes(keywordLower)) {
                return true;
            }
            
            // æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦åŒ…å«å…³é”®è¯
            if (message.username && message.username.toLowerCase().includes(keywordLower)) {
                return true;
            }
            
            return false;
        }

        // æ˜¾ç¤ºæœç´¢ç»“æœ
        function displaySearchResults(results) {
            resultsContainer.innerHTML = '';
            
            if (results.length === 0) {
                showEmptyState(`æœªæ‰¾åˆ°åŒ…å«"${state.searchKeyword}"çš„ç»“æœ`);
                return;
            }
            
            // æ˜¾ç¤ºç»“æœæ•°é‡
            const countElement = document.createElement('div');
            countElement.className = 'result-count';
            countElement.textContent = `æ‰¾åˆ° ${results.length} æ¡ç»“æœ`;
            resultsContainer.appendChild(countElement);
            
            // æ˜¾ç¤ºç»“æœåˆ—è¡¨
            results.forEach(result => {
                const resultElement = createResultElement(result);
                resultsContainer.appendChild(resultElement);
            });
        }

        // åˆ›å»ºå•ä¸ªç»“æœå…ƒç´ 
        function createResultElement(result) {
            const element = document.createElement('div');
            element.className = 'result-item';
            
            // å¦‚æœæ˜¯æ ‡ç­¾åŒ¹é…
            if (result.matchType === 'tab') {
                element.innerHTML = `
                    <div class="result-header">
                        <span class="result-tag" style="background-color: #3498db; color: white;">æ ‡ç­¾åŒ¹é…</span>
                        <span class="result-date">æ ‡ç­¾</span>
                    </div>
                    <div class="result-user" style="color: #2c3e50;">
                        <i class="fas fa-tag"></i> æ ‡ç­¾åç§°
                    </div>
                    <div class="result-content">
                        ${highlightKeyword(result.tab.name, state.searchKeyword)}
                    </div>
                `;
            } 
            // å¦‚æœæ˜¯æ¶ˆæ¯åŒ¹é…
            else {
                const message = result.message;
                const time = new Date(message.time);
                const formattedDate = time.toLocaleDateString('zh-CN') + ' ' + time.toLocaleTimeString('zh-CN', { 
                    hour: '2-digit', 
                    minute: '2-digit',
                    hour12: false
                });
                
                // æ£€æµ‹æ¶ˆæ¯ç±»å‹
                const tags = [];
                if (message.content.includes('[é‡è¦]')) tags.push('important');
                if (message.content.includes('[å¾…åŠ]') && !message.content.includes('[å¾…åŠå®Œæˆ]')) tags.push('todo');
                if (message.content.includes('[å¾…åŠå®Œæˆ]')) tags.push('completed');
                
                // æ¸…ç†æ¶ˆæ¯å†…å®¹ï¼ˆç§»é™¤æ ¼å¼æ ‡è®°ï¼‰
                let cleanContent = message.content
                    .replace(/\[b\](.*?)\[\/b\]/g, '$1')
                    .replace(/\[i\](.*?)\[\/i\]/g, '$1')
                    .replace(/\[u\](.*?)\[\/u\]/g, '$1')
                    .replace(/\[s\](.*?)\[\/s\]/g, '$1')
                    .replace(/\[é‡è¦\]/g, '')
                    .replace(/\[å¾…åŠ\]/g, '')
                    .replace(/\[å¾…åŠå®Œæˆ\]/g, '')
                    .trim();
                
                // é«˜äº®å…³é”®è¯
                const highlightedContent = highlightKeyword(cleanContent, state.searchKeyword);
                
                element.innerHTML = `
                    <div class="result-header">
                        <span class="result-tab">${result.tab.name}</span>
                        <span class="result-date">${formattedDate}</span>
                    </div>
                    <div class="result-user ${message.isSelf ? 'self' : 'assistant'}">
                        ${message.isSelf ? 'ğŸ‘¤' : 'ğŸ¤–'} ${message.username}
                    </div>
                    <div class="result-content">${highlightedContent}</div>
                    ${tags.length > 0 ? `
                    <div class="result-tags">
                        ${tags.map(tag => `
                            <span class="result-tag ${tag}">
                                ${tag === 'important' ? 'é‡è¦' : 
                                  tag === 'todo' ? 'å¾…åŠ' : 
                                  tag === 'completed' ? 'å·²å®Œæˆ' : ''}
                            </span>
                        `).join('')}
                    </div>
                    ` : ''}
                `;
                
                // ç‚¹å‡»ç»“æœè·³è½¬å›ä¸»é¡µé¢å¹¶å®šä½åˆ°è¯¥æ¶ˆæ¯
                element.addEventListener('click', () => {
                    // å­˜å‚¨æ ‡ç­¾å’Œæ¶ˆæ¯ä¿¡æ¯åˆ°æœ¬åœ°ï¼Œç„¶åè·³è½¬å›ä¸»é¡µé¢
                    const jumpData = {
                        tabId: result.tab.id,
                        messageId: message.id,
                        timestamp: Date.now()
                    };
                    
                    localStorage.setItem('chat_search_jump', JSON.stringify(jumpData));
                    window.location.href = 'index.html';
                });
            }
            
            return element;
        }

        // é«˜äº®å…³é”®è¯
        function highlightKeyword(text, keyword) {
            if (!keyword || !text) return text;
            
            const regex = new RegExp(`(${keyword})`, 'gi');
            return text.replace(regex, '<span class="highlight">$1</span>');
        }

        // æ˜¾ç¤ºç©ºçŠ¶æ€
        function showEmptyState(message) {
            emptyState.innerHTML = `
                <div class="empty-icon">
                    <i class="fas fa-search"></i>
                </div>
                <div class="empty-title">${message}</div>
                <div class="empty-text">
                    å°è¯•ä½¿ç”¨ä¸åŒçš„å…³é”®è¯æˆ–æœç´¢ç±»å‹
                </div>
            `;
            emptyState.style.display = 'flex';
        }
    </script>
</body>
</html>