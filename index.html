<!DOCTYPE html>
<html lang="zh-CN">
<head>
<script>
// Á´ãÂç≥Ê≥®ÂÜå Service Worker
if ('serviceWorker' in navigator) {
  window.addEventListener('load', function() {
    navigator.serviceWorker.register('sw.js')
      .then(registration => {
        console.log('ServiceWorker Ê≥®ÂÜåÊàêÂäüÔºå‰ΩúÁî®Âüü‰∏∫: ', registration.scope);
        // ÂèØ‰ª•Âú®ËøôÈáåÊòæÁ§∫‚ÄúÂ∫îÁî®Â∑≤ÂáÜÂ§áÂ•ΩÂÆâË£Ö‚ÄùÁöÑÊèêÁ§∫
      })
      .catch(err => {
        console.log('ServiceWorker Ê≥®ÂÜåÂ§±Ë¥•: ', err);
      });
  });
}
</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ËÅäÂ§©ÂºèËÆ∞‰∫ãÊú¨ - ÁßªÂä®Áâà</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="xlsx.full.min.js"></script>
<!-- PWAÁõ∏ÂÖ≥metaÊ†áÁ≠æ -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#3498db">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="ËÅäÂ§©ËÆ∞‰∫ãÊú¨">
<link rel="apple-touch-icon" href="icon-192x192.png">
<meta name="mobile-web-app-capable" content="yes">
<meta name="application-name" content="ËÅäÂ§©ËÆ∞‰∫ãÊú¨">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background-color: #f8f9fa;
            color: #2c3e50;
            overflow: hidden;
            height: 100vh;
        }

        /* È°∂ÈÉ®ÂØºËà™Ê†è */
        .top-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 56px;
            background-color: #ffffff;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
            border-bottom: 1px solid #eaeaea;
            z-index: 100;
        }

        .nav-btn {
            width: 44px;
            height: 44px;
            border: none;
            background: none;
            font-size: 24px;
            color: #2c3e50;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            transition: background-color 0.2s ease;
        }

        .nav-btn:hover {
            background-color: #f8f9fa;
        }

        .nav-title {
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 60%;
        }

        /* ËÅäÂ§©ÂÜÖÂÆπÂå∫Âüü */
.chat-container {
    position: fixed;
    top: 56px;
    left: 0;
    right: 0;
    bottom: 0;
    overflow-y: auto;
    padding: 16px;
    padding-bottom: 160px;
    display: flex;
    flex-direction: column; /* Ê∑ªÂä†Ëøô‰∏ÄË°å */
}

        /* Êó∂Èó¥ÂàÜÈöîÁ∫ø */
        .time-divider {
            text-align: center;
            margin: 20px 0;
            position: relative;
        }

        .time-divider::before {
            content: '';
            position: absolute;
            left: 0;
            right: 0;
            top: 50%;
            height: 1px;
            background-color: #eaeaea;
            z-index: 1;
        }

        .time-text {
            display: inline-block;
            padding: 6px 12px;
            background-color: #ffffff;
            border-radius: 12px;
            font-size: 12px;
            color: #95a5a6;
            position: relative;
            z-index: 2;
            border: 1px solid #eaeaea;
        }

        /* Ê∂àÊÅØÊ∞îÊ≥° - ‰øÆÊîπÔºöÁ°Æ‰øùËá™Â∑±ÁöÑÊ∞îÊ≥°Èù†Âè≥ */
.message {
    margin-bottom: 12px;
    display: flex;
    flex-direction: column;
    position: relative;
    max-width: 100%;
}

        .message.self {
    align-self: flex-end;
    margin-left: auto;
    margin-right: 0;
    max-width: 85vw;
    width: fit-content;
    display: flex;
    flex-direction: column;
    align-items: flex-end; /* Ê∑ªÂä†Ëøô‰∏ÄË°å */
}

.message.other {
    align-self: flex-start;
    margin-right: auto;
    max-width: 85vw;
    width: fit-content;
    display: flex;
    flex-direction: column;
    align-items: flex-start; /* Ê∑ªÂä†Ëøô‰∏ÄË°å */
}

        .message-header {
            display: flex;
            align-items: center;
            margin-bottom: 4px;
            font-size: 12px;
            color: #7f8c8d;
            width: 100%;
        }

        .message.self .message-header {
            justify-content: flex-end;
        }

        .message.other .message-header {
            justify-content: flex-start;
        }

        .username {
            font-weight: 600;
        }

        .message-time {
            opacity: 0.8;
        }

        .message.self .message-header .username {
            margin-left: 8px;
        }

        .message.other .message-header .username {
            margin-right: 8px;
        }

        /* ‰øÆÊîπÔºöÊâÄÊúâÊ∞îÊ≥°ÈÉΩÊúâÈò¥ÂΩ±ÊïàÊûú */
        .bubble {
            padding: 12px 16px;
            border-radius: 20px;
            word-wrap: break-word;
            white-space: pre-wrap;
            line-height: 1.5;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            position: relative;
            user-select: text;
            cursor: pointer;
            transition: transform 0.2s ease, background-color 0.3s ease;
            /* ‰øÆÊîπÔºöÊ∞îÊ≥°ÂÆΩÂ∫¶Ëá™ÈÄÇÂ∫îÔºå‰ΩÜ‰∏çË∂ÖËøáÂ±èÂπïÂÆΩÂ∫¶ÁöÑ85% */
            min-width: 40px; /* Â§ßÁ∫¶2‰∏™Â≠óÁ¨¶ÁöÑÂÆΩÂ∫¶ */
            max-width: 85vw; /* ÊúÄÂ§ß‰∏∫ËßÜÂè£ÂÆΩÂ∫¶ÁöÑ85% */
            width: fit-content;
            /* Â≠ó‰ΩìÂ§ßÂ∞èÂ∞ÜÁî±JavaScriptÂä®ÊÄÅËÆæÁΩÆ */
        }

        .message.self .bubble {
            background-color: #3498db;
            color: #ffffff;
            border-bottom-right-radius: 6px;
            box-shadow: 0 3px 12px rgba(0, 0, 0, 0.18);
        }

        .message.other .bubble {
            background-color: #ffffff;
            color: #2c3e50;
            border: 1px solid #eaeaea;
            border-bottom-left-radius: 6px;
        }

        /* ÂæÖÂäûÊ∞îÊ≥°Ê†∑Âºè - ‰øÆÊîπÔºöËá™Â∑±ÁöÑÊ∂àÊÅØ‰∏çÊòæÁ§∫ÂãæÈÄâÊ°Ü */
        .message.self .bubble.todo-pending::before,
        .message.self .bubble.todo-completed::before {
            display: none;
        }

        .message.other .bubble.todo-pending::before {
            content: '‚òê';
            margin-right: 8px;
            font-size: 18px;
            cursor: pointer;
        }

        .message.other .bubble.todo-completed::before {
            content: '‚òë';
            margin-right: 8px;
            font-size: 18px;
            cursor: pointer;
            color: #27ae60;
        }

        .bubble.todo-completed {
            color: #95a5a6 !important;
            text-decoration: line-through;
        }

        .message.self .bubble.todo-completed {
            background-color: #3498db;
            opacity: 0.8;
        }

        .message.other .bubble.todo-completed {
            background-color: #ffffff;
            opacity: 0.8;
        }

        /* ÈáçË¶ÅÊ∞îÊ≥°Ê†∑Âºè */
        .bubble.important {
            border-left: 4px solid #e74c3c;
        }

        /* ÊäñÂä®Âä®Áîª */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-2px); }
            75% { transform: translateX(2px); }
        }

        .bubble.shake {
            animation: shake 0.3s ease;
        }

        /* ËæìÂÖ•Âå∫Âüü - ‰øÆÊîπÂêé */
        .input-container {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: #ffffff;
            border-top: 1px solid #eaeaea;
            z-index: 100;
            transition: transform 0.3s ease;
            padding-bottom: env(safe-area-inset-bottom);
        }

        .input-container.keyboard-open {
            transform: translateY(-50%);
        }

        .message-input-container {
            position: relative;
            border-top: 1px solid transparent;
            display: flex;
            flex-direction: column;
        }

        /* ÂúÜÂΩ¢Âä†Âè∑ÊåâÈíÆ - ‰øÆÂ§ç‰ΩçÁΩÆÔºåÊèêÈ´ò‰ΩçÁΩÆÈÅøÂÖçË¢´ËæìÂÖ•Ê°ÜÈÅÆÊå° */
        .quick-actions {
            position: fixed;
            bottom: 120px; /* ÊèêÈ´ò‰ΩçÁΩÆÔºåÈÅøÂÖçË¢´ËæìÂÖ•Ê°ÜÈÅÆÊå° */
            right: 16px;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            z-index: 150;
        }

        .quick-main-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: #ffffff;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
            transition: all 0.3s ease;
            z-index: 151;
            position: fixed; /* Êîπ‰∏∫fixedÂÆö‰Ωç */
            bottom: 120px; /* ÊèêÈ´ò‰ΩçÁΩÆ */
            right: 16px;
        }

        .quick-main-btn:hover {
            transform: rotate(90deg);
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
        }

        .quick-sub-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 10px;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s ease;
            pointer-events: none;
            position: fixed; /* Êîπ‰∏∫fixedÂÆö‰Ωç */
            bottom: 180px; /* ÊèêÈ´ò‰ΩçÁΩÆ */
            right: 16px;
        }

        .quick-sub-buttons.show {
            opacity: 1;
            transform: translateY(0);
            pointer-events: all;
        }

        .quick-sub-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            border: none;
            color: #ffffff;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
            transition: all 0.2s ease;
        }

        .quick-sub-btn.todo {
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
        }

        .quick-sub-btn.completed {
            background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
        }

        .quick-sub-btn.important {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }

        .quick-sub-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .quick-sub-btn .badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: #e74c3c;
            color: white;
            font-size: 10px;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .message-input {
            width: 100%;
            min-height: 40px;
            max-height: 200px;
            padding: 10px 16px;
            border: none;
            outline: none;
            font-size: 16px;
            line-height: 1.5;
            resize: none;
            font-family: inherit;
            background-color: #ffffff;
            overflow-y: auto;
            transition: min-height 0.2s ease;
        }

        .message-input.focused {
            min-height: 60px;
        }

        .message-input::placeholder {
            color: #95a5a6;
        }

        .input-toolbar {
            height: 44px;
            padding: 0 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-top: none;
        }

        .toolbar-left {
            display: flex;
            align-items: center;
            gap: 4px;
            flex: 1;
        }

        .toolbar-right {
            display: flex;
            align-items: center;
        }

        .format-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: none;
            background-color: #ecf0f1;
            color: #3498db;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .format-btn:hover {
            background-color: #e0e6e8;
        }

        .format-btn.active {
            background-color: #2c3e50;
            color: #ffffff;
        }

        .tag-btn {
            width: 36px;
            height: 36px;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            font-weight: bold;
            font-size: 16px;
        }

        .tag-btn.important {
            background-color: #e74c3c;
            color: #ffffff;
        }

        .tag-btn.important:hover {
            background-color: #c0392b;
        }

        .tag-btn.todo {
            background-color: #2ecc71;
            color: #ffffff;
        }

        .tag-btn.todo:hover {
            background-color: #27ae60;
        }

        .send-btn {
            width: 44px;
            height: 44px;
            border: none;
            border-radius: 50%;
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: #ffffff;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            margin-left: 8px;
        }

        .send-btn:hover {
            background: linear-gradient(135deg, #2980b9 0%, #2573a7 100%);
            transform: translateY(-1px);
        }

        .send-btn.show {
            display: flex;
            animation: slideInRight 0.3s ease;
        }

        /* Ê∞îÊ≥°ËèúÂçï - ‰øÆÊîπÔºöÂ¢ûÂä†Ê†áËÆ∞ÂÆåÊàê/ÈáçÊñ∞ÂæÖÂäûÈÄâÈ°π */
        .bubble-menu {
            position: fixed;
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            z-index: 2000;
            padding: 8px;
            display: none;
            flex-direction: column;
            min-width: 160px;
            border: 1px solid #eaeaea;
        }

        .bubble-menu.show {
            display: flex;
            animation: fadeIn 0.2s ease;
        }

        .bubble-menu-item {
            padding: 12px 16px;
            border: none;
            background: none;
            text-align: left;
            font-size: 15px;
            color: #2c3e50;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            border-radius: 8px;
            transition: background-color 0.2s ease;
        }

        .bubble-menu-item:hover {
            background-color: #f8f9fa;
        }

        .bubble-menu-item.important.active {
            color: #e74c3c;
        }

        .bubble-menu-item.todo.active {
            color: #2ecc71;
        }

        .bubble-menu-item.complete {
            color: #27ae60;
        }

        .bubble-menu-item.reopen {
            color: #f39c12;
        }

        .bubble-menu-item.delete {
            color: #e74c3c;
            border-top: 1px solid #f1f1f1;
            margin-top: 4px;
            padding-top: 16px;
        }

        .bubble-menu-item.delete:hover {
            background-color: #fee;
        }

        /* Âä©ÊâãÂæÖÂäûË°®Ê†ºÊ†∑Âºè */
        .todo-table-container {
            margin: 12px 0;
            width: 100%;
            max-width: 85vw;
        }

        .todo-table {
            width: 100%;
            border-collapse: collapse;
            background-color: #ffffff;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            border: 1px solid #eaeaea;
        }

        .todo-table th {
            background-color: #f8f9fa;
            padding: 8px 12px;
            text-align: left;
            font-size: 12px;
            color: #7f8c8d;
            font-weight: 600;
            border-bottom: 1px solid #eaeaea;
        }

        .todo-table td {
            padding: 12px;
            border-bottom: 1px solid #f1f1f1;
            vertical-align: middle;
        }

        .todo-table tr:last-child td {
            border-bottom: none;
        }

        .todo-date {
            font-size: 12px;
            color: #7f8c8d;
            white-space: nowrap;
        }

        .todo-tag {
            font-size: 12px;
            font-weight: bold;
            color: #2ecc71;
        }

        .todo-content {
            font-size: 14px;
            color: #2c3e50;
            word-break: break-word;
        }

        .todo-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .todo-table tr.completed .todo-content {
            text-decoration: line-through;
            color: #95a5a6;
        }

        .save-todo-btn {
            margin-top: 12px;
            padding: 10px 20px;
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: #ffffff;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(52, 152, 219, 0.3);
        }

        .save-todo-btn:hover {
            background: linear-gradient(135deg, #2980b9 0%, #2573a7 100%);
            transform: translateY(-1px);
        }

        /* ÂèëÈÄÅÊñπÂºèÈÄâÈ°πÊ†∑Âºè */
        .dialog-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin: 20px 0;
        }

        .send-key-option {
            display: flex;
            align-items: flex-start;
            padding: 16px;
            border: 2px solid #eaeaea;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .send-key-option:hover {
            border-color: #3498db;
            background-color: #f8f9fa;
        }

        .send-key-option.selected {
            border-color: #3498db;
            background-color: #f0f7ff;
        }

        .option-radio {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid #bdc3c7;
            margin-right: 12px;
            margin-top: 2px;
            position: relative;
            transition: all 0.2s ease;
        }

        .send-key-option.selected .option-radio {
            border-color: #3498db;
            background-color: #3498db;
        }

        .send-key-option.selected .option-radio::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: white;
        }

        .option-text-full {
            flex: 1;
        }

        .option-title {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 4px;
        }

        .option-desc {
            font-size: 13px;
            color: #7f8c8d;
            line-height: 1.4;
        }

        /* Âä©ÊâãÂõûÂ§çÁöÑÂæÖÂäûÂàóË°®Ê†∑ÂºèÔºàÊóßÁâàÔºå‰øùÁïôÂÖºÂÆπÔºâ */
        .todo-list-item {
            margin-bottom: 8px;
            padding: 8px;
            border-radius: 8px;
            background-color: #f8f9fa;
            border: 1px solid #eaeaea;
        }

        .todo-list-header {
            display: flex;
            align-items: center;
            margin-bottom: 4px;
        }

        .todo-list-date {
            font-size: 12px;
            color: #7f8c8d;
            margin-right: 8px;
        }

        .todo-list-checkbox {
            margin-right: 8px;
            cursor: pointer;
        }

        .todo-list-content {
            margin-left: 6px;
            font-size: 14px;
            color: #2c3e50;
        }

        .todo-list-item.completed .todo-list-content {
            text-decoration: line-through;
            color: #95a5a6;
        }

        /* ‰æßÊªëËèúÂçï - Ê†áÁ≠æÁÆ°ÁêÜ */
        .side-menu {
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            width: 85%;
            max-width: 320px;
            background-color: #2c3e50;
            color: #ffffff;
            transform: translateX(-100%);
            transition: transform 0.3s ease;
            z-index: 1000;
            overflow-y: auto;
        }

        .side-menu.open {
            transform: translateX(0);
            box-shadow: 5px 0 30px rgba(0, 0, 0, 0.3);
        }

        .menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 999;
            display: none;
            cursor: pointer;
        }

        .menu-overlay.show {
            display: block;
        }

        .menu-header {
            padding: 20px 16px;
            border-bottom: 1px solid #34495e;
        }

        .menu-title {
            font-size: 20px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .tabs-list {
            padding: 16px;
        }

        .tab-item {
            padding: 12px 16px;
            border-radius: 8px;
            background-color: rgba(255, 255, 255, 0.1);
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid transparent;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        .tab-item:hover {
            background-color: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.2);
        }

        .tab-item.active {
            background-color: rgba(52, 152, 219, 0.8) !important;
            border-color: #3498db !important;
        }

        .tab-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }

        .tab-name {
            font-size: 16px;
            font-weight: 600;
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .tab-actions {
            display: flex;
            gap: 8px;
            opacity: 1;
        }

        .tab-action-btn {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 6px;
            background-color: rgba(255, 255, 255, 0.1);
            color: #ffffff;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .tab-action-btn:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        .tab-action-btn.pin {
            color: #f39c12;
        }

        .tab-action-btn.pin.active {
            background-color: rgba(243, 156, 18, 0.3);
        }

        .tab-action-btn.rename {
            color: #3498db;
        }

        .tab-action-btn.delete {
            color: #e74c3c;
        }

        .tab-preview {
            font-size: 13px;
            color: #ecf0f1;
            opacity: 0.8;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .menu-actions {
            padding: 16px;
            border-top: 1px solid #34495e;
            margin-top: auto;
        }

        .new-tab-btn {
            width: 100%;
            padding: 14px;
            border-radius: 12px;
            border: none;
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: #ffffff;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .new-tab-btn:hover {
            transform: translateY(-2px);
        }

        /* ËÆæÁΩÆËèúÂçï - Â∫ïÈÉ®ÂºπÂá∫ */
        .settings-menu {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: #ffffff;
            border-radius: 16px 16px 0 0;
            transform: translateY(100%);
            transition: transform 0.3s ease;
            z-index: 1001;
            box-shadow: 0 -10px 40px rgba(0, 0, 0, 0.1);
            max-height: 80vh;
            overflow-y: auto;
        }

        .settings-menu.open {
            transform: translateY(0);
        }

        .settings-header {
            padding: 20px 16px;
            border-bottom: 1px solid #eaeaea;
            text-align: center;
            position: relative;
        }

        .settings-title {
            font-size: 18px;
            font-weight: 700;
            color: #2c3e50;
        }

        .close-settings {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            width: 44px;
            height: 44px;
            border: none;
            background: none;
            font-size: 24px;
            color: #7f8c8d;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
        }

        .close-settings:hover {
            background-color: #f8f9fa;
        }

        .settings-options {
            padding: 8px 0;
        }

        .settings-option {
            padding: 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            transition: background-color 0.2s ease;
            border-bottom: 1px solid #f8f9fa;
        }

        .settings-option:last-child {
            border-bottom: none;
        }

        .settings-option:hover {
            background-color: #f8f9fa;
        }

        .option-text {
            font-size: 16px;
            color: #2c3e50;
            flex: 1;
        }

        .option-value {
            font-size: 14px;
            color: #7f8c8d;
            margin-right: 8px;
        }

        .option-icon {
            color: #7f8c8d;
            font-size: 20px;
        }

        /* Áî®Êà∑Âêç‰øÆÊîπÂºπÁ™ó */
        .username-dialog {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #ffffff;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            z-index: 2000;
            padding: 24px;
            width: 90%;
            max-width: 400px;
            display: none;
        }

        .username-dialog.show {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .dialog-header {
            margin-bottom: 20px;
        }

        .dialog-title {
            font-size: 20px;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 8px;
        }

        .dialog-text {
            font-size: 14px;
            color: #7f8c8d;
            line-height: 1.5;
        }

        .username-input {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #eaeaea;
            border-radius: 12px;
            font-size: 16px;
            margin-bottom: 24px;
            transition: border-color 0.2s ease;
        }

        .username-input:focus {
            outline: none;
            border-color: #3498db;
        }

        .dialog-actions {
            display: flex;
            gap: 12px;
        }

        .dialog-btn {
            flex: 1;
            padding: 14px;
            border-radius: 12px;
            border: none;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .dialog-btn.cancel {
            background-color: #ecf0f1;
            color: #2c3e50;
        }

        .dialog-btn.cancel:hover {
            background-color: #e0e6e8;
        }

        .dialog-btn.save {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: #ffffff;
        }

        .dialog-btn.save:hover {
            background: linear-gradient(135deg, #2980b9 0%, #2573a7 100%);
        }

        /* Á°ÆËÆ§ÂØπËØùÊ°Ü */
        .confirm-dialog {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #ffffff;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            z-index: 2000;
            padding: 24px;
            width: 90%;
            max-width: 400px;
            display: none;
        }

        .confirm-dialog.show {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .confirm-message {
            font-size: 16px;
            color: #2c3e50;
            line-height: 1.5;
            margin-bottom: 24px;
        }

        /* ÈáçÂëΩÂêçÂØπËØùÊ°Ü */
        .rename-dialog {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #ffffff;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            z-index: 2000;
            padding: 24px;
            width: 90%;
            max-width: 400px;
            display: none;
        }

        .rename-dialog.show {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .rename-input {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #eaeaea;
            border-radius: 12px;
            font-size: 16px;
            margin-bottom: 24px;
            transition: border-color 0.2s ease;
        }

        .rename-input:focus {
            outline: none;
            border-color: #3498db;
        }

        /* Âä©ÊâãÂêçÁß∞ÂØπËØùÊ°Ü */
        .assistant-dialog {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #ffffff;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            z-index: 2000;
            padding: 24px;
            width: 90%;
            max-width: 400px;
            display: none;
        }

        .assistant-dialog.show {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .assistant-input {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #eaeaea;
            border-radius: 12px;
            font-size: 16px;
            margin-bottom: 24px;
            transition: border-color 0.2s ease;
        }

        .assistant-input:focus {
            outline: none;
            border-color: #3498db;
        }

        /* ÂèëÈÄÅÊñπÂºèËÆæÁΩÆÂØπËØùÊ°Ü */
        .send-key-dialog {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #ffffff;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            z-index: 2000;
            padding: 24px;
            width: 90%;
            max-width: 400px;
            display: none;
        }

        .send-key-dialog.show {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        /* Ê¶ÇÁéáËÆæÁΩÆÂØπËØùÊ°Ü */
        .probability-dialog {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #ffffff;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            z-index: 2000;
            padding: 24px;
            width: 90%;
            max-width: 400px;
            display: none;
        }

        .probability-dialog.show {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .probability-slider {
            width: 100%;
            margin: 20px 0;
        }

        .probability-value {
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            color: #3498db;
            margin: 10px 0;
        }

        /* Â≠ó‰ΩìÂ§ßÂ∞èËÆæÁΩÆÂØπËØùÊ°Ü */
        .font-size-dialog {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #ffffff;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            z-index: 2000;
            padding: 24px;
            width: 90%;
            max-width: 400px;
            display: none;
        }

        .font-size-dialog.show {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .font-size-slider {
            width: 100%;
            margin: 20px 0;
        }

        .font-size-value {
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            color: #3498db;
            margin: 10px 0;
        }

        /* Ëá™Âä®ÂõûÂ§çÂÜÖÂÆπÁÆ°ÁêÜÂØπËØùÊ°Ü */
        .reply-content-dialog {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #ffffff;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            z-index: 2000;
            padding: 24px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            display: none;
            overflow-y: auto;
        }

        .reply-content-dialog.show {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .reply-list {
            margin: 20px 0;
            max-height: 300px;
            overflow-y: auto;
        }

        .reply-item {
            padding: 12px;
            border: 1px solid #eaeaea;
            border-radius: 8px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #f8f9fa;
        }

        .reply-text {
            flex: 1;
            margin-right: 12px;
            font-size: 14px;
            color: #2c3e50;
        }

        .reply-actions {
            display: flex;
            gap: 8px;
        }

        .reply-action-btn {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 6px;
            background-color: #ecf0f1;
            color: #7f8c8d;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .reply-action-btn:hover {
            background-color: #e0e6e8;
        }

        .reply-action-btn.delete {
            color: #e74c3c;
        }

        .add-reply-container {
            display: flex;
            gap: 8px;
            margin-top: 20px;
        }

        .add-reply-input {
            flex: 1;
            padding: 12px;
            border: 2px solid #eaeaea;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.2s ease;
        }

        .add-reply-input:focus {
            outline: none;
            border-color: #3498db;
        }

        .add-reply-btn {
            width: 44px;
            height: 44px;
            border: none;
            border-radius: 50%;
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
            color: #ffffff;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.2s ease;
        }

        .add-reply-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(46, 204, 113, 0.3);
        }

        /* Á©∫Áä∂ÊÄÅ */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            padding: 40px 20px;
            text-align: center;
        }

        .empty-icon {
            font-size: 60px;
            color: #bdc3c7;
            margin-bottom: 20px;
        }

        .empty-title {
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
        }

        .empty-text {
            font-size: 14px;
            color: #7f8c8d;
            line-height: 1.5;
        }

        /* Âä®Áîª */
        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Ê∂àÊÅØÂä®Áîª */
        .message {
            opacity: 0;
            animation: fadeIn 0.3s ease forwards;
        }

        /* ÊªöÂä®Êù°Ê†∑Âºè */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb {
            background: #bdc3c7;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #95a5a6;
        }

        .chat-container::-webkit-scrollbar {
            width: 4px;
        }

        /* ÈîÆÁõòÂºπÂá∫Êó∂ÊèêÈ´òÂø´ÈÄüÊåâÈíÆ‰ΩçÁΩÆ */
        .input-container.keyboard-open ~ .quick-actions .quick-main-btn {
            bottom: 180px;
        }

        .input-container.keyboard-open ~ .quick-actions .quick-sub-buttons {
            bottom: 240px;
        }

        /* ÂìçÂ∫îÂºèË∞ÉÊï¥ */
        @media (max-width: 320px) {
            .format-btn {
                width: 32px;
                height: 32px;
                font-size: 12px;
            }
            
            .tag-btn {
                width: 32px;
                height: 32px;
                font-size: 14px;
            }
            
            .send-btn {
                width: 36px;
                height: 36px;
            }
            
            .quick-main-btn {
                width: 44px;
                height: 44px;
                font-size: 20px;
            }
            
            .quick-sub-btn {
                width: 40px;
                height: 40px;
                font-size: 16px;
            }
            
            .todo-table th,
            .todo-table td {
                padding: 8px;
                font-size: 12px;
            }
            
            .todo-table {
                font-size: 12px;
            }
        }

        @media (min-width: 768px) {
            .message {
                max-width: 75%;
            }
            
            .side-menu {
                width: 70%;
                max-width: 400px;
            }
            
            .todo-table-container {
                max-width: 600px;
            }
        }

        /* ÂÆâÂÖ®Âå∫ÂüüÈÄÇÈÖçÔºàÂÖ®Èù¢Â±èÊâãÊú∫Ôºâ */
        @supports (padding-top: env(safe-area-inset-top)) {
            .top-bar {
                padding-top: env(safe-area-inset-top);
                height: calc(56px + env(safe-area-inset-top));
            }
            
            .chat-container {
                top: calc(56px + env(safe-area-inset-top));
            }
            
            .side-menu {
                padding-top: env(safe-area-inset-top);
            }
            
            .settings-menu {
                padding-bottom: env(safe-area-inset-bottom);
            }
            
            .quick-main-btn {
                bottom: calc(120px + env(safe-area-inset-bottom));
            }
            
            .quick-sub-buttons {
                bottom: calc(180px + env(safe-area-inset-bottom));
            }
            
            .input-container.keyboard-open ~ .quick-actions .quick-main-btn {
                bottom: calc(180px + env(safe-area-inset-bottom));
            }
            
            .input-container.keyboard-open ~ .quick-actions .quick-sub-buttons {
                bottom: calc(240px + env(safe-area-inset-bottom));
            }
        }
/* ÂØºÂá∫ÂØπËØùÊ°ÜÊ†∑Âºè */
.export-option {
    padding: 12px;
    border: 2px solid #eaeaea;
    border-radius: 8px;
    margin-bottom: 12px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.export-option:hover {
    border-color: #3498db;
    background-color: #f8f9fa;
}

.export-option input[type="radio"]:checked ~ label {
    color: #3498db;
}

.export-option input[type="radio"]:checked {
    accent-color: #3498db;
}

.progress-container {
    animation: fadeIn 0.3s ease;
}

/* ÂÇ®Â≠òÁ©∫Èó¥ÁÆ°ÁêÜÂØπËØùÊ°ÜÊ†∑Âºè */
.storage-dialog {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background-color: #ffffff;
    border-radius: 16px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
    z-index: 2000;
    padding: 24px;
    width: 90%;
    max-width: 500px;
    max-height: 80vh;
    display: none;
    overflow-y: auto;
}

.storage-dialog.show {
    display: block;
    animation: fadeIn 0.3s ease;
}

.storage-summary {
    background-color: #f8f9fa;
    border-radius: 12px;
    padding: 16px;
    margin: 16px 0;
    border: 1px solid #eaeaea;
}

.storage-item {
    display: flex;
    justify-content: space-between;
    margin-bottom: 8px;
    font-size: 14px;
}

.storage-item:last-child {
    margin-bottom: 0;
}

.storage-label {
    color: #7f8c8d;
}

.storage-value {
    color: #2c3e50;
    font-weight: 600;
}

.time-range-selector {
    margin: 20px 0;
    padding: 16px;
    background-color: #f8f9fa;
    border-radius: 12px;
}

.date-inputs {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin: 12px 0;
}

.date-input-group {
    display: flex;
    flex-direction: column;
    gap: 6px;
}

.date-input-group label {
    font-size: 14px;
    color: #2c3e50;
    font-weight: 500;
}

.date-input {
    padding: 10px;
    border: 2px solid #eaeaea;
    border-radius: 8px;
    font-size: 14px;
    transition: border-color 0.2s ease;
}

.date-input:focus {
    outline: none;
    border-color: #3498db;
}

.quick-buttons {
    display: flex;
    gap: 8px;
    margin-top: 12px;
    flex-wrap: wrap;
}

.time-range-btn {
    flex: 1;
    padding: 10px 16px;
    border: 2px solid #eaeaea;
    background-color: #ffffff;
    color: #2c3e50;
    border-radius: 8px;
    cursor: pointer;
    font-size: 13px;
    transition: all 0.2s ease;
    min-width: 80px;
}

.time-range-btn:hover {
    border-color: #3498db;
    background-color: #f8f9fa;
}

.time-range-btn.active {
    border-color: #3498db;
    background-color: #f0f7ff;
    color: #3498db;
    font-weight: 600;
}

.preview-section {
    margin: 20px 0;
    padding: 16px;
    background-color: #f8f9fa;
    border-radius: 12px;
    max-height: 200px;
    overflow-y: auto;
}

.preview-list {
    max-height: 150px;
    overflow-y: auto;
    margin: 12px 0;
}

.preview-item {
    padding: 8px;
    border-bottom: 1px solid #eaeaea;
    font-size: 13px;
    color: #2c3e50;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.preview-item:last-child {
    border-bottom: none;
}

.preview-date {
    color: #7f8c8d;
    font-size: 12px;
    min-width: 70px;
}

.preview-content {
    flex: 1;
    margin: 0 12px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.preview-label {
    font-size: 11px;
    padding: 2px 6px;
    border-radius: 4px;
    background-color: #ecf0f1;
    color: #2c3e50;
}

.preview-stats {
    text-align: center;
    font-size: 14px;
    color: #7f8c8d;
    margin-top: 12px;
    padding-top: 12px;
    border-top: 1px solid #eaeaea;
}

.storage-actions {
    display: flex;
    gap: 12px;
    margin-top: 20px;
}

.dialog-btn.delete {
    background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
    color: #ffffff;
}

.dialog-btn.delete:hover {
    background: linear-gradient(135deg, #c0392b 0%, #a93226 100%);
}

.dialog-btn.delete:disabled {
    background: #bdc3c7;
    cursor: not-allowed;
    transform: none;
}
.mic-btn {
    width: 44px;
    height: 44px;
    border: none;
    border-radius: 50%;
    background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
    color: #ffffff;
    cursor: not-allowed;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    margin-left: 8px;
    opacity: 0.7;
}
.mic-btn.active {
    background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
    cursor: pointer;
    opacity: 1;
}
.mic-btn.recording {
    background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
    animation: pulse 1s infinite;
}
@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); }
}
/* ËØ≠Èü≥Áä∂ÊÄÅÊù°Ê†∑Âºè */
.voice-status-bar {
    display: flex;
    align-items: center;
    padding: 8px 16px;
    background-color: #f0f7ff;
    border-bottom: 1px solid #eaeaea;
    animation: slideInDown 0.3s ease;
}
.voice-icon {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background-color: #e74c3c;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 12px;
}
.voice-timer {
    font-size: 16px;
    font-weight: 600;
    color: #2c3e50;
    margin-right: 12px;
    min-width: 60px;
}
.voice-wave {
    display: flex;
    align-items: center;
    gap: 4px;
    flex: 1;
}
.voice-wave span {
    display: inline-block;
    width: 4px;
    height: 20px;
    background-color: #3498db;
    border-radius: 2px;
    animation: wave 1s infinite ease-in-out;
}
.voice-wave span:nth-child(2) { animation-delay: 0.2s; }
.voice-wave span:nth-child(3) { animation-delay: 0.4s; }
.voice-wave span:nth-child(4) { animation-delay: 0.6s; }
.voice-wave span:nth-child(5) { animation-delay: 0.8s; }
@keyframes wave {
    0%, 100% { transform: scaleY(0.5); }
    50% { transform: scaleY(1.5); }
}
@keyframes slideInDown {
    from { transform: translateY(-100%); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}  

/* Ê†ºÂºè‰∏ªÊåâÈíÆÊ†∑Âºè */
.format-main-btn {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    border: none;
    background-color: #3498db;
    color: #ffffff;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    transition: all 0.2s ease;
    margin-right: 4px;
}

.format-main-btn:hover {
    background-color: #2980b9;
    transform: rotate(90deg);
}

/* Ê†ºÂºèÊåâÈíÆÂÆπÂô® - ÁªùÂØπÂÆö‰ΩçÔºåÂêë‰∏äÂ±ïÂºÄ */
.format-buttons {
    position: absolute;
    bottom: 60px;  /* ‰ªéÂ∑•ÂÖ∑Ê†èÂêë‰∏äÂºπÂá∫ */
    left: 16px;
    background-color: #ffffff;
    border-radius: 30px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    padding: 8px;
    display: flex;
    gap: 8px;
    z-index: 200;
    border: 1px solid #eaeaea;
    animation: slideInUp 0.2s ease;
}

/* Ê∑±Ëâ≤‰∏ªÈ¢òÈÄÇÈÖç */
body.dark-theme .format-buttons {
    background-color: #34495e;
    border-color: #2c3e50;
}

.format-buttons .format-btn {
    margin: 0;  /* ÈáçÁΩÆÂéüÊúâÈó¥Ë∑ù */
}     
    </style>
</head>
<body>
    <!-- È°∂ÈÉ®ÂØºËà™Ê†è -->
    <div class="top-bar">
        <button class="nav-btn" id="menuBtn" title="ÊâìÂºÄÊ†áÁ≠æÁÆ°ÁêÜ">
            <i class="fas fa-bars"></i>
        </button>
        <div class="nav-title" id="currentTabName">ËÅäÂ§©1</div>
        <button class="nav-btn" id="settingsBtn" title="ÊâìÂºÄËÆæÁΩÆ">
            <i class="fas fa-cog"></i>
        </button>
    </div>

    <!-- ËÅäÂ§©ÂÜÖÂÆπÂå∫Âüü -->
    <div class="chat-container" id="chatContainer">
        <!-- Ê∂àÊÅØ‰ºöÂä®ÊÄÅÊ∑ªÂä†Âú®ËøôÈáå -->
        <div class="empty-state" id="emptyState">
            <div class="empty-icon">üí¨</div>
            <div class="empty-title">ËÅäÂ§©ÂºèËÆ∞‰∫ãÊú¨</div>
            <div class="empty-text">Âú®ËøôÈáåËÆ∞ÂΩïÊÇ®ÁöÑÊÉ≥Ê≥ï„ÄÅÁÅµÊÑüÂíåÂæÖÂäû‰∫ãÈ°π</div>
            <div class="empty-text" style="margin-top: 16px;">ÁÇπÂáª‰∏ãÊñπÂºÄÂßãËæìÂÖ•...</div>
        </div>
    </div>

    <!-- ËæìÂÖ•Âå∫Âüü -->
    <div class="input-container" id="inputContainer">
        <div class="message-input-container">
        <!-- ËØ≠Èü≥Áä∂ÊÄÅÊù°ÔºàÈªòËÆ§ÈöêËóèÔºâ -->
<div class="voice-status-bar" id="voiceStatusBar" style="display: none;">
    <div class="voice-icon"><i class="fas fa-microphone"></i></div>
    <div class="voice-timer" id="voiceTimer">00:00</div>
    <div class="voice-wave">
        <span></span><span></span><span></span><span></span><span></span>
    </div>
</div>  
            <textarea 
                class="message-input" 
                id="messageInput" 
                placeholder="ËøôÈáåËæìÂÖ•..."
                rows="1"
            ></textarea>
        </div>
        <div class="input-toolbar">
            <div class="toolbar-left">
           <!-- Ê†ºÂºè‰∏ªÊåâÈíÆ -->
           <button class="format-main-btn" id="formatMainBtn" title="Ê†ºÂºè">
          <i class="fas fa-paint-brush"></i> <!-- Êàñ‰ΩøÁî® "A" ÊñáÂ≠ó --></button>
          <!-- Ê†ºÂºèÊåâÈíÆÂÆπÂô®ÔºàÂàùÂßãÈöêËóèÔºâ -->
          <div class="format-buttons" id="formatButtons" style="display: none;">
          <button class="format-btn" id="boldBtn" title="Âä†Á≤ó">B</button>
          <button class="format-btn" id="italicBtn" title="Êñú‰Ωì">I</button>
          <button class="format-btn" id="underlineBtn" title="‰∏ãÂàíÁ∫ø">U</button>
          <button class="format-btn" id="strikeBtn" title="Âà†Èô§Á∫ø">S</button>
          </div>
                <button class="tag-btn important" id="importantBtn" title="Ê†áËÆ∞ÈáçË¶Å">!</button>
                <button class="tag-btn todo" id="todoBtn" title="Ê†áËÆ∞ÂæÖÂäû">‚úì</button>
            </div>
<div class="toolbar-right">
    <button class="mic-btn" id="micBtn" title="ËØ≠Èü≥ËØÜÂà´ÔºàÈúÄË¶ÅÂÖà‰∏ãËΩΩÊ®°ÂûãÔºâ" disabled>
        <i class="fas fa-microphone"></i>
    </button>
    <button class="send-btn" id="sendBtn">
        <i class="fas fa-paper-plane"></i>
    </button>
</div>
        </div>
    </div>

    <!-- ÂúÜÂΩ¢Âä†Âè∑ÊåâÈíÆ -->
    <div class="quick-actions">
        <div class="quick-sub-buttons" id="quickSubButtons">
            <button class="quick-sub-btn todo" id="todoListBtn" title="ÂæÖÂäûÂàóË°®">
                <i class="fas fa-tasks"></i>
            </button>
            <button class="quick-sub-btn completed" id="completedListBtn" title="ÂÆåÊàêÂàóË°®">
                <i class="fas fa-check-double"></i>
            </button>
            <button class="quick-sub-btn important" id="importantListBtn" title="ÈáçË¶ÅÂàóË°®">
                <i class="fas fa-star"></i>
            </button>
        </div>
        <button class="quick-main-btn" id="quickMainBtn" title="Âø´ÈÄüÊìç‰Ωú">
            <i class="fas fa-plus"></i>
        </button>
    </div>

    <!-- Ê∞îÊ≥°ËèúÂçï -->
    <div class="bubble-menu" id="bubbleMenu">
        <!-- Ê≥®ÊÑèÔºöÂä©ÊâãÊ∂àÊÅØÁöÑÂèåÂáªËèúÂçï‰ºöÂä®ÊÄÅ‰øÆÊîπÔºåÂè™ÊòæÁ§∫Âà†Èô§ÊåâÈíÆ -->
    </div>

    <!-- ‰æßÊªëËèúÂçï - Ê†áÁ≠æÁÆ°ÁêÜ -->
    <div class="side-menu" id="sideMenu">
        <div class="menu-header">
            <div class="menu-title">
                <i class="fas fa-comments"></i> ËÅäÂ§©Ê†áÁ≠æ
            </div>
        </div>
        <div class="tabs-list" id="tabsList">
            <!-- Ê†áÁ≠æ‰ºöÂä®ÊÄÅÊ∑ªÂä†Âú®ËøôÈáå -->
        </div>
        <div class="menu-actions">
            <button class="new-tab-btn" id="newTabBtn">
                <i class="fas fa-plus"></i> Êñ∞Âª∫ËÅäÂ§©
            </button>
        </div>
    </div>
    <div class="menu-overlay" id="menuOverlay"></div>

    <!-- ËÆæÁΩÆËèúÂçï - Â∫ïÈÉ®ÂºπÂá∫ -->
    <div class="settings-menu" id="settingsMenu">
        <div class="settings-header">
            <div class="settings-title">ËÆæÁΩÆ</div>
            <button class="close-settings" id="closeSettingsBtn">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="settings-options">
            <div class="settings-option" id="usernameOption">
                <span class="option-text">‰øÆÊîπÁî®Êà∑Âêç</span>
                <i class="fas fa-chevron-right option-icon"></i>
            </div>
            <div class="settings-option" id="assistantOption">
                <span class="option-text">‰øÆÊîπÂä©ÊâãÂêçÁß∞</span>
                <i class="fas fa-chevron-right option-icon"></i>
            </div>
            <div class="settings-option" id="replyContentOption">
                <span class="option-text">Ëá™Âä®ÂõûÂ§çÊ¶ÇÁéáÂèäÂÜÖÂÆπ</span>
                <i class="fas fa-chevron-right option-icon"></i>
            </div>
            <div class="settings-option" id="sendKeyOption">
                <span class="option-text">ÂèëÈÄÅÈîÆËÆæÁΩÆ</span>
                <span class="option-value" id="sendKeyValue">EnterÂèëÈÄÅ</span>
                <i class="fas fa-chevron-right option-icon"></i>
            </div>
            <div class="settings-option" id="fontSizeOption">
                <span class="option-text">Ê∞îÊ≥°Â≠ó‰ΩìÂ§ßÂ∞è</span>
                <span class="option-value" id="fontSizeValue">16px</span>
                <i class="fas fa-chevron-right option-icon"></i>
            </div>
            <div class="settings-option" id="voiceModelOption">
                <span class="option-text">ËØ≠Èü≥Ê®°ÂûãÁÆ°ÁêÜ</span>
                <span class="option-value" id="modelStatusValue">Êú™‰∏ãËΩΩ</span>
                <i class="fas fa-chevron-right option-icon"></i>
            </div>    
            <div class="settings-option" id="clearCacheOption">
                <span class="option-text">Ê∏ÖÈô§ÊâÄÊúâÁî®Êà∑ËÆæÂÆöÂíåÁºìÂ≠ò</span>
                <i class="fas fa-chevron-right option-icon"></i>
            </div>
            <div class="settings-option" id="searchOption">
            <span class="option-text">ÊêúÁ¥¢ËÅäÂ§©ËÆ∞ÂΩï</span>
            <i class="fas fa-chevron-right option-icon"></i>
            </div>
            <div class="settings-option" id="exportOption">
                <span class="option-text">ÂØºÂá∫ËÅäÂ§©ËÆ∞ÂΩï</span>
                <span style="color:#95a5a6; font-size:14px;">‰ªÖExcelÊ†ºÂºèÔºåÂÖ∂‰ªñÊ≠£Âú®ÂºÄÂèë‰∏≠</span>
                <i class="fas fa-chevron-right option-icon"></i>
            </div>
            <div class="settings-option" id="storageOption">
            <span class="option-text">ÂÇ®Â≠òÁ©∫Èó¥ÁÆ°ÁêÜ</span>
            <span class="option-value" id="storageUsage">Ê£ÄÊü•‰∏≠...</span>
            <i class="fas fa-chevron-right option-icon"></i>
            </div>
            <div class="settings-option" id="themeOption">
                <span class="option-text">È¢úËâ≤‰∏ªÈ¢ò</span>
                <i class="fas fa-chevron-right option-icon"></i>
            </div>
            <div class="settings-option" id="aboutOption">
                <span class="option-text">ÂÖ≥‰∫é</span>
                <i class="fas fa-chevron-right option-icon"></i>
            </div>
        </div>
    </div>

    <!-- Áî®Êà∑Âêç‰øÆÊîπÂºπÁ™ó -->
    <div class="username-dialog" id="usernameDialog">
        <div class="dialog-header">
            <div class="dialog-title">‰øÆÊîπÁî®Êà∑Âêç</div>
            <div class="dialog-text">ËÆæÁΩÆÊÇ®ÊÉ≥Ë¶ÅÊòæÁ§∫ÁöÑÁî®Êà∑Âêç</div>
        </div>
        <input type="text" class="username-input" id="usernameInput" placeholder="ËØ∑ËæìÂÖ•Áî®Êà∑Âêç" maxlength="20">
        <div class="dialog-actions">
            <button class="dialog-btn cancel" id="cancelUsernameBtn">ÂèñÊ∂à</button>
            <button class="dialog-btn save" id="saveUsernameBtn">‰øùÂ≠ò</button>
        </div>
    </div>

    <!-- Á°ÆËÆ§ÂØπËØùÊ°Ü -->
    <div class="confirm-dialog" id="confirmDialog">
        <div class="dialog-header">
            <div class="dialog-title" id="confirmTitle">Á°ÆËÆ§Êìç‰Ωú</div>
        </div>
        <div class="confirm-message" id="confirmMessage"></div>
        <div class="dialog-actions">
            <button class="dialog-btn cancel" id="cancelConfirmBtn">ÂèñÊ∂à</button>
            <button class="dialog-btn save" id="confirmBtn">Á°ÆËÆ§</button>
        </div>
    </div>

    <!-- ÈáçÂëΩÂêçÂØπËØùÊ°Ü -->
    <div class="rename-dialog" id="renameDialog">
        <div class="dialog-header">
            <div class="dialog-title">ÈáçÂëΩÂêçÊ†áÁ≠æ</div>
            <div class="dialog-text">ËØ∑ËæìÂÖ•Êñ∞ÁöÑÊ†áÁ≠æÂêçÁß∞</div>
        </div>
        <input type="text" class="rename-input" id="renameInput" placeholder="ËØ∑ËæìÂÖ•Ê†áÁ≠æÂêçÁß∞" maxlength="20">
        <div class="dialog-actions">
            <button class="dialog-btn cancel" id="cancelRenameBtn">ÂèñÊ∂à</button>
            <button class="dialog-btn save" id="saveRenameBtn">‰øùÂ≠ò</button>
        </div>
    </div>

    <!-- Âä©ÊâãÂêçÁß∞ÂØπËØùÊ°Ü -->
    <div class="assistant-dialog" id="assistantDialog">
        <div class="dialog-header">
            <div class="dialog-title">‰øÆÊîπÂä©ÊâãÂêçÁß∞</div>
            <div class="dialog-text">ËÆæÁΩÆËá™Âä®ÂõûÂ§çÂä©ÊâãÁöÑÊòæÁ§∫ÂêçÁß∞</div>
        </div>
        <input type="text" class="assistant-input" id="assistantInput" placeholder="ËØ∑ËæìÂÖ•Âä©ÊâãÂêçÁß∞" maxlength="20">
        <div class="dialog-actions">
            <button class="dialog-btn cancel" id="cancelAssistantBtn">ÂèñÊ∂à</button>
            <button class="dialog-btn save" id="saveAssistantBtn">‰øùÂ≠ò</button>
        </div>
    </div>

<!-- ÂÇ®Â≠òÁ©∫Èó¥ÁÆ°ÁêÜÂØπËØùÊ°Ü -->
<div class="storage-dialog" id="storageDialog">
    <div class="dialog-header">
        <div class="dialog-title">ÂÇ®Â≠òÁ©∫Èó¥ÁÆ°ÁêÜ</div>
        <div class="dialog-text">ÁÆ°ÁêÜÊÇ®ÁöÑËÅäÂ§©ËÆ∞ÂΩïÂÇ®Â≠òÁ©∫Èó¥</div>
    </div>
    
    <!-- ÂÇ®Â≠ò‰ΩøÁî®ÊÉÖÂÜµÁªüËÆ° -->
    <div class="storage-summary" id="storageSummary">
        <div class="storage-item">
            <span class="storage-label">ÊÄªÊ∂àÊÅØÊï∞Ôºö</span>
            <span class="storage-value" id="totalMessages">0</span>
        </div>
        <div class="storage-item">
            <span class="storage-label">Ê†áÁ≠æÊï∞ÈáèÔºö</span>
            <span class="storage-value" id="totalTabs">0</span>
        </div>
        <div class="storage-item">
            <span class="storage-label">ÊÄªÂÇ®Â≠òÈáèÔºö</span>
            <span class="storage-value" id="totalStorage">0 KB</span>
        </div>
    </div>
    
    <!-- Êó∂Èó¥ÈÄâÊã©Âô® -->
    <div class="time-range-selector">
        <div class="dialog-text">ÈÄâÊã©Âà†Èô§ÁöÑÊó∂Èó¥ËåÉÂõ¥Ôºö</div>
        <div class="date-inputs">
            <div class="date-input-group">
                <label for="startDate">ÂºÄÂßãÊó•ÊúüÔºö</label>
                <input type="date" class="date-input" id="startDate">
            </div>
            <div class="date-input-group">
                <label for="endDate">ÁªìÊùüÊó•ÊúüÔºö</label>
                <input type="date" class="date-input" id="endDate">
            </div>
        </div>
        <div class="quick-buttons">
            <button class="time-range-btn" data-range="7d">ÊúÄËøë7Â§©</button>
            <button class="time-range-btn" data-range="30d">ÊúÄËøë30Â§©</button>
            <button class="time-range-btn" data-range="all">ÂÖ®ÈÉ®Êó∂Èó¥</button>
        </div>
    </div>
    
    <!-- È¢ÑËßàÂå∫Âüü -->
    <div class="preview-section">
        <div class="dialog-text">Â∞ÜÂà†Èô§ÁöÑÊ∂àÊÅØÔºö</div>
        <div class="preview-list" id="previewList">
            <!-- È¢ÑËßàÂÜÖÂÆπÂ∞ÜÂä®ÊÄÅÊòæÁ§∫Âú®ËøôÈáå -->
        </div>
        <div class="preview-stats" id="previewStats">
            Êó†ÈÄâ‰∏≠Ê∂àÊÅØ
        </div>
    </div>
    
    <!-- Êìç‰ΩúÊåâÈíÆ -->
    <div class="storage-actions">
        <button class="dialog-btn cancel" id="cancelStorageBtn">ÂèñÊ∂à</button>
        <button class="dialog-btn delete" id="deleteSelectedBtn" disabled>Âà†Èô§ÈÄâ‰∏≠</button>
    </div>
</div>

    <!-- ÂèëÈÄÅÊñπÂºèËÆæÁΩÆÂØπËØùÊ°Ü -->
    <div class="send-key-dialog" id="sendKeyDialog">
        <div class="dialog-header">
            <div class="dialog-title">ÂèëÈÄÅÈîÆËÆæÁΩÆ</div>
            <div class="dialog-text">ÈÄâÊã©ÊåâEnterÈîÆÊó∂ÁöÑË°å‰∏∫</div>
        </div>
        <div class="dialog-options">
            <div class="send-key-option" data-value="enter">
                <div class="option-radio"></div>
                <div class="option-text-full">
                    <div class="option-title">EnterÂèëÈÄÅÊ∂àÊÅØ</div>
                    <div class="option-desc">ÊåâEnterÈîÆÁõ¥Êé•ÂèëÈÄÅÊ∂àÊÅØÔºåShift+EnterÊç¢Ë°å</div>
                </div>
            </div>
            <div class="send-key-option" data-value="shift-enter">
                <div class="option-radio"></div>
                <div class="option-text-full">
                    <div class="option-title">EnterÊç¢Ë°å</div>
                    <div class="option-desc">ÊåâEnterÈîÆÊç¢Ë°åÔºåShift+EnterÂèëÈÄÅÊ∂àÊÅØ</div>
                </div>
            </div>
        </div>
        <div class="dialog-actions">
            <button class="dialog-btn cancel" id="cancelSendKeyBtn">ÂèñÊ∂à</button>
            <button class="dialog-btn save" id="saveSendKeyBtn">‰øùÂ≠ò</button>
        </div>
    </div>

    <!-- Â≠ó‰ΩìÂ§ßÂ∞èËÆæÁΩÆÂØπËØùÊ°Ü -->
    <div class="font-size-dialog" id="fontSizeDialog">
        <div class="dialog-header">
            <div class="dialog-title">Ê∞îÊ≥°Â≠ó‰ΩìÂ§ßÂ∞è</div>
            <div class="dialog-text">Ë∞ÉÊï¥ÂØπËØùÊ∞îÊ≥°‰∏≠ÁöÑÂ≠ó‰ΩìÂ§ßÂ∞è</div>
        </div>
        
        <div class="font-size-value" id="fontSizeDisplay">16px</div>
        <input type="range" class="font-size-slider" id="fontSizeSlider" min="12" max="24" step="1" value="16">
        
        <div class="dialog-actions" style="margin-top: 24px;">
            <button class="dialog-btn cancel" id="cancelFontSizeBtn">ÂèñÊ∂à</button>
            <button class="dialog-btn save" id="saveFontSizeBtn">‰øùÂ≠ò</button>
        </div>
    </div>

    <!-- Ëá™Âä®ÂõûÂ§çÂÜÖÂÆπÁÆ°ÁêÜÂØπËØùÊ°Ü -->
    <div class="reply-content-dialog" id="replyContentDialog">
        <div class="dialog-header">
            <div class="dialog-title">Ëá™Âä®ÂõûÂ§çËÆæÁΩÆ</div>
            <div class="dialog-text">ËÆæÁΩÆËá™Âä®ÂõûÂ§çÊ¶ÇÁéáÂíåÁÆ°ÁêÜÂõûÂ§çÂÜÖÂÆπ</div>
        </div>
        
        <div class="probability-value" id="probabilityDisplay">Ê¶ÇÁéá: 70%</div>
        <input type="range" class="probability-slider" id="probabilitySlider" min="0" max="100" step="10" value="70">
        
        <div style="margin-top: 24px;">
            <div class="dialog-text">Ëá™Âä®ÂõûÂ§çÂÜÖÂÆπÂàóË°®Ôºö</div>
            <div class="reply-list" id="replyList">
                <!-- ÂõûÂ§çÂÜÖÂÆπ‰ºöÂä®ÊÄÅÊ∑ªÂä†Âú®ËøôÈáå -->
            </div>
        </div>
        
        <div class="add-reply-container">
            <input type="text" class="add-reply-input" id="addReplyInput" placeholder="ËæìÂÖ•Êñ∞ÁöÑÂõûÂ§çÂÜÖÂÆπ" maxlength="100">
            <button class="add-reply-btn" id="addReplyBtn">
                <i class="fas fa-plus"></i>
            </button>
        </div>
        
        <div class="dialog-actions" style="margin-top: 24px;">
            <button class="dialog-btn cancel" id="cancelReplyContentBtn">ÂèñÊ∂à</button>
            <button class="dialog-btn save" id="saveReplyContentBtn">‰øùÂ≠ò</button>
        </div>
    </div>
<!-- ËØ≠Èü≥Ê®°ÂûãÁÆ°ÁêÜÂØπËØùÊ°Ü -->
<div class="confirm-dialog" id="voiceModelDialog">
    <div class="dialog-header">
        <div class="dialog-title">ËØ≠Èü≥Ê®°ÂûãÁÆ°ÁêÜ</div>
        <div class="dialog-text" id="modelDetailText"></div>
    </div>
    <div style="padding: 20px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
            <span style="font-size: 16px; color: #2c3e50;">Ê®°ÂûãÔºöWhisperÔºà‰∏≠ÊñáÔºâ</span>
            <span id="modelSizeLabel" style="font-size: 14px; color: #7f8c8d;">Á∫¶142MB</span>
        </div>
        <div id="modelProgressContainer" style="display: none; margin: 16px 0;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                <span>‰∏ãËΩΩËøõÂ∫¶</span>
                <span id="modelProgressPercent">0.0 MB / 142.0 MB</span>
            </div>
            <div style="width: 100%; height: 8px; background-color: #ecf0f1; border-radius: 4px;">
                <div id="modelProgressBar" style="width: 0%; height: 100%; background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%); border-radius: 4px;"></div>
            </div>
        </div>
        <div id="modelButtons">
            <button class="dialog-btn save" id="downloadModelBtn" style="width: 100%;">‰∏ãËΩΩÊ®°Âûã</button>
            <button class="dialog-btn cancel" id="deleteModelBtn" style="width: 100%; margin-top: 12px; display: none;">Âà†Èô§Ê®°Âûã</button>
        </div>
    </div>
    <div class="dialog-actions" style="padding: 0 24px 24px;">
        <button class="dialog-btn cancel" id="closeModelDialogBtn">ÂÖ≥Èó≠</button>
    </div>
</div>
    <script>
        // Áä∂ÊÄÅÁÆ°ÁêÜ
        const state = {
            messages: [],
            username: 'Êàë',
            assistantName: 'Âä©Êâã',
            tabs: [
                { id: 1, name: 'ËÅäÂ§©1', messages: [], active: true, pinned: false },
                { id: 2, name: 'ËÅäÂ§©2', messages: [], active: false, pinned: false },
                { id: 3, name: 'ËÅäÂ§©3', messages: [], active: false, pinned: false }
            ],
            currentTabId: 1,
            autoReplyProbability: 70,
            autoReplies: [
                "Êî∂Âà∞ÔºÅÂ∑≤ËÆ∞ÂΩï„ÄÇ",
                "ÊòéÁôΩÔºåÁªßÁª≠ËØ¥Âêß„ÄÇ",
                "Â•ΩÁöÑÔºåÊàëÂú®Âê¨„ÄÇ",
                "ÂóØÔºåÊúâÈÅìÁêÜ„ÄÇ",
                "ÊòØÁöÑÔºåÊàëÂêåÊÑè„ÄÇ",
                "‰∫ÜËß£‰∫ÜÔºåË∞¢Ë∞¢ÂàÜ‰∫´„ÄÇ",
                "Ëøô‰∏™ÊÉ≥Ê≥ï‰∏çÈîôÔºÅ",
                "ÁªßÁª≠ÔºåÊàëÂú®ËÆ§ÁúüËÆ∞ÂΩï„ÄÇ",
                "Â•ΩÁöÑÔºåËøòÊúâ‰ªÄ‰πàË¶ÅË°•ÂÖÖÁöÑÂêóÔºü",
                "Â∑≤Êî∂Âà∞ÔºåËØ∑ÁªßÁª≠„ÄÇ"
            ],
            completedTodos: {},
            assistantTodoMap: {},
            assistantTodoStates: {},
            assistantTodoTableMessages: {}, // ËÆ∞ÂΩïÂä©ÊâãÁîüÊàêÁöÑÂæÖÂäûË°®Ê†ºÊ∂àÊÅØID
            settings: {
                sendKey: 'enter', // ÈªòËÆ§EnterÂèëÈÄÅ
                theme: 'light',
                fontSize: 16 // ÈªòËÆ§Â≠ó‰ΩìÂ§ßÂ∞è
            },
            selectedMessage: null,
            lastTapTime: 0,
            tapTimeout: null,
            quickMenuOpen: false,
            voice: {} 
        };
        window.state = state;

        // DOMÂÖÉÁ¥†ÂºïÁî®
        const chatContainer = document.getElementById('chatContainer');
        const emptyState = document.getElementById('emptyState');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const currentTabName = document.getElementById('currentTabName');
        const sideMenu = document.getElementById('sideMenu');
        const menuOverlay = document.getElementById('menuOverlay');
        const menuBtn = document.getElementById('menuBtn');
        const settingsMenu = document.getElementById('settingsMenu');
        const settingsBtn = document.getElementById('settingsBtn');
        const closeSettingsBtn = document.getElementById('closeSettingsBtn');
        const tabsList = document.getElementById('tabsList');
        const newTabBtn = document.getElementById('newTabBtn');
        const inputContainer = document.getElementById('inputContainer');
        
        // Ê†ºÂºèÊåâÈíÆ
        const boldBtn = document.getElementById('boldBtn');
        const italicBtn = document.getElementById('italicBtn');
        const underlineBtn = document.getElementById('underlineBtn');
        const strikeBtn = document.getElementById('strikeBtn');
        const importantBtn = document.getElementById('importantBtn');
        const todoBtn = document.getElementById('todoBtn');
        
        // Âø´ÈÄüÊåâÈíÆ
        const quickMainBtn = document.getElementById('quickMainBtn');
        const quickSubButtons = document.getElementById('quickSubButtons');
        const todoListBtn = document.getElementById('todoListBtn');
        const completedListBtn = document.getElementById('completedListBtn');
        const importantListBtn = document.getElementById('importantListBtn');
        
        // Ê∞îÊ≥°ËèúÂçï
        const bubbleMenu = document.getElementById('bubbleMenu');
        
        // ÂØπËØùÊ°Ü
        const usernameDialog = document.getElementById('usernameDialog');
        const usernameInput = document.getElementById('usernameInput');
        const saveUsernameBtn = document.getElementById('saveUsernameBtn');
        const cancelUsernameBtn = document.getElementById('cancelUsernameBtn');
        
        const confirmDialog = document.getElementById('confirmDialog');
        const confirmTitle = document.getElementById('confirmTitle');
        const confirmMessage = document.getElementById('confirmMessage');
        const confirmBtn = document.getElementById('confirmBtn');
        const cancelConfirmBtn = document.getElementById('cancelConfirmBtn');
        
        const renameDialog = document.getElementById('renameDialog');
        const renameInput = document.getElementById('renameInput');
        const saveRenameBtn = document.getElementById('saveRenameBtn');
        const cancelRenameBtn = document.getElementById('cancelRenameBtn');
        
        const assistantDialog = document.getElementById('assistantDialog');
        const assistantInput = document.getElementById('assistantInput');
        const saveAssistantBtn = document.getElementById('saveAssistantBtn');
        const cancelAssistantBtn = document.getElementById('cancelAssistantBtn');
        
        const replyContentDialog = document.getElementById('replyContentDialog');
        const probabilitySlider = document.getElementById('probabilitySlider');
        const probabilityDisplay = document.getElementById('probabilityDisplay');
        const replyList = document.getElementById('replyList');
        const addReplyInput = document.getElementById('addReplyInput');
        const addReplyBtn = document.getElementById('addReplyBtn');
        const saveReplyContentBtn = document.getElementById('saveReplyContentBtn');
        const cancelReplyContentBtn = document.getElementById('cancelReplyContentBtn');
        const replyContentOption = document.getElementById('replyContentOption');
        const clearCacheOption = document.getElementById('clearCacheOption');
        
        // Â≠ó‰ΩìÂ§ßÂ∞èËÆæÁΩÆ
        const fontSizeOption = document.getElementById('fontSizeOption');
        const fontSizeValue = document.getElementById('fontSizeValue');
        const fontSizeDialog = document.getElementById('fontSizeDialog');
        const fontSizeSlider = document.getElementById('fontSizeSlider');
        const fontSizeDisplay = document.getElementById('fontSizeDisplay');
        const saveFontSizeBtn = document.getElementById('saveFontSizeBtn');
        const cancelFontSizeBtn = document.getElementById('cancelFontSizeBtn');
        
        // ÂèëÈÄÅÊñπÂºèËÆæÁΩÆ
        const sendKeyOption = document.getElementById('sendKeyOption');
        const sendKeyValue = document.getElementById('sendKeyValue');
        const sendKeyDialog = document.getElementById('sendKeyDialog');
        const cancelSendKeyBtn = document.getElementById('cancelSendKeyBtn');
        const saveSendKeyBtn = document.getElementById('saveSendKeyBtn');

        // ÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', () => {
            loadFromLocalStorage();
            updateCurrentTab();
            renderMessages();
            updateTabsList();

    if ('serviceWorker' in navigator) {
        // Á´ãÂç≥Ê≥®ÂÜåService WorkerÔºå‰∏çÁ≠âÂæÖload‰∫ã‰ª∂
        navigator.serviceWorker.register('sw.js').then(registration => {
            console.log('ServiceWorkerÊ≥®ÂÜåÊàêÂäü:', registration.scope);
            
            // ÊòæÁ§∫ÂÆâË£ÖÊèêÁ§∫
            showInstallPrompt();
        }).catch(err => {
            console.log('ServiceWorkerÊ≥®ÂÜåÂ§±Ë¥•:', err);
        });
    }
   
            setupEventListeners();
         
            const currentTab = state.tabs.find(t => t.id === state.currentTabId);
            if (currentTab) {
                currentTabName.textContent = currentTab.name;
            }
            
            // Êõ¥Êñ∞ÂèëÈÄÅÊñπÂºèÊòæÁ§∫
            updateSendKeyDisplay();
            
            // Êõ¥Êñ∞Â≠ó‰ΩìÂ§ßÂ∞èÊòæÁ§∫
            updateFontSizeDisplay();
            
            updateProbabilityDisplay();
            updateReplyList();
            // Êõ¥Êñ∞ÂÇ®Â≠ò‰ΩøÁî®ÊÉÖÂÜµÊòæÁ§∫
           updateStorageStats();

           // ËÆæÁΩÆÂÇ®Â≠ò‰ΩøÁî®ÊÉÖÂÜµÂàùÂßãÊòæÁ§∫
           document.getElementById('storageUsage').textContent = 'Ê£ÄÊü•‰∏≠...';
           setTimeout(() => {
               updateStorageStats();
           }, 500);

           // Â§ÑÁêÜÂø´Êç∑ÊñπÂºèÂèÇÊï∞
           handleShortcutActions();  
           });

function showInstallPrompt() {
    let deferredPrompt;
    
    window.addEventListener('beforeinstallprompt', (e) => {
        // ÈòªÊ≠¢Ëá™Âä®ÊòæÁ§∫ÂÆâË£ÖÊèêÁ§∫
        e.preventDefault();
        deferredPrompt = e;
        
        // Ê£ÄÊü•ÊòØÂê¶Â∑≤ÁªèÂÆâË£Ö
        if (window.matchMedia('(display-mode: standalone)').matches) {
            // Â¶ÇÊûúÂ∑≤ÁªèÂÆâË£ÖÔºåÁßªÈô§ÊåâÈíÆÔºàÂ¶ÇÊûúÂ≠òÂú®Ôºâ
            const existingBtn = document.getElementById('installBtn');
            if (existingBtn) {
                existingBtn.remove();
            }
            return;
        }
        
        // Ê£ÄÊü•ÊòØÂê¶Â∑≤Â≠òÂú®ÂÆâË£ÖÊåâÈíÆ
        let installBtn = document.getElementById('installBtn');
        
        if (!installBtn) {
            // ÂàõÂª∫ÂÆâË£ÖÊåâÈíÆ
            installBtn = document.createElement('button');
            installBtn.innerHTML = '<i class="fas fa-download"></i>';
            installBtn.className = 'nav-btn';
            installBtn.title = 'ÂÆâË£ÖÂ∫îÁî®';
            installBtn.style.marginLeft = '8px';
            installBtn.id = 'installBtn';
            
            // Ê∑ªÂä†Âà∞ËÆæÁΩÆÊåâÈíÆÂâçÈù¢
            const settingsBtn = document.getElementById('settingsBtn');
            if (settingsBtn) {
                settingsBtn.parentNode.insertBefore(installBtn, settingsBtn);
            }
            
            // Ê∑ªÂä†ÁÇπÂáª‰∫ã‰ª∂ÁõëÂê¨Âô®ÔºàÂè™Ê∑ªÂä†‰∏ÄÊ¨°Ôºâ
            installBtn.addEventListener('click', async () => {
                if (!deferredPrompt) return;
                
                try {
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    
                    if (outcome === 'accepted') {
                        console.log('Áî®Êà∑Êé•Âèó‰∫ÜÂÆâË£ÖÊèêÁ§∫');
                        // ÂÆâË£ÖÊàêÂäüÂêéÁßªÈô§ÊåâÈíÆ
                        if (installBtn) {
                            installBtn.style.display = 'none';
                            installBtn.remove();
                        }
                    } else {
                        console.log('Áî®Êà∑ÂèñÊ∂à‰∫ÜÂÆâË£Ö');
                        // Áî®Êà∑ÂèñÊ∂àÂÆâË£ÖÔºå‰øùÁïôÊåâÈíÆ‰ΩÜ‰∏çÁßªÈô§ÔºåÂÖÅËÆ∏ÂÜçÊ¨°Â∞ùËØï
                        // ÈáçÁΩÆ deferredPrompt ‰ª•‰æø‰∏ãÊ¨°‰ΩøÁî®
                        deferredPrompt = null;
                    }
                } catch (error) {
                    console.error('ÂÆâË£ÖËøáÁ®ã‰∏≠Âá∫Èîô:', error);
                    deferredPrompt = null;
                }
            });
        } else {
            // Â¶ÇÊûúÊåâÈíÆÂ∑≤Â≠òÂú®ÔºåÁ°Æ‰øùÂÆÉÊòØÂèØËßÅÁöÑ
            installBtn.style.display = 'flex';
        }
    });
    
    // Ê∑ªÂä†‰∏Ä‰∏™Ê£ÄÊµãÂÆâË£ÖÁä∂ÊÄÅÁöÑÂèòÂåñÁõëÂê¨Âô®
    window.addEventListener('appinstalled', () => {
        console.log('Â∫îÁî®Â∑≤ÂÆâË£Ö');
        // ÁßªÈô§ÂÆâË£ÖÊåâÈíÆ
        const installBtn = document.getElementById('installBtn');
        if (installBtn) {
            installBtn.remove();
        }
    });
}

        // ËÆæÁΩÆ‰∫ã‰ª∂ÁõëÂê¨Âô®
        function setupEventListeners() {
            // ÂèëÈÄÅÊåâÈíÆ
            sendBtn.addEventListener('click', sendMessage);
            
            // ËæìÂÖ•Ê°ÜËæìÂÖ•ÁõëÂê¨
            messageInput.addEventListener('input', handleInputChange);
            messageInput.addEventListener('focus', handleInputFocus);
            messageInput.addEventListener('blur', handleInputBlur);
            
            // ËæìÂÖ•Ê°ÜÊåâÈîÆÁõëÂê¨
            messageInput.addEventListener('keydown', handleKeyDown);
            
            // ËæìÂÖ•Ê≥ïÂ§ÑÁêÜ
            messageInput.addEventListener('compositionstart', () => {
                window.isComposing = true;
            });
            
            messageInput.addEventListener('compositionend', () => {
                window.isComposing = false;
            });
            
            // ËèúÂçïÊåâÈíÆ
            menuBtn.addEventListener('click', openSideMenu);
            menuOverlay.addEventListener('click', (e) => {
                e.stopPropagation();
                closeAllMenusAndDialogs();
            });
            
            // ËÆæÁΩÆÊåâÈíÆ
            settingsBtn.addEventListener('click', openSettingsMenu);
            closeSettingsBtn.addEventListener('click', closeSettingsMenu);
            
            // Êñ∞Âª∫Ê†áÁ≠æÊåâÈíÆ
            newTabBtn.addEventListener('click', createNewTab);
            
            // Ê†ºÂºèÊåâÈíÆ
            boldBtn.addEventListener('click', () => insertFormatting('[b]', '[/b]'));
            italicBtn.addEventListener('click', () => insertFormatting('[i]', '[/i]'));
            underlineBtn.addEventListener('click', () => insertFormatting('[u]', '[/u]'));
            strikeBtn.addEventListener('click', () => insertFormatting('[s]', '[/s]'));
            
            // Ê†áÁ≠æÊåâÈíÆ
            importantBtn.addEventListener('click', () => insertText('[ÈáçË¶Å] '));
            todoBtn.addEventListener('click', () => insertText('[ÂæÖÂäû] '));
            
            // Âø´ÈÄüÊåâÈíÆ
            quickMainBtn.addEventListener('click', toggleQuickMenu);
            todoListBtn.addEventListener('click', () => sendQueryToAssistant('todo'));
            completedListBtn.addEventListener('click', () => sendQueryToAssistant('completed'));
            importantListBtn.addEventListener('click', () => sendQueryToAssistant('important'));
            
            // Áî®Êà∑Âêç‰øÆÊîπ
            document.getElementById('usernameOption').addEventListener('click', () => {
                closeSettingsMenu();
                openUsernameDialog();
            });
            
            saveUsernameBtn.addEventListener('click', saveUsername);
            cancelUsernameBtn.addEventListener('click', closeUsernameDialog);
            
            // Âä©ÊâãÂêçÁß∞‰øÆÊîπ
            document.getElementById('assistantOption').addEventListener('click', () => {
                closeSettingsMenu();
                openAssistantDialog();
            });
            
            saveAssistantBtn.addEventListener('click', saveAssistantName);
            cancelAssistantBtn.addEventListener('click', closeAssistantDialog);
            
            // Â≠ó‰ΩìÂ§ßÂ∞èËÆæÁΩÆ
            fontSizeOption.addEventListener('click', () => {
                closeSettingsMenu();
                openFontSizeDialog();
            });
            
            fontSizeSlider.addEventListener('input', () => {
                fontSizeDisplay.textContent = fontSizeSlider.value + 'px';
            });
            
            saveFontSizeBtn.addEventListener('click', saveFontSizeSetting);
            cancelFontSizeBtn.addEventListener('click', closeFontSizeDialog);
            
            // Ëá™Âä®ÂõûÂ§çÂÜÖÂÆπÁÆ°ÁêÜ
            replyContentOption.addEventListener('click', () => {
                closeSettingsMenu();
                openReplyContentDialog();
            });
            
            probabilitySlider.addEventListener('input', () => {
                probabilityDisplay.textContent = `Ê¶ÇÁéá: ${probabilitySlider.value}%`;
            });
            
            addReplyBtn.addEventListener('click', addNewReply);
            addReplyInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    addNewReply();
                }
            });
            
            saveReplyContentBtn.addEventListener('click', saveReplyContentSettings);
            cancelReplyContentBtn.addEventListener('click', closeReplyContentDialog);
            
            // ÂèëÈÄÅÊñπÂºèËÆæÁΩÆ
            sendKeyOption.addEventListener('click', () => {
                closeSettingsMenu();
                openSendKeyDialog();
            });
            
            saveSendKeyBtn.addEventListener('click', saveSendKeySetting);
            cancelSendKeyBtn.addEventListener('click', closeSendKeyDialog);
            
            // Ê∏ÖÈô§ÊâÄÊúâÁî®Êà∑ËÆæÂÆöÂíåÁºìÂ≠ò
            clearCacheOption.addEventListener('click', () => {
                closeSettingsMenu();
                showClearCacheConfirm();
            });
            
            // Á°ÆËÆ§ÂØπËØùÊ°ÜÊåâÈíÆ
            confirmBtn.addEventListener('click', handleConfirmAction);
            cancelConfirmBtn.addEventListener('click', closeConfirmDialog);
            
            // ÈáçÂëΩÂêçÂØπËØùÊ°ÜÊåâÈíÆ
            saveRenameBtn.addEventListener('click', saveRename);
            cancelRenameBtn.addEventListener('click', closeRenameDialog);
            
            // ËÆæÁΩÆÈÄâÈ°π
            document.getElementById('exportOption').addEventListener('click', () => {
                closeSettingsMenu();
                showExportInfo();
            });
            
            document.getElementById('themeOption').addEventListener('click', () => {
                toggleTheme();
                closeSettingsMenu();
            });
            
            document.getElementById('aboutOption').addEventListener('click', () => {
                closeSettingsMenu();
                showAboutInfo();
            });
            
            // ÁÇπÂáªÂ§ñÈÉ®ÂÖ≥Èó≠ËèúÂçï
            document.addEventListener('click', (e) => {
                if (!bubbleMenu.contains(e.target) && bubbleMenu.classList.contains('show')) {
                    closeBubbleMenu();
                }
                if (!quickMainBtn.contains(e.target) && !quickSubButtons.contains(e.target)) {
                    closeQuickMenu();
                }
            });

            // Ê†ºÂºèÊåâÈíÆÂ±ïÂºÄ/ÊäòÂè†
            const formatMainBtn = document.getElementById('formatMainBtn');
            const formatButtons = document.getElementById('formatButtons');

            if (formatMainBtn && formatButtons) {
            formatMainBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            if (formatButtons.style.display === 'none' || !formatButtons.style.display) {
            formatButtons.style.display = 'flex';
            // Ê∑ªÂä†Âä®ÁîªÁ±ªÔºàÂèØÈÄâÔºâ
            formatButtons.classList.add('show');
             } else {
            formatButtons.style.display = 'none';
            formatButtons.classList.remove('show');
             }
             });

            // ÁÇπÂáªÂÖ∂‰ªñÂå∫ÂüüÂÖ≥Èó≠Ê†ºÂºèËèúÂçï
            document.addEventListener('click', (e) => {
            if (!formatMainBtn.contains(e.target) && !formatButtons.contains(e.target)) {
            formatButtons.style.display = 'none';
                  }
              });
            }
            
            // Â§ÑÁêÜÁ™óÂè£Â§ßÂ∞èÂèòÂåñ
            window.addEventListener('resize', handleResize);
            
            // ÂèåÂáª‰∫ã‰ª∂
            setupDoubleClickEvents();

            // ÊêúÁ¥¢ËÅäÂ§©ËÆ∞ÂΩï
            document.getElementById('searchOption').addEventListener('click', () => {
            closeSettingsMenu();
            window.location.href = 'search.html';
            });
            
            // ÂÇ®Â≠òÁ©∫Èó¥ÁÆ°ÁêÜÈÄâÈ°π
            document.getElementById('storageOption').addEventListener('click', () => {
            closeSettingsMenu();
            openStorageDialog();
            });

            // Ëé∑ÂèñÂØπËØùÊ°ÜÂÖÉÁ¥†Âπ∂Ê∑ªÂä†‰∫ã‰ª∂
            const storageDialog = document.getElementById('storageDialog');
            const cancelStorageBtn = document.getElementById('cancelStorageBtn');
            const deleteSelectedBtn = document.getElementById('deleteSelectedBtn');
            const startDate = document.getElementById('startDate');
            const endDate = document.getElementById('endDate');

            cancelStorageBtn.addEventListener('click', closeStorageDialog);
            deleteSelectedBtn.addEventListener('click', deleteSelectedMessages);

            // Âø´ÈÄüÊó∂Èó¥ËåÉÂõ¥ÊåâÈíÆ
            document.querySelectorAll('.time-range-btn').forEach(btn => {
            btn.addEventListener('click', function() {
            setTimeRange(this.dataset.range);
               });
            });

            // Êó•ÊúüÂèòÂåñÊó∂Êõ¥Êñ∞È¢ÑËßà
            startDate.addEventListener('change', updatePreview);
            endDate.addEventListener('change', updatePreview);

            // ËØ≠Èü≥Ê®°ÂûãÁÆ°ÁêÜ
            document.getElementById('voiceModelOption').addEventListener('click', () => {
            closeSettingsMenu();
            openVoiceModelDialog();
            });
          
            }

// ÊâìÂºÄÂÇ®Â≠òÁ©∫Èó¥ÁÆ°ÁêÜÂØπËØùÊ°Ü
function openStorageDialog() {
    // Êõ¥Êñ∞ÂÇ®Â≠ò‰ΩøÁî®ÊÉÖÂÜµ
    updateStorageStats();
    
    // ËÆæÁΩÆÈªòËÆ§Êó•ÊúüËåÉÂõ¥ÔºàÊúÄËøë30Â§©Ôºâ
    const end = new Date();
    const start = new Date();
    start.setDate(end.getDate() - 30);
    
    startDate.value = formatDateForInput(start);
    endDate.value = formatDateForInput(end);
    
    // Êõ¥Êñ∞È¢ÑËßà
    updatePreview();
    
    storageDialog.classList.add('show');
    menuOverlay.classList.add('show');
}

// ÂÖ≥Èó≠ÂÇ®Â≠òÁ©∫Èó¥ÂØπËØùÊ°Ü
function closeStorageDialog() {
    storageDialog.classList.remove('show');
    menuOverlay.classList.remove('show');
}

// Êõ¥Êñ∞ÂÇ®Â≠ò‰ΩøÁî®ÊÉÖÂÜµÁªüËÆ°
function updateStorageStats() {
    let totalMessages = 0;
    let totalStorage = 0;
    
    // ËÆ°ÁÆóÊâÄÊúâÊ†áÁ≠æÁöÑÊ∂àÊÅØÊÄªÊï∞ÂíåÂÇ®Â≠òÈáè
    state.tabs.forEach(tab => {
        totalMessages += tab.messages.length;
        totalStorage += JSON.stringify(tab.messages).length;
    });
    
    // Êõ¥Êñ∞ÊòæÁ§∫
    document.getElementById('totalMessages').textContent = totalMessages;
    document.getElementById('totalTabs').textContent = state.tabs.length;
    document.getElementById('totalStorage').textContent = formatStorageSize(totalStorage);
    
    // Êõ¥Êñ∞ËÆæÁΩÆËèúÂçï‰∏≠ÁöÑÁÆÄÁï•ÊòæÁ§∫
    document.getElementById('storageUsage').textContent = formatStorageSize(totalStorage);
}

// Ê†ºÂºèÂåñÂÇ®Â≠òÂ§ßÂ∞è
function formatStorageSize(bytes) {
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
    return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
}

// ‰∏∫Êó•ÊúüËæìÂÖ•Ê°ÜÊ†ºÂºèÂåñÊó•Êúü
function formatDateForInput(date) {
    return date.toISOString().split('T')[0];
}

// ËÆæÁΩÆÊó∂Èó¥ËåÉÂõ¥
function setTimeRange(range) {
    const end = new Date();
    const start = new Date();
    
    switch(range) {
        case '7d':
            start.setDate(end.getDate() - 7);
            break;
        case '30d':
            start.setDate(end.getDate() - 30);
            break;
        case 'all':
            // ÊâæÂà∞ÊúÄÊó©ÁöÑÊó•Êúü
            let earliestDate = new Date();
            state.tabs.forEach(tab => {
                tab.messages.forEach(msg => {
                    const msgDate = new Date(msg.time);
                    if (msgDate < earliestDate) {
                        earliestDate = msgDate;
                    }
                });
            });
            start.setTime(earliestDate.getTime());
            break;
    }
    
    startDate.value = formatDateForInput(start);
    endDate.value = formatDateForInput(end);
    
    updatePreview();
}

// Êõ¥Êñ∞È¢ÑËßà
function updatePreview() {
    const start = new Date(startDate.value);
    const end = new Date(endDate.value);
    end.setHours(23, 59, 59, 999); // ÂåÖÊã¨ÁªìÊùüÊó•ÁöÑÂÖ®Â§©
    
    const previewList = document.getElementById('previewList');
    const previewStats = document.getElementById('previewStats');
    
    // Ê∏ÖÁ©∫È¢ÑËßà
    previewList.innerHTML = '';
    
    let selectedMessages = [];
    let selectedMessagesCount = 0;
    
    // Êî∂ÈõÜÈÄâÂÆöÊó∂Èó¥ËåÉÂõ¥ÂÜÖÁöÑÊ∂àÊÅØ
    state.tabs.forEach(tab => {
        tab.messages.forEach(msg => {
            const msgDate = new Date(msg.time);
            if (msgDate >= start && msgDate <= end) {
                selectedMessages.push({
                    tab: tab.name,
                    date: msgDate,
                    content: msg.content,
                    username: msg.username
                });
                selectedMessagesCount++;
            }
        });
    });
    
    // ÊòæÁ§∫È¢ÑËßàÔºàÊúÄÂ§öÊòæÁ§∫10Êù°Ôºâ
    const maxPreview = 10;
    selectedMessages.slice(0, maxPreview).forEach(msg => {
        const previewItem = document.createElement('div');
        previewItem.className = 'preview-item';
        
        const dateSpan = document.createElement('span');
        dateSpan.className = 'preview-date';
        dateSpan.textContent = formatTime(msg.date);
        
        const contentSpan = document.createElement('span');
        contentSpan.className = 'preview-content';
        contentSpan.textContent = msg.content.replace(/\[.*?\]/g, '').substring(0, 30);
        
        const labelSpan = document.createElement('span');
        labelSpan.className = 'preview-label';
        labelSpan.textContent = msg.tab;
        
        previewItem.appendChild(dateSpan);
        previewItem.appendChild(contentSpan);
        previewItem.appendChild(labelSpan);
        previewList.appendChild(previewItem);
    });
    
    if (selectedMessagesCount > maxPreview) {
        const moreItem = document.createElement('div');
        moreItem.className = 'preview-item';
        moreItem.style.justifyContent = 'center';
        moreItem.style.color = '#7f8c8d';
        moreItem.textContent = `...ËøòÊúâ${selectedMessagesCount - maxPreview}Êù°Ê∂àÊÅØ`;
        previewList.appendChild(moreItem);
    }
    
    // Êõ¥Êñ∞ÁªüËÆ°‰ø°ÊÅØ
    if (selectedMessagesCount > 0) {
        previewStats.textContent = `Â∞ÜÂà†Èô§ ${selectedMessagesCount} Êù°Ê∂àÊÅØÔºåÊù•Ëá™ ${new Set(selectedMessages.map(m => m.tab)).size} ‰∏™Ê†áÁ≠æ`;
        deleteSelectedBtn.disabled = false;
    } else {
        previewStats.textContent = 'Êó†ÈÄâ‰∏≠Ê∂àÊÅØ';
        deleteSelectedBtn.disabled = true;
    }
}

// Âà†Èô§ÈÄâÂÆöÁöÑÊ∂àÊÅØ
function deleteSelectedMessages() {
    const start = new Date(startDate.value);
    const end = new Date(endDate.value);
    end.setHours(23, 59, 59, 999);
    
    let deleteCount = 0;
    
    // ‰ªéÊØè‰∏™Ê†áÁ≠æ‰∏≠Âà†Èô§Ê∂àÊÅØ
    state.tabs.forEach(tab => {
        const originalLength = tab.messages.length;
        tab.messages = tab.messages.filter(msg => {
            const msgDate = new Date(msg.time);
            return !(msgDate >= start && msgDate <= end);
        });
        deleteCount += (originalLength - tab.messages.length);
    });
    
    // Â¶ÇÊûúÂΩìÂâçÊ†áÁ≠æÊúâÊ∂àÊÅØË¢´Âà†Èô§ÔºåÈáçÊñ∞Ê∏≤Êüì
    const currentTab = state.tabs.find(t => t.id === state.currentTabId);
    if (currentTab) {
        state.messages = [...currentTab.messages];
        renderMessages();
    }
    
    // ‰øùÂ≠òÂà∞Êú¨Âú∞Â≠òÂÇ®
    saveToLocalStorage();
    
    // ÂÖ≥Èó≠ÂØπËØùÊ°ÜÂπ∂ÊòæÁ§∫Á°ÆËÆ§
    closeStorageDialog();
    showConfirmDialog('Âà†Èô§ÂÆåÊàê', `Â∑≤Âà†Èô§ ${deleteCount} Êù°Ê∂àÊÅØ`, null, true);
    
    // Êõ¥Êñ∞ÂÇ®Â≠òÁªüËÆ°
    updateStorageStats();
}

        // ÂÖ≥Èó≠ÊâÄÊúâËèúÂçïÂíåÂØπËØùÊ°Ü
        function closeAllMenusAndDialogs() {
            // ÂÖ≥Èó≠ÊâÄÊúâÂØπËØùÊ°Ü
            if (renameDialog.classList.contains('show')) {
                closeRenameDialog();
            } else if (confirmDialog.classList.contains('show')) {
                closeConfirmDialog();
            } else if (usernameDialog.classList.contains('show')) {
                closeUsernameDialog();
            } else if (assistantDialog.classList.contains('show')) {
                closeAssistantDialog();
            } else if (replyContentDialog.classList.contains('show')) {
                closeReplyContentDialog();
            } else if (sendKeyDialog.classList.contains('show')) {
                closeSendKeyDialog();
            } else if (fontSizeDialog.classList.contains('show')) {
                closeFontSizeDialog();
            } else if (settingsMenu.classList.contains('open')) {
                closeSettingsMenu();
            } else if (sideMenu.classList.contains('open')) {
                closeSideMenu();
            }
            
            // Á°Æ‰øùÈÅÆÁΩ©Â±Ç‰πüÂÖ≥Èó≠
            menuOverlay.classList.remove('show');
        }

        // ÂàáÊç¢Âø´ÈÄüËèúÂçï
        function toggleQuickMenu() {
            if (state.quickMenuOpen) {
                closeQuickMenu();
            } else {
                openQuickMenu();
            }
        }

        // ÊâìÂºÄÂø´ÈÄüËèúÂçï
        function openQuickMenu() {
            quickSubButtons.classList.add('show');
            quickMainBtn.style.transform = 'rotate(45deg)';
            state.quickMenuOpen = true;
        }

        // ÂÖ≥Èó≠Âø´ÈÄüËèúÂçï
        function closeQuickMenu() {
            quickSubButtons.classList.remove('show');
            quickMainBtn.style.transform = 'rotate(0deg)';
            state.quickMenuOpen = false;
        }

        // ÊâìÂºÄÂ≠ó‰ΩìÂ§ßÂ∞èÂØπËØùÊ°Ü
        function openFontSizeDialog() {
            fontSizeSlider.value = state.settings.fontSize;
            fontSizeDisplay.textContent = state.settings.fontSize + 'px';
            fontSizeDialog.classList.add('show');
            menuOverlay.classList.add('show');
        }

        // ÂÖ≥Èó≠Â≠ó‰ΩìÂ§ßÂ∞èÂØπËØùÊ°Ü
        function closeFontSizeDialog() {
            fontSizeDialog.classList.remove('show');
            menuOverlay.classList.remove('show');
        }

        // ‰øùÂ≠òÂ≠ó‰ΩìÂ§ßÂ∞èËÆæÁΩÆ
        function saveFontSizeSetting() {
            const newSize = parseInt(fontSizeSlider.value);
            if (newSize >= 12 && newSize <= 24) {
                state.settings.fontSize = newSize;
                updateFontSizeDisplay();
                applyFontSizeToBubbles();
                saveToLocalStorage();
                closeFontSizeDialog();
                showConfirmDialog('ËÆæÁΩÆÊàêÂäü', `Ê∞îÊ≥°Â≠ó‰ΩìÂ§ßÂ∞èÂ∑≤Ë∞ÉÊï¥‰∏∫${newSize}px`, null, true);
            }
        }

        // Êõ¥Êñ∞Â≠ó‰ΩìÂ§ßÂ∞èÊòæÁ§∫
        function updateFontSizeDisplay() {
            fontSizeValue.textContent = state.settings.fontSize + 'px';
        }

        // Â∫îÁî®Â≠ó‰ΩìÂ§ßÂ∞èÂà∞ÊâÄÊúâÊ∞îÊ≥°
        function applyFontSizeToBubbles() {
            const bubbles = document.querySelectorAll('.bubble');
            bubbles.forEach(bubble => {
                bubble.style.fontSize = state.settings.fontSize + 'px';
            });
        }

        // ÊâìÂºÄËá™Âä®ÂõûÂ§çÂÜÖÂÆπÂØπËØùÊ°Ü
        function openReplyContentDialog() {
            probabilitySlider.value = state.autoReplyProbability;
            probabilityDisplay.textContent = `Ê¶ÇÁéá: ${state.autoReplyProbability}%`;
            replyContentDialog.classList.add('show');
            menuOverlay.classList.add('show');
            updateReplyList();
        }

        // Êõ¥Êñ∞ÂõûÂ§çÂàóË°®
        function updateReplyList() {
            replyList.innerHTML = '';
            
            state.autoReplies.forEach((reply, index) => {
                const replyItem = document.createElement('div');
                replyItem.className = 'reply-item';
                
                const replyText = document.createElement('div');
                replyText.className = 'reply-text';
                replyText.textContent = reply;
                
                const replyActions = document.createElement('div');
                replyActions.className = 'reply-actions';
                
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'reply-action-btn delete';
                deleteBtn.title = 'Âà†Èô§';
                deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
                deleteBtn.addEventListener('click', () => {
                    state.autoReplies.splice(index, 1);
                    updateReplyList();
                });
                
                replyActions.appendChild(deleteBtn);
                
                replyItem.appendChild(replyText);
                replyItem.appendChild(replyActions);
                
                replyList.appendChild(replyItem);
            });
        }

        // Ê∑ªÂä†Êñ∞ÂõûÂ§ç
        function addNewReply() {
            const newReply = addReplyInput.value.trim();
            if (newReply) {
                state.autoReplies.push(newReply);
                addReplyInput.value = '';
                updateReplyList();
            }
        }

        // ‰øùÂ≠òËá™Âä®ÂõûÂ§çÂÜÖÂÆπËÆæÁΩÆ
        function saveReplyContentSettings() {
            state.autoReplyProbability = parseInt(probabilitySlider.value);
            updateProbabilityDisplay();
            saveToLocalStorage();
            closeReplyContentDialog();
            showConfirmDialog('ËÆæÁΩÆÊàêÂäü', `Ëá™Âä®ÂõûÂ§çËÆæÁΩÆÂ∑≤‰øùÂ≠òÔºÅ`, null, true);
        }

        // ÂÖ≥Èó≠Ëá™Âä®ÂõûÂ§çÂÜÖÂÆπÂØπËØùÊ°Ü
        function closeReplyContentDialog() {
            replyContentDialog.classList.remove('show');
            menuOverlay.classList.remove('show');
        }

        // ÊâìÂºÄÂèëÈÄÅÊñπÂºèÂØπËØùÊ°Ü
        function openSendKeyDialog() {
            // Êõ¥Êñ∞ÈÄâÈ°πÁä∂ÊÄÅ
            document.querySelectorAll('.send-key-option').forEach(option => {
                option.classList.remove('selected');
                if (option.dataset.value === state.settings.sendKey) {
                    option.classList.add('selected');
                }
            });
            
            // Ê∑ªÂä†ÈÄâÈ°πÁÇπÂáª‰∫ã‰ª∂
            document.querySelectorAll('.send-key-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.send-key-option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    this.classList.add('selected');
                });
            });
            
            sendKeyDialog.classList.add('show');
            menuOverlay.classList.add('show');
        }

        // ÂÖ≥Èó≠ÂèëÈÄÅÊñπÂºèÂØπËØùÊ°Ü
        function closeSendKeyDialog() {
            sendKeyDialog.classList.remove('show');
            menuOverlay.classList.remove('show');
        }

        // ‰øùÂ≠òÂèëÈÄÅÊñπÂºèËÆæÁΩÆ
        function saveSendKeySetting() {
            const selectedOption = document.querySelector('.send-key-option.selected');
            if (selectedOption) {
                const newSendKey = selectedOption.dataset.value;
                state.settings.sendKey = newSendKey;
                
                // Êõ¥Êñ∞ÊòæÁ§∫
                updateSendKeyDisplay();
                
                saveToLocalStorage();
                closeSendKeyDialog();
                showConfirmDialog('ËÆæÁΩÆÊàêÂäü', `ÂèëÈÄÅÈîÆÂ∑≤ËÆæÁΩÆ‰∏∫${newSendKey === 'enter' ? 'EnterÂèëÈÄÅ' : 'EnterÊç¢Ë°å'}`, null, true);
            }
        }

        // Êõ¥Êñ∞ÂèëÈÄÅÊñπÂºèÊòæÁ§∫
        function updateSendKeyDisplay() {
            const displayText = state.settings.sendKey === 'enter' ? 'EnterÂèëÈÄÅ' : 'EnterÊç¢Ë°å';
            sendKeyValue.textContent = displayText;
        }

        // ËÆæÁΩÆÂèåÂáª‰∫ã‰ª∂
        function setupDoubleClickEvents() {
            chatContainer.addEventListener('click', (e) => {
                const bubble = e.target.closest('.bubble');
                if (!bubble) return;
                
                // Â¶ÇÊûúÁÇπÂáªÁöÑÊòØÂæÖÂäûÂ§çÈÄâÊ°ÜÔºåÂàáÊç¢ÂÆåÊàêÁä∂ÊÄÅ
                if (bubble.classList.contains('todo-pending') || bubble.classList.contains('todo-completed')) {
                    const messageElement = bubble.closest('.message');
                    if (messageElement && messageElement.classList.contains('other')) {
                        const messageId = parseInt(messageElement.dataset.messageId);
                        toggleTodoStatus(messageId);
                        return;
                    }
                }
                
                const messageElement = bubble.closest('.message');
                if (messageElement) {
                    const messageId = parseInt(messageElement.dataset.messageId);
                    const message = findMessageById(messageId);
                    if (message) {
                        state.selectedMessage = message;
                        
                        // ÂèåÂáªÊ£ÄÊµã
                        const currentTime = new Date().getTime();
                        const tapLength = currentTime - state.lastTapTime;
                        
                        if (tapLength < 300 && tapLength > 0) {
                            // ÂèåÂáª‰∫ã‰ª∂
                            e.preventDefault();
                            e.stopPropagation();
                            
                            // Ê∑ªÂä†ÊäñÂä®ÊïàÊûú
                            bubble.classList.add('shake');
                            setTimeout(() => {
                                bubble.classList.remove('shake');
                            }, 300);
                            
                            // ÊòæÁ§∫Ê∞îÊ≥°ËèúÂçï
                            showBubbleMenu(e.clientX, e.clientY);
                            
                            // Êõ¥Êñ∞ËèúÂçïÈ°πÁä∂ÊÄÅÔºàÊ†πÊçÆÊ∂àÊÅØÂèëÈÄÅËÄÖÊòæÁ§∫‰∏çÂêåËèúÂçïÔºâ
                            updateBubbleMenuItems(message);
                            
                            state.lastTapTime = 0;
                            
                            if (state.tapTimeout) {
                                clearTimeout(state.tapTimeout);
                                state.tapTimeout = null;
                            }
                        } else {
                            state.lastTapTime = currentTime;
                            state.tapTimeout = setTimeout(() => {
                                state.lastTapTime = 0;
                            }, 300);
                        }
                    }
                }
            });
            
            // Ê∞îÊ≥°ËèúÂçïÈ°πÁÇπÂáª‰∫ã‰ª∂
            bubbleMenu.addEventListener('click', (e) => {
                const menuItem = e.target.closest('.bubble-menu-item');
                if (menuItem && state.selectedMessage) {
                    const action = menuItem.dataset.action;
                    handleBubbleMenuAction(action);
                }
            });
            
            // Â§ÑÁêÜÂä©ÊâãÂæÖÂäûË°®Ê†ºÁöÑÂãæÈÄâ
            chatContainer.addEventListener('click', (e) => {
                // Â§ÑÁêÜÂä©ÊâãÂæÖÂäûË°®Ê†ºÁöÑ‰øùÂ≠òÊåâÈíÆ
                const saveBtn = e.target.closest('.save-todo-btn');
                if (saveBtn) {
                    const tableContainer = saveBtn.closest('.todo-table-container');
                    if (tableContainer) {
                        const table = tableContainer.querySelector('.todo-table');
                        const checkboxes = table.querySelectorAll('.todo-checkbox');
                        let checkedCount = 0;
                        
                        checkboxes.forEach((checkbox, index) => {
                            if (checkbox.checked) {
                                checkedCount++;
                                const row = checkbox.closest('tr');
                                const mapKey = row.dataset.mapKey;
                                const originalInfo = state.assistantTodoMap[mapKey];
                                
                                if (originalInfo) {
                                    // Êõ¥Êñ∞ÂéüÂßãÊ∂àÊÅØ‰∏∫ÂÆåÊàêÁä∂ÊÄÅ
                                    const currentTab = state.tabs.find(t => t.id === state.currentTabId);
                                    if (currentTab) {
                                        const originalMessage = currentTab.messages.find(m => m.id === originalInfo.originalMessageId);
                                        if (originalMessage && originalMessage.content.includes('[ÂæÖÂäû]') && !originalMessage.content.includes('[ÂæÖÂäûÂÆåÊàê]')) {
                                            originalMessage.content = originalMessage.content.replace('[ÂæÖÂäû]', '[ÂæÖÂäûÂÆåÊàê]');
                                            // Ê†áËÆ∞‰∏∫Â∑≤ÂÆåÊàêÁä∂ÊÄÅ
                                            state.assistantTodoStates[mapKey] = true;
                                            updateMessageDisplay(originalMessage.id);
                                        }
                                    }
                                }
                            }
                        });
                        
                        // ÁîüÊàêÊèêÁ§∫Ê∂àÊÅØ
                        const now = new Date();
                        const assistantMessageId = Date.now() + 1;
                        const assistantReplyMessage = {
                            id: assistantMessageId,
                            username: state.assistantName,
                            content: `ÂãæÈÄâÁöÑÂÜÖÂÆπÂ∑≤Ê†áËÆ∞‰∏∫Â∑≤ÂÆåÊàêÔºåÂêéÁª≠ÂèØÂú®Â∑≤ÂÆåÊàê‰∏≠Êü•Áúã„ÄÇ`,
                            time: now,
                            isSelf: false,
                            formattedTime: formatTime(now)
                        };
                        
                        const currentTab = state.tabs.find(t => t.id === state.currentTabId);
                        if (currentTab) {
                            currentTab.messages.push(assistantReplyMessage);
                        }
                        
                        addMessageToChat(assistantReplyMessage);
                        saveToLocalStorage();
                        
                        // ÁßªÈô§Ë°®Ê†ºÔºà‰∏ç‰øùÂ≠òÂà∞Ê∂àÊÅØËÆ∞ÂΩï‰∏≠Ôºâ
                        tableContainer.remove();
                    }
                }
            });
        }

        // Êõ¥Êñ∞Ê∞îÊ≥°ËèúÂçïÈ°πÁä∂ÊÄÅ - ‰øÆÊîπÔºöÂ¢ûÂä†Ê†áËÆ∞ÂÆåÊàê/ÈáçÊñ∞ÂæÖÂäûÈÄâÈ°π
        function updateBubbleMenuItems(message) {
            // Ê∏ÖÁ©∫Ê∞îÊ≥°ËèúÂçï
            bubbleMenu.innerHTML = '';
            
            // Â¶ÇÊûúÊòØÂä©ÊâãÂèëÈÄÅÁöÑÊ∂àÊÅØÔºåÂè™ÊòæÁ§∫Âà†Èô§ÈÄâÈ°π
            if (!message.isSelf) {
                const deleteItem = document.createElement('button');
                deleteItem.className = 'bubble-menu-item delete';
                deleteItem.dataset.action = 'delete';
                deleteItem.innerHTML = '<i class="fas fa-trash"></i> Âà†Èô§Ê∂àÊÅØ';
                bubbleMenu.appendChild(deleteItem);
                return;
            }
            
            // Â¶ÇÊûúÊòØËá™Â∑±ÂèëÈÄÅÁöÑÊ∂àÊÅØÔºåÊòæÁ§∫ÂÆåÊï¥ËèúÂçï
            
            // ÈáçË¶ÅÈÄâÈ°π
            const importantItem = document.createElement('button');
            importantItem.className = 'bubble-menu-item important';
            importantItem.dataset.action = 'toggleImportant';
            
            const importantIcon = document.createElement('i');
            importantIcon.className = 'fas fa-exclamation-circle';
            
            const importantText = document.createElement('span');
            importantText.textContent = message.content.includes('[ÈáçË¶Å]') ? 'ÂèñÊ∂àÈáçË¶Å' : 'ÈáçË¶Å';
            
            importantItem.appendChild(importantIcon);
            importantItem.appendChild(importantText);
            
            // ÂæÖÂäû/ÂÆåÊàê/ÈáçÊñ∞ÂæÖÂäûÈÄâÈ°π
            let todoItem;
            
            if (message.content.includes('[ÂæÖÂäûÂÆåÊàê]')) {
                // Â∑≤ÂÆåÊàêÁä∂ÊÄÅÔºöÊòæÁ§∫ÈáçÊñ∞ÂæÖÂäûÂíåÂèñÊ∂àÂæÖÂäû
                const reopenItem = document.createElement('button');
                reopenItem.className = 'bubble-menu-item reopen';
                reopenItem.dataset.action = 'reopenTodo';
                
                const reopenIcon = document.createElement('i');
                reopenIcon.className = 'fas fa-undo';
                
                const reopenText = document.createElement('span');
                reopenText.textContent = 'ÈáçÊñ∞ÂæÖÂäû';
                
                reopenItem.appendChild(reopenIcon);
                reopenItem.appendChild(reopenText);
                bubbleMenu.appendChild(reopenItem);
                
                todoItem = document.createElement('button');
                todoItem.className = 'bubble-menu-item todo';
                todoItem.dataset.action = 'toggleTodo';
                
                const todoIcon = document.createElement('i');
                todoIcon.className = 'fas fa-times-circle';
                
                const todoText = document.createElement('span');
                todoText.textContent = 'ÂèñÊ∂àÂæÖÂäû';
                
                todoItem.appendChild(todoIcon);
                todoItem.appendChild(todoText);
            } else if (message.content.includes('[ÂæÖÂäû]')) {
                // ÂæÖÂäûÁä∂ÊÄÅÔºöÊòæÁ§∫Ê†áËÆ∞ÂÆåÊàêÂíåÂèñÊ∂àÂæÖÂäû
                const completeItem = document.createElement('button');
                completeItem.className = 'bubble-menu-item complete';
                completeItem.dataset.action = 'completeTodo';
                
                const completeIcon = document.createElement('i');
                completeIcon.className = 'fas fa-check-circle';
                
                const completeText = document.createElement('span');
                completeText.textContent = 'Ê†áËÆ∞ÂÆåÊàê';
                
                completeItem.appendChild(completeIcon);
                completeItem.appendChild(completeText);
                bubbleMenu.appendChild(completeItem);
                
                todoItem = document.createElement('button');
                todoItem.className = 'bubble-menu-item todo';
                todoItem.dataset.action = 'toggleTodo';
                
                const todoIcon = document.createElement('i');
                todoIcon.className = 'fas fa-times-circle';
                
                const todoText = document.createElement('span');
                todoText.textContent = 'ÂèñÊ∂àÂæÖÂäû';
                
                todoItem.appendChild(todoIcon);
                todoItem.appendChild(todoText);
            } else {
                // ÈùûÂæÖÂäûÁä∂ÊÄÅÔºöÊòæÁ§∫ÂæÖÂäûÈÄâÈ°π
                todoItem = document.createElement('button');
                todoItem.className = 'bubble-menu-item todo';
                todoItem.dataset.action = 'toggleTodo';
                
                const todoIcon = document.createElement('i');
                todoIcon.className = 'fas fa-check-circle';
                
                const todoText = document.createElement('span');
                todoText.textContent = 'ÂæÖÂäû';
                
                todoItem.appendChild(todoIcon);
                todoItem.appendChild(todoText);
            }
            
            // Âà†Èô§ÈÄâÈ°π
            const deleteItem = document.createElement('button');
            deleteItem.className = 'bubble-menu-item delete';
            deleteItem.dataset.action = 'delete';
            deleteItem.innerHTML = '<i class="fas fa-trash"></i> Âà†Èô§Ê∂àÊÅØ';
            
            // Ê∑ªÂä†Âà∞Ê∞îÊ≥°ËèúÂçïÔºàÊ†πÊçÆÊÉÖÂÜµÊ∑ªÂä†Ôºâ
            bubbleMenu.appendChild(importantItem);
            if (todoItem) {
                bubbleMenu.appendChild(todoItem);
            }
            bubbleMenu.appendChild(deleteItem);
        }

        // Âç≥Êó∂Êõ¥Êñ∞Âçï‰∏™Ê∂àÊÅØÁöÑÊòæÁ§∫Áä∂ÊÄÅ
        function updateMessageDisplay(messageId) {
        // ÊâæÂà∞Ê∂àÊÅØÁöÑDOMÂÖÉÁ¥†
        const messageElement = document.querySelector(`.message[data-message-id="${messageId}"]`);
        if (!messageElement) return;
    
        const bubble = messageElement.querySelector('.bubble');
        if (!bubble) return;
    
        const currentTab = state.tabs.find(t => t.id === state.currentTabId);
        if (!currentTab) return;
    
        const message = currentTab.messages.find(m => m.id === messageId);
        if (!message) return;
    
        // Êõ¥Êñ∞Ê∞îÊ≥°Ê†∑Âºè
        if (message.content.includes('[ÂæÖÂäûÂÆåÊàê]')) {
            bubble.classList.add('todo-completed');
            bubble.classList.remove('todo-pending');
            bubble.style.textDecoration = 'line-through';
            bubble.style.opacity = '0.8';
        } else if (message.content.includes('[ÂæÖÂäû]')) {
            bubble.classList.add('todo-pending');
            bubble.classList.remove('todo-completed');
            bubble.style.textDecoration = 'none';
            bubble.style.opacity = '1';
        }
    
        // Êõ¥Êñ∞Ê∞îÊ≥°ÂÜÖÂÆπÔºà‰øùÊåÅÊ†ºÂºèÊ†áËÆ∞Ôºâ
        bubble.innerHTML = formatMessageContent(message.content);
        }
        
        // ÂàáÊç¢ÂæÖÂäûÁä∂ÊÄÅÔºàÁî®‰∫éÂä©ÊâãÊ∂àÊÅØÁöÑÂãæÈÄâÊ°ÜÔºâ
        function toggleTodoStatus(messageId) {
            const currentTab = state.tabs.find(t => t.id === state.currentTabId);
            if (!currentTab) return;
            
            const messageIndex = currentTab.messages.findIndex(m => m.id === messageId);
            if (messageIndex === -1) return;
            
            const message = currentTab.messages[messageIndex];
            
            if (!message.content.includes('[ÂæÖÂäû]') && !message.content.includes('[ÂæÖÂäûÂÆåÊàê]')) {
                return;
            }
            
            if (message.content.includes('[ÂæÖÂäûÂÆåÊàê]')) {
                message.content = message.content.replace('[ÂæÖÂäûÂÆåÊàê]', '[ÂæÖÂäû]');
            } else {
                message.content = message.content.replace('[ÂæÖÂäû]', '[ÂæÖÂäûÂÆåÊàê]');
            }
            updateMessageDisplay(messageId);
            renderMessages();
            saveToLocalStorage();
        }

        // ÊòæÁ§∫Ê∞îÊ≥°ËèúÂçï
        function showBubbleMenu(x, y) {
            const menuWidth = 160;
            const menuHeight = 200;
            const windowWidth = window.innerWidth;
            const windowHeight = window.innerHeight;
            
            let posX = x;
            let posY = y;
            
            if (posX + menuWidth > windowWidth) {
                posX = windowWidth - menuWidth - 10;
            }
            
            if (posY + menuHeight > windowHeight) {
                posY = windowHeight - menuHeight - 10;
            }
            
            bubbleMenu.style.left = posX + 'px';
            bubbleMenu.style.top = posY + 'px';
            bubbleMenu.classList.add('show');
        }

        // ÂÖ≥Èó≠Ê∞îÊ≥°ËèúÂçï
        function closeBubbleMenu() {
            bubbleMenu.classList.remove('show');
            state.selectedMessage = null;
        }

        // Â§ÑÁêÜÊ∞îÊ≥°ËèúÂçïÂä®‰Ωú
        function handleBubbleMenuAction(action) {
            if (!state.selectedMessage) return;
            
            const currentTab = state.tabs.find(t => t.id === state.currentTabId);
            if (!currentTab) return;
            
            const messageIndex = currentTab.messages.findIndex(m => m.id === state.selectedMessage.id);
            if (messageIndex === -1) return;
            
            let newContent = currentTab.messages[messageIndex].content;
            
            switch (action) {
                case 'toggleImportant':
                    if (newContent.includes('[ÈáçË¶Å]')) {
                        newContent = newContent.replace('[ÈáçË¶Å] ', '');
                    } else {
                        newContent = '[ÈáçË¶Å] ' + newContent;
                    }
                    break;
                    
                case 'toggleTodo':
                    // ÂèñÊ∂àÂæÖÂäûÔºàÁßªÈô§ÂæÖÂäûÊ†áËÆ∞Ôºâ
                    if (newContent.includes('[ÂæÖÂäû]')) {
                        newContent = newContent.replace('[ÂæÖÂäû] ', '');
                    } else if (newContent.includes('[ÂæÖÂäûÂÆåÊàê]')) {
                        newContent = newContent.replace('[ÂæÖÂäûÂÆåÊàê] ', '');
                    } else {
                        newContent = '[ÂæÖÂäû] ' + newContent;
                    }
                    break;
                    
                case 'completeTodo':
                    // Ê†áËÆ∞ÂÆåÊàêÔºà‰ªéÂæÖÂäûËΩ¨‰∏∫ÂÆåÊàêÔºâ
                    if (newContent.includes('[ÂæÖÂäû]')) {
                        newContent = newContent.replace('[ÂæÖÂäû]', '[ÂæÖÂäûÂÆåÊàê]');
                    }
                    break;
                    
                case 'reopenTodo':
                    // ÈáçÊñ∞ÂæÖÂäûÔºà‰ªéÂÆåÊàêËΩ¨‰∏∫ÂæÖÂäûÔºâ
                    if (newContent.includes('[ÂæÖÂäûÂÆåÊàê]')) {
                        newContent = newContent.replace('[ÂæÖÂäûÂÆåÊàê]', '[ÂæÖÂäû]');
                    }
                    break;
                    
                case 'delete':
                    showConfirmDialog('Âà†Èô§Ê∂àÊÅØ', 'Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÊù°Ê∂àÊÅØÂêóÔºü', () => {
                        currentTab.messages.splice(messageIndex, 1);
                        renderMessages();
                        saveToLocalStorage();
                    });
                    break;
            }
            
            if (action !== 'delete') {
                currentTab.messages[messageIndex].content = newContent;
                renderMessages();
                saveToLocalStorage();
            }
            
            closeBubbleMenu();
        }

        // ÂèëÈÄÅÊü•ËØ¢ÁªôÂä©Êâã
        function sendQueryToAssistant(type) {
            closeQuickMenu();
            
            let queryText = '';
            if (type === 'todo') {
                queryText = 'Âèë‰∏Ä‰∏ãÊàëÁöÑÂæÖÂäû‰∫ãÈ°πÁªôÊàë„ÄÇ';
            } else if (type === 'completed') {
                queryText = 'Âèë‰∏Ä‰∏ãÊàëÁöÑÂÆåÊàê‰∫ãÈ°πÁªôÊàë„ÄÇ';
            } else if (type === 'important') {
                queryText = 'Âèë‰∏Ä‰∏ãÊàëÁöÑÈáçË¶Å‰∫ãÈ°πÁªôÊàë„ÄÇ';
            }
            
            const now = new Date();
            const queryMessage = {
                id: Date.now(),
                username: state.username,
                content: queryText,
                time: now,
                isSelf: true,
                formattedTime: formatTime(now)
            };
            
            const currentTab = state.tabs.find(t => t.id === state.currentTabId);
            if (currentTab) {
                currentTab.messages.push(queryMessage);
            }
            
            state.messages.push(queryMessage);
            
            addMessageToChat(queryMessage);
            
            messageInput.value = '';
            adjustInputHeight();
            sendBtn.classList.remove('show');
            
            emptyState.style.display = 'none';
            
            scrollToBottom();
            
            saveToLocalStorage();
            
            setTimeout(() => {
                if (type === 'todo') {
                    generateAssistantTodoTable();
                } else {
                    generateAssistantReply(type);
                }
            }, 1000);
        }

        // ÁîüÊàêÂä©ÊâãÂõûÂ§çÔºàÁî®‰∫éÂÆåÊàê‰∫ãÈ°πÂíåÈáçË¶Å‰∫ãÈ°πÔºâ
        function generateAssistantReply(type) {
            const currentTab = state.tabs.find(t => t.id === state.currentTabId);
            if (!currentTab) return;
            
            let replyContent = '';
            const foundItems = [];
            
            const assistantMessageId = Date.now() + 1;
            
            currentTab.messages.forEach(message => {
                if (message.isSelf) {
                    const dateStr = formatDate(message.time);
                    const contentWithoutTags = message.content.replace(/\[.*?\]/g, '').trim();
                    
                    if (type === 'todo' && message.content.includes('[ÂæÖÂäû]') && !message.content.includes('[ÂæÖÂäûÂÆåÊàê]')) {
                        foundItems.push({
                            date: dateStr,
                            content: contentWithoutTags,
                            id: message.id,
                            completed: false
                        });
                    } else if (type === 'completed' && message.content.includes('[ÂæÖÂäûÂÆåÊàê]')) {
                        foundItems.push({
                            date: dateStr,
                            content: contentWithoutTags,
                            id: message.id,
                            completed: true
                        });
                    } else if (type === 'important' && message.content.includes('[ÈáçË¶Å]')) {
                        foundItems.push({
                            date: dateStr,
                            content: contentWithoutTags,
                            id: message.id,
                            important: true
                        });
                    }
                }
            });
            
            if (foundItems.length === 0) {
                if (type === 'todo') { 
                    replyContent = 'ÊÇ®ÁõÆÂâçÊ≤°ÊúâÂæÖÂäû‰∫ãÈ°π„ÄÇ'; 
                } else if (type === 'completed') { 
                    replyContent = 'ÊÇ®ÁõÆÂâçÊ≤°ÊúâÂ∑≤ÂÆåÊàêÁöÑ‰∫ãÈ°π„ÄÇ'; 
                } else if (type === 'important') { 
                    replyContent = 'ÊÇ®ÁõÆÂâçÊ≤°ÊúâÈáçË¶Å‰∫ãÈ°π„ÄÇ'; 
                }
            } else { 
                if (type === 'todo') { 
                    replyContent = '‰ª•‰∏ãÊòØÊÇ®ÁöÑÂæÖÂäû‰∫ãÈ°πÔºö<br>';
                    foundItems.forEach((item, index) => {
                        const mapKey = assistantMessageId + '_' + index;
                        state.assistantTodoMap[mapKey] = {
                            originalMessageId: item.id,
                            todoIndex: index
                        };
                        
                        // Ê£ÄÊü•ÊòØÂê¶Â∑≤ÁªèÂÆåÊàê
                        const stateKey = `${item.id}_${index}`;
                        const isCompleted = state.assistantTodoStates[stateKey] || false;
                        const checked = isCompleted ? 'checked' : '';
                        const completedClass = isCompleted ? 'completed' : '';
                        
                        replyContent += '<div class="todo-list-item ' + completedClass + '" data-message-id="' + assistantMessageId + '" data-todo-index="' + index + '"><div class="todo-list-header"><span class="todo-list-date">' + item.date + '</span><input type="checkbox" class="todo-list-checkbox" ' + checked + '></div><div class="todo-list-content">' + item.content + '</div></div>';
                    });
                } else if (type === 'completed') { 
                    replyContent = '‰ª•‰∏ãÊòØÊÇ®Â∑≤ÂÆåÊàêÁöÑ‰∫ãÈ°πÔºö<br>';
                    foundItems.forEach((item, index) => {
                        replyContent += '<div class="todo-list-item completed"><div class="todo-list-header"><span class="todo-list-date">' + item.date + '</span><span>‚úì</span></div><div class="todo-list-content">' + item.content + '</div></div>';
                    });
                } else if (type === 'important') { 
                    replyContent = '‰ª•‰∏ãÊòØÊÇ®ÁöÑÈáçË¶Å‰∫ãÈ°πÔºö<br>';
                    foundItems.forEach((item, index) => {
                        replyContent += '<div class="todo-list-item"><div class="todo-list-header"><span class="todo-list-date">' + item.date + '</span><span style="color:#e74c3c;">‚òÖ</span></div><div class="todo-list-content">' + item.content + '</div></div>';
                    });
                }
            }
            
            const now = new Date();
            const assistantReplyMessage = {
                id: assistantMessageId,
                username: state.assistantName,
                content: replyContent,
                time: now,
                isSelf: false,
                formattedTime: formatTime(now)
            };
            
            currentTab.messages.push(assistantReplyMessage);
            state.messages.push(assistantReplyMessage);
            
            addMessageToChat(assistantReplyMessage);
            saveToLocalStorage();
        }

        // ÁîüÊàêÂä©ÊâãÂæÖÂäûË°®Ê†ºÔºàÊñ∞Ê†ºÂºèÔºâ
        function generateAssistantTodoTable() {
            const currentTab = state.tabs.find(t => t.id === state.currentTabId);
            if (!currentTab) return;
            
            const foundItems = [];
            
            // Êü•ÊâæÊâÄÊúâÂæÖÂäû‰∫ãÈ°π
            currentTab.messages.forEach(message => {
                if (message.isSelf) {
                    const dateStr = formatDate(message.time);
                    const contentWithoutTags = message.content.replace(/\[.*?\]/g, '').trim();
                    
                    if (message.content.includes('[ÂæÖÂäû]') && !message.content.includes('[ÂæÖÂäûÂÆåÊàê]')) {
                        foundItems.push({
                            date: dateStr,
                            content: contentWithoutTags,
                            id: message.id,
                            completed: false
                        });
                    }
                }
            });
            
            const assistantMessageId = Date.now() + 1;
            
            // ÁîüÊàêÁ¨¨‰∏Ä‰∏™Ê∞îÊ≥°ÔºöÊèêÁ§∫ÊñáÊú¨
            const now = new Date();
            const assistantReplyMessage = {
                id: assistantMessageId,
                username: state.assistantName,
                content: '‰ª•‰∏ãÊòØÊÇ®ÁöÑÂæÖÂäû‰∫ãÈ°πÔºö',
                time: now,
                isSelf: false,
                formattedTime: formatTime(now)
            };
            
            currentTab.messages.push(assistantReplyMessage);
            state.messages.push(assistantReplyMessage);
            
            addMessageToChat(assistantReplyMessage);
            
            if (foundItems.length === 0) {
                // Ê≤°ÊúâÂæÖÂäû‰∫ãÈ°π
                const emptyMessage = {
                    id: assistantMessageId + 1,
                    username: state.assistantName,
                    content: 'ÊÇ®ÁõÆÂâçÊ≤°ÊúâÂæÖÂäû‰∫ãÈ°π„ÄÇ',
                    time: now,
                    isSelf: false,
                    formattedTime: formatTime(now)
                };
                
                currentTab.messages.push(emptyMessage);
                state.messages.push(emptyMessage);
                
                addMessageToChat(emptyMessage);
            } else {
                // ÂàõÂª∫Ë°®Ê†ºÂÆπÂô®Ôºà‰∏ç‰øùÂ≠òÂà∞Ê∂àÊÅØËÆ∞ÂΩï‰∏≠Ôºâ
                const tableContainer = document.createElement('div');
                tableContainer.className = 'todo-table-container';
                
                // ÂàõÂª∫Ë°®Ê†º
                const table = document.createElement('table');
                table.className = 'todo-table';
                
                // ÂàõÂª∫Ë°®Â§¥
                const thead = document.createElement('thead');
                const headerRow = document.createElement('tr');
                const headers = ['Êó•Êúü', 'Ê†áËÆ∞', 'ÂÜÖÂÆπ', 'Êìç‰Ωú'];
                
                headers.forEach(headerText => {
                    const th = document.createElement('th');
                    th.textContent = headerText;
                    headerRow.appendChild(th);
                });
                
                thead.appendChild(headerRow);
                table.appendChild(thead);
                
                // ÂàõÂª∫Ë°®Ê†º‰∏ª‰Ωì
                const tbody = document.createElement('tbody');
                
                foundItems.forEach((item, index) => {
                    const mapKey = assistantMessageId + '_' + index;
                    state.assistantTodoMap[mapKey] = {
                        originalMessageId: item.id,
                        todoIndex: index
                    };
                    
                    const stateKey = `${item.id}_${index}`;
                    const isCompleted = state.assistantTodoStates[stateKey] || false;
                    
                    const row = document.createElement('tr');
                    row.dataset.mapKey = mapKey;
                    if (isCompleted) {
                        row.classList.add('completed');
                    }
                    
                    // Êó•ÊúüÂçïÂÖÉÊ†º
                    const dateCell = document.createElement('td');
                    dateCell.className = 'todo-date';
                    dateCell.textContent = item.date;
                    
                    // Ê†áËÆ∞ÂçïÂÖÉÊ†º
                    const tagCell = document.createElement('td');
                    tagCell.className = 'todo-tag';
                    tagCell.textContent = '[ÂæÖÂäû]';
                    
                    // ÂÜÖÂÆπÂçïÂÖÉÊ†º
                    const contentCell = document.createElement('td');
                    contentCell.className = 'todo-content';
                    contentCell.textContent = item.content;
                    if (isCompleted) {
                        contentCell.style.textDecoration = 'line-through';
                        contentCell.style.color = '#95a5a6';
                    }
                    
                    // Êìç‰ΩúÂçïÂÖÉÊ†ºÔºàÂãæÈÄâÊ°ÜÔºâ
                    const actionCell = document.createElement('td');
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.className = 'todo-checkbox';
                    checkbox.checked = isCompleted;
                    actionCell.appendChild(checkbox);
                    
                    row.appendChild(dateCell);
                    row.appendChild(tagCell);
                    row.appendChild(contentCell);
                    row.appendChild(actionCell);
                    
                    tbody.appendChild(row);
                });
                
                table.appendChild(tbody);
                tableContainer.appendChild(table);
                
                // Ê∑ªÂä†‰øùÂ≠òÊåâÈíÆ
                const saveButton = document.createElement('button');
                saveButton.className = 'save-todo-btn';
                saveButton.textContent = '‰øùÂ≠òÂãæÈÄâÁä∂ÊÄÅ';
                tableContainer.appendChild(saveButton);
                
                // Ê∑ªÂä†Âà∞ËÅäÂ§©ÂÆπÂô®‰∏≠Ôºà‰ΩÜ‰∏ç‰øùÂ≠òÂà∞Ê∂àÊÅØËÆ∞ÂΩïÔºâ
                chatContainer.appendChild(tableContainer);
                
                // ËÆ∞ÂΩïË°®Ê†ºÊ∂àÊÅØIDÔºåÁî®‰∫éÂà∑Êñ∞Êó∂Ê∏ÖÁêÜ
                state.assistantTodoTableMessages[assistantMessageId] = true;
            }
            
            saveToLocalStorage();
            scrollToBottom();
        }

        // Ê†ºÂºèÂåñÊó•Êúü
        function formatDate(date) {
            const d = new Date(date);
            const year = d.getFullYear();
            const month = (d.getMonth() + 1).toString().padStart(2, '0');
            const day = d.getDate().toString().padStart(2, '0');
            return `${year}/${month}/${day}`;
        }

        // ÊòæÁ§∫Á°ÆËÆ§ÂØπËØùÊ°Ü
        function showConfirmDialog(title, message, callback, noCancel = false) {
            confirmTitle.textContent = title;
            confirmMessage.textContent = message;
            confirmDialog.classList.add('show');
            menuOverlay.classList.add('show');
            
            confirmDialog.dataset.callback = callback ? 'true' : 'false';
            if (callback) {
                confirmDialog.callback = callback;
            }
            
            if (noCancel) {
                cancelConfirmBtn.style.display = 'none';
                confirmBtn.textContent = 'Á°ÆÂÆö';
            } else {
                cancelConfirmBtn.style.display = 'block';
                confirmBtn.textContent = 'Á°ÆËÆ§';
            }
        }

        // Â§ÑÁêÜÁ°ÆËÆ§Êìç‰Ωú
        function handleConfirmAction() {
            if (confirmDialog.callback) {
                confirmDialog.callback();
            }
            closeConfirmDialog();
        }

        // ÂÖ≥Èó≠Á°ÆËÆ§ÂØπËØùÊ°Ü
        function closeConfirmDialog() {
            confirmDialog.classList.remove('show');
            menuOverlay.classList.remove('show');
            confirmDialog.callback = null;
            cancelConfirmBtn.style.display = 'block';
            confirmBtn.textContent = 'Á°ÆËÆ§';
        }

        // Êõ¥Êñ∞Ê¶ÇÁéáÊòæÁ§∫
        function updateProbabilityDisplay() {
            const probabilityValue = document.getElementById('probabilityValue');
            if (probabilityValue) {
                probabilityValue.textContent = state.autoReplyProbability + '%';
            }
        }

        // ÊâìÂºÄÈáçÂëΩÂêçÂØπËØùÊ°Ü
        function openRenameDialog(currentName, tabId) {
            renameInput.value = currentName;
            renameDialog.dataset.tabId = tabId;
            renameDialog.classList.add('show');
            menuOverlay.classList.add('show');
            setTimeout(() => {
                renameInput.focus();
                renameInput.select();
            }, 100);
        }

        // ‰øùÂ≠òÈáçÂëΩÂêç
        function saveRename() {
            const newName = renameInput.value.trim();
            const tabId = parseInt(renameDialog.dataset.tabId);
            
            if (newName && tabId) {
                const tabIndex = state.tabs.findIndex(t => t.id === tabId);
                if (tabIndex !== -1) {
                    state.tabs[tabIndex].name = newName;
                    if (state.tabs[tabIndex].id === state.currentTabId) {
                        currentTabName.textContent = newName;
                    }
                    updateTabsList();
                    saveToLocalStorage();
                }
            }
            closeRenameDialog();
        }

        // ÂÖ≥Èó≠ÈáçÂëΩÂêçÂØπËØùÊ°Ü
        function closeRenameDialog() {
            renameDialog.classList.remove('show');
            menuOverlay.classList.remove('show');
            delete renameDialog.dataset.tabId;
        }

        // ÊâìÂºÄÂä©ÊâãÂêçÁß∞ÂØπËØùÊ°Ü
        function openAssistantDialog() {
            assistantInput.value = state.assistantName;
            assistantDialog.classList.add('show');
            menuOverlay.classList.add('show');
        }

        // ‰øùÂ≠òÂä©ÊâãÂêçÁß∞
        function saveAssistantName() {
            const newName = assistantInput.value.trim();
            if (newName) {
                const oldName = state.assistantName;
                state.assistantName = newName;
                
                const currentTab = state.tabs.find(t => t.id === state.currentTabId);
                if (currentTab) {
                    currentTab.messages.forEach(message => {
                        if (!message.isSelf && message.username === oldName) {
                            message.username = newName;
                        }
                    });
                }
                
                renderMessages();
                saveToLocalStorage();
                closeAssistantDialog();
                showConfirmDialog('‰øÆÊîπÊàêÂäü', 'Âä©ÊâãÂêçÁß∞Â∑≤‰øÆÊîπÔºÅ', null, true);
            }
        }

        // ÂÖ≥Èó≠Âä©ÊâãÂêçÁß∞ÂØπËØùÊ°Ü
        function closeAssistantDialog() {
            assistantDialog.classList.remove('show');
            menuOverlay.classList.remove('show');
        }

        // ÊòæÁ§∫Ê∏ÖÈô§ÁºìÂ≠òÁ°ÆËÆ§
        function showClearCacheConfirm() {
            showConfirmDialog('Ê∏ÖÈô§ÊâÄÊúâËÆæÂÆö', 'Á°ÆÂÆöË¶ÅÊ∏ÖÈô§ÊâÄÊúâÁî®Êà∑ËÆæÂÆöÂíåÁºìÂ≠òÂêóÔºüÊ≠§Êìç‰ΩúÂ∞ÜÈáçÁΩÆÊâÄÊúâËÆæÁΩÆÂπ∂Ê∏ÖÁ©∫ÁºìÂ≠òÊï∞ÊçÆÔºÅ', () => {
                // Ê∏ÖÈô§localStorage
                localStorage.clear();
                localStorage.removeItem('voice_model_downloaded');
                
                // ÈáçÁΩÆÁä∂ÊÄÅÂà∞ÂàùÂßãÂÄº
                state.username = 'Êàë';
                state.assistantName = 'Âä©Êâã';
                state.tabs = [
                    { id: 1, name: 'ËÅäÂ§©1', messages: [], active: true, pinned: false },
                    { id: 2, name: 'ËÅäÂ§©2', messages: [], active: false, pinned: false },
                    { id: 3, name: 'ËÅäÂ§©3', messages: [], active: false, pinned: false }
                ];
                state.currentTabId = 1;
                state.autoReplyProbability = 70;
                state.autoReplies = [
                    "Êî∂Âà∞ÔºÅÂ∑≤ËÆ∞ÂΩï„ÄÇ",
                    "ÊòéÁôΩÔºåÁªßÁª≠ËØ¥Âêß„ÄÇ",
                    "Â•ΩÁöÑÔºåÊàëÂú®Âê¨„ÄÇ",
                    "ÂóØÔºåÊúâÈÅìÁêÜ„ÄÇ",
                    "ÊòØÁöÑÔºåÊàëÂêåÊÑè„ÄÇ",
                    "ÂóØÂóØÔºå‰∫ÜËß£‰∫Ü„ÄÇ",
                    "Ëøô‰∏™ÊÉ≥Ê≥ï‰∏çÈîôÔºÅ",
                    "ÁªßÁª≠ÔºåÊàëÂú®ËÆ∞ÂΩï„ÄÇ",
                    "Â•ΩÁöÑÔºåËøòÊúâ‰ªÄ‰πàË¶ÅË°•ÂÖÖÁöÑÂêóÔºü",
                    "Â∑≤Êî∂Âà∞ÔºåËØ∑ÁªßÁª≠„ÄÇ"
                ];
                state.completedTodos = {};
                state.assistantTodoMap = {};
                state.assistantTodoStates = {};
                state.assistantTodoTableMessages = {};
                state.settings = {
                    sendKey: 'enter',
                    theme: 'light',
                    fontSize: 16
                };
                
                // Êõ¥Êñ∞UI
                updateCurrentTab();
                updateTabsList();
                renderMessages();
                updateSendKeyDisplay();
                updateFontSizeDisplay();
                applyFontSizeToBubbles();
                
                // ÈáçÁΩÆ‰∏ªÈ¢òÂà∞ÊµÖËâ≤
                if (state.settings.theme === 'dark') {
                    toggleTheme();
                }
                
                showConfirmDialog('Êìç‰ΩúÊàêÂäü', 'ÊâÄÊúâÁî®Êà∑ËÆæÂÆöÂíåÁºìÂ≠òÂ∑≤Ê∏ÖÈô§ÔºÅ', null, true);
            });
        }

// ÊòæÁ§∫ÂØºÂá∫ÈÄâÈ°πÂØπËØùÊ°Ü
function showExportInfo() {
    closeSettingsMenu();
    
    // ÂàõÂª∫Ëá™ÂÆö‰πâÂØºÂá∫ÂØπËØùÊ°Ü
    const exportDialog = document.createElement('div');
    exportDialog.className = 'confirm-dialog';
    exportDialog.id = 'exportDialog';
    exportDialog.style.display = 'block';
    exportDialog.innerHTML = `
        <div class="dialog-header">
            <div class="dialog-title">ÂØºÂá∫ËÅäÂ§©ËÆ∞ÂΩï</div>
            <div class="dialog-text">ÈÄâÊã©ÂØºÂá∫ÈÄâÈ°π</div>
        </div>
        <div style="padding: 20px;">
            <div class="export-option" style="margin-bottom: 15px;">
                <input type="radio" id="exportAll" name="exportOption" checked>
                <label for="exportAll" style="margin-left: 10px; cursor: pointer;">
                    <strong>ÂØºÂá∫ÊâÄÊúâÊ†áÁ≠æ</strong><br>
                    <span style="font-size: 13px; color: #7f8c8d;">ÂåÖÂê´ÊâÄÊúâÊ†áÁ≠æÁöÑÂÆåÊï¥ËÅäÂ§©ËÆ∞ÂΩï</span>
                </label>
            </div>
            <div class="export-option">
                <input type="radio" id="exportCurrent" name="exportOption">
                <label for="exportCurrent" style="margin-left: 10px; cursor: pointer;">
                    <strong>‰ªÖÂØºÂá∫ÂΩìÂâçÊ†áÁ≠æ</strong><br>
                    <span style="font-size: 13px; color: #7f8c8d;">‰ªÖÂØºÂá∫"${state.tabs.find(t => t.id === state.currentTabId)?.name || 'ÂΩìÂâçÊ†áÁ≠æ'}"</span>
                </label>
            </div>
            <div class="progress-container" id="exportProgress" style="display: none; margin-top: 20px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                    <span>Ê≠£Âú®ÂØºÂá∫...</span>
                    <span id="progressPercent">0%</span>
                </div>
                <div style="width: 100%; height: 8px; background-color: #ecf0f1; border-radius: 4px; overflow: hidden;">
                    <div id="progressBar" style="width: 0%; height: 100%; background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%); transition: width 0.3s ease;"></div>
                </div>
            </div>
        </div>
        <div class="dialog-actions" style="padding: 0 24px 24px;">
            <button class="dialog-btn cancel" id="cancelExportBtn">ÂèñÊ∂à</button>
            <button class="dialog-btn save" id="confirmExportBtn">ÂºÄÂßãÂØºÂá∫</button>
        </div>
    `;
    
    // Ê∑ªÂä†Âà∞È°µÈù¢
    document.body.appendChild(exportDialog);
    menuOverlay.classList.add('show');
    
    // Ê∑ªÂä†‰∫ã‰ª∂ÁõëÂê¨
    document.getElementById('cancelExportBtn').addEventListener('click', () => {
        document.body.removeChild(exportDialog);
        menuOverlay.classList.remove('show');
    });
    
    document.getElementById('confirmExportBtn').addEventListener('click', () => {
        const exportAll = document.getElementById('exportAll').checked;
        startExport(exportAll, exportDialog);
    });
}

// ÂºÄÂßãÂØºÂá∫
function startExport(exportAll, exportDialog) {
    const progressContainer = document.getElementById('exportProgress');
    const progressBar = document.getElementById('progressBar');
    const progressPercent = document.getElementById('progressPercent');
    
    // ÊòæÁ§∫ËøõÂ∫¶Êù°
    progressContainer.style.display = 'block';
    
    // Á¶ÅÁî®ÊåâÈíÆ
    document.getElementById('confirmExportBtn').disabled = true;
    document.getElementById('cancelExportBtn').disabled = true;
    
    // Ê®°ÊãüËøõÂ∫¶Êõ¥Êñ∞
    let progress = 0;
    const progressInterval = setInterval(() => {
        progress += 10;
        progressBar.style.width = progress + '%';
        progressPercent.textContent = progress + '%';
        
        if (progress >= 100) {
            clearInterval(progressInterval);
            // ÊâßË°åÂÆûÈôÖÂØºÂá∫
            exportToExcel(exportAll, exportDialog);
        }
    }, 100);
}

// ÂØºÂá∫‰∏∫ExcelÊñá‰ª∂ÔºàÂ¢ûÂº∫ÁâàÔºâ
function exportToExcel(exportAll = true, exportDialog = null) {
    try {
        // ÂàõÂª∫Â∑•‰ΩúÁ∞ø
        const wb = XLSX.utils.book_new();
        
        // Á°ÆÂÆöË¶ÅÂØºÂá∫ÁöÑÊ†áÁ≠æ
        const tabsToExport = exportAll ? state.tabs : [state.tabs.find(t => t.id === state.currentTabId)].filter(Boolean);
        
        let totalMessages = 0;
        tabsToExport.forEach(tab => {
            if (tab && tab.messages) {
                totalMessages += tab.messages.length;
            }
        });
        
        if (totalMessages === 0) {
            if (exportDialog) {
                document.body.removeChild(exportDialog);
                menuOverlay.classList.remove('show');
            }
            showConfirmDialog('ÂØºÂá∫Â§±Ë¥•', 'Ê≤°ÊúâËÅäÂ§©ËÆ∞ÂΩïÂèØÂØºÂá∫ÔºÅ', null, true);
            return;
        }
        
        // ‰∏∫ÊØè‰∏™Ê†áÁ≠æÂàõÂª∫‰∏Ä‰∏™Â∑•‰ΩúË°®
        tabsToExport.forEach((tab, index) => {
            if (!tab || tab.messages.length === 0) return;
            
            // ÂáÜÂ§áÊï∞ÊçÆË°å
            const data = [];
            
            // Ê∑ªÂä†Ë°®Â§¥ÔºàÂ∏¶Ê†∑ÂºèÊ†áËÆ∞Ôºâ
            data.push(['Áî®Êà∑Âêç', 'Êó∂Èó¥', 'ÂÜÖÂÆπ', 'Ê†áÁ≠æ', 'Ê∂àÊÅØÁ±ªÂûã', 'Áä∂ÊÄÅ']);
            
            // Ê∑ªÂä†Ê∂àÊÅØÊï∞ÊçÆ
            tab.messages.forEach(message => {
                const time = new Date(message.time);
                const formattedTime = time.toLocaleString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: false
                }).replace(/\//g, '-');
                
                // Ê∏ÖÁêÜÂÜÖÂÆπ
                const cleanContent = cleanMessageContent(message.content);
                
                // Âà§Êñ≠Ê∂àÊÅØÁ±ªÂûã
                let messageType = 'ÊôÆÈÄöÊ∂àÊÅØ';
                if (message.content.includes('[ÈáçË¶Å]')) {
                    messageType = 'ÈáçË¶ÅÊ∂àÊÅØ';
                } else if (message.content.includes('[ÂæÖÂäû]') || message.content.includes('[ÂæÖÂäûÂÆåÊàê]')) {
                    messageType = 'ÂæÖÂäû‰∫ãÈ°π';
                }
                
                // Âà§Êñ≠Áä∂ÊÄÅ
                let status = message.isSelf ? 'Ëá™Â∑±ÂèëÈÄÅ' : 'Âä©ÊâãÂõûÂ§ç';
                if (message.content.includes('[ÂæÖÂäûÂÆåÊàê]')) {
                    status = 'Â∑≤ÂÆåÊàê';
                } else if (message.content.includes('[ÂæÖÂäû]')) {
                    status = 'ÂæÖÂäû‰∏≠';
                }
                
                data.push([
                    message.username,
                    formattedTime,
                    cleanContent,
                    tab.name,
                    messageType,
                    status
                ]);
            });
            
            // ÂàõÂª∫Â∑•‰ΩúË°®
            const ws = XLSX.utils.aoa_to_sheet(data);
            
            // ËÆæÁΩÆÂàóÂÆΩ
            const colWidths = [
                { wch: 12 }, // Áî®Êà∑Âêç
                { wch: 20 }, // Êó∂Èó¥
                { wch: 60 }, // ÂÜÖÂÆπ
                { wch: 12 }, // Ê†áÁ≠æ
                { wch: 12 }, // Ê∂àÊÅØÁ±ªÂûã
                { wch: 10 }  // Áä∂ÊÄÅ
            ];
            ws['!cols'] = colWidths;
            
            // Ê∑ªÂä†Â∑•‰ΩúË°®Âà∞Â∑•‰ΩúÁ∞ø
            const sheetName = tab.name
                .replace(/[\\\/:*?"<>|]/g, '_')
                .substring(0, 30) || `Ê†áÁ≠æ${tab.id}`;
            XLSX.utils.book_append_sheet(wb, ws, sheetName);
        });
        
        // ÁîüÊàêÊñá‰ª∂Âêç
        const now = new Date();
        const timestamp = now.toLocaleString('zh-CN', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit',
            hour12: false
        }).replace(/[\/:\s]/g, '').replace(/[Âπ¥ÊúàÊó•Êó∂ÂàÜÁßí]/g, '');
        
        const filename = `${state.username}ÁöÑËÅäÂ§©ËÆ∞ÂΩï${timestamp}.xlsx`;
        
        // ÂØºÂá∫Êñá‰ª∂
        XLSX.writeFile(wb, filename);
        
        // Ê∏ÖÁêÜÂØπËØùÊ°Ü
        if (exportDialog) {
            document.body.removeChild(exportDialog);
            menuOverlay.classList.remove('show');
        }
        
        // ÊòæÁ§∫ÊàêÂäüÊèêÁ§∫
        showConfirmDialog('ÂØºÂá∫ÊàêÂäü', 
            `‚úì ËÅäÂ§©ËÆ∞ÂΩïÂØºÂá∫ÂÆåÊàêÔºÅ\n\n` +
            `Êñá‰ª∂ÂêçÔºö${filename}\n` +
            `ÂØºÂá∫Ê†áÁ≠æÔºö${tabsToExport.filter(t => t.messages.length > 0).length}‰∏™\n` +
            `ÊÄªÊ∂àÊÅØÊï∞Ôºö${totalMessages}Êù°\n\n` +
            `Êñá‰ª∂Â∑≤‰øùÂ≠òÂà∞ÊÇ®ÁöÑ‰∏ãËΩΩÊñá‰ª∂Â§π`, 
            null, true);
        
    } catch (error) {
        console.error('ÂØºÂá∫Â§±Ë¥•:', error);
        
        // Ê∏ÖÁêÜÂØπËØùÊ°Ü
        if (exportDialog) {
            document.body.removeChild(exportDialog);
            menuOverlay.classList.remove('show');
        }
        
        showConfirmDialog('ÂØºÂá∫Â§±Ë¥•', 
            `ÂØºÂá∫ËøáÁ®ã‰∏≠Âá∫Áé∞ÈîôËØØÔºö\n${error.message}\n\n` +
            `Âª∫ËÆÆÔºö\n` +
            `1. Á°Æ‰øùÊµèËßàÂô®ÂÖÅËÆ∏‰∏ãËΩΩÊñá‰ª∂\n` +
            `2. Ê£ÄÊü•ÊòØÂê¶ÊúâË∂≥Â§üÁöÑÂ≠òÂÇ®Á©∫Èó¥\n` +
            `3. Â¶ÇÊûúÈóÆÈ¢òÊåÅÁª≠ÔºåËØ∑Â∞ùËØïÂà∑Êñ∞È°µÈù¢`, 
            null, true);
    }
}

// Ê∏ÖÁêÜÊ∂àÊÅØÂÜÖÂÆπÁöÑËæÖÂä©ÂáΩÊï∞
function cleanMessageContent(content) {
    return content
        .replace(/<br\s*\/?>/gi, '\n')  // ÊõøÊç¢Êç¢Ë°åÁ¨¶
        .replace(/<[^>]*>/g, '')        // ÁßªÈô§HTMLÊ†áÁ≠æ
        // ÁßªÈô§Ê†ºÂºèÊ†áÁ≠æ
        .replace(/\[b\](.*?)\[\/b\]/g, '$1')
        .replace(/\[i\](.*?)\[\/i\]/g, '$1')
        .replace(/\[u\](.*?)\[\/u\]/g, '$1')
        .replace(/\[s\](.*?)\[\/s\]/g, '$1')
        // ÁßªÈô§ÁâπÊÆäÊ†áËÆ∞
        .replace(/\[ÈáçË¶Å\]/g, '')
        .replace(/\[ÂæÖÂäû\]/g, '')
        .replace(/\[ÂæÖÂäûÂÆåÊàê\]/g, '')
        .replace(/\n{3,}/g, '\n\n')     // ÂêàÂπ∂Â§ö‰∏™Á©∫Ë°å
        .trim();
}

function showAboutInfo() {
    showConfirmDialog('ÂÖ≥‰∫é', '', null, true);
    confirmMessage.innerHTML = 'KwenbinÁöÑËÅäÂ§©ÂºèËÆ∞‰∫ãÊú¨<br>ÁâàÊú¨v1.0.0<br>¬© 2026<br><br>' +
        '<a href="help.html" style="color: #3498db; text-decoration: none; display: inline-block; margin-top: 10px; padding: 8px 16px; background: #f0f7ff; border-radius: 20px; font-weight: 600;">' +
        '<i class="fas fa-question-circle"></i> Êü•ÁúãËØ¶ÁªÜÂ∏ÆÂä©ÊñáÊ°£</a>';
    confirmBtn.textContent = 'Á°ÆÂÆö';
}

        // Ê†πÊçÆIDÊü•ÊâæÊ∂àÊÅØ
        function findMessageById(id) {
            const currentTab = state.tabs.find(t => t.id === state.currentTabId);
            if (!currentTab) return null;
            return currentTab.messages.find(m => m.id === id);
        }

        // Â§ÑÁêÜËæìÂÖ•ÂèòÂåñ
        function handleInputChange() {
            adjustInputHeight();
            
            if (messageInput.value.trim().length > 0) {
                sendBtn.classList.add('show');
            } else {
                sendBtn.classList.remove('show');
            }
        }

        // Â§ÑÁêÜËæìÂÖ•Ê°ÜËÅöÁÑ¶
        function handleInputFocus() {
            messageInput.classList.add('focused');
        }

        // Â§ÑÁêÜËæìÂÖ•Ê°ÜÂ§±ÁÑ¶
        function handleInputBlur() {
            messageInput.classList.remove('focused');
            inputContainer.classList.remove('keyboard-open');
        }

        // Â§ÑÁêÜÁ™óÂè£Â§ßÂ∞èÂèòÂåñ
        function handleResize() {
            if (window.visualViewport) {
                if (window.visualViewport.height < window.innerHeight * 0.7) {
                    inputContainer.classList.add('keyboard-open');
                } else {
                    inputContainer.classList.remove('keyboard-open');
                }
            }
        }

        // Ë∞ÉÊï¥ËæìÂÖ•Ê°ÜÈ´òÂ∫¶
        function adjustInputHeight() {
            messageInput.style.height = 'auto';
            const newHeight = Math.min(messageInput.scrollHeight, 200);
            messageInput.style.height = newHeight + 'px';
        }

        // Â§ÑÁêÜÈîÆÁõòÊåâÈîÆ - ‰øÆÂ§çÔºöÊ†πÊçÆËÆæÁΩÆÂ§ÑÁêÜEnterÈîÆ
        function handleKeyDown(event) {
            if (window.isComposing) return;
            
            // Ê†πÊçÆËÆæÁΩÆÂà§Êñ≠ÂèëÈÄÅÊñπÂºè
            if (state.settings.sendKey === 'enter') {
                // Enter ÂèëÈÄÅÔºåShift+Enter Êç¢Ë°å
                if (event.key === 'Enter' && !event.shiftKey) {
                    event.preventDefault();
                    sendMessage();
                }
                // Shift+Enter Ëá™Âä®Êç¢Ë°åÔºåÊó†ÈúÄÁâπÊÆäÂ§ÑÁêÜ
            } else {
                // Shift+Enter ÂèëÈÄÅÔºåEnter Êç¢Ë°å
                if (event.key === 'Enter' && event.shiftKey) {
                    event.preventDefault();
                    sendMessage();
                }
                // Enter Ëá™Âä®Êç¢Ë°åÔºåÊó†ÈúÄÁâπÊÆäÂ§ÑÁêÜ
            }
        }

// ÂèëÈÄÅÊ∂àÊÅØ
function sendMessage() {
    const content = messageInput.value.trim();
    
    if (!content) {
        showConfirmDialog('ÊèêÁ§∫', 'ËØ∑ËæìÂÖ•ÂÜÖÂÆπÔºÅ', null, true);
        return;
    }
    
    const now = new Date();
    const message = {
        id: Date.now(),
        username: state.username,
        content: content,
        time: now,
        isSelf: true,
        formattedTime: formatTime(now)
    };
    
    const currentTab = state.tabs.find(t => t.id === state.currentTabId);
    if (currentTab) {
        currentTab.messages.push(message);
    }
    
    state.messages.push(message);
    
    addMessageToChat(message);
    
    messageInput.value = '';
    adjustInputHeight();
    sendBtn.classList.remove('show');
    
    emptyState.style.display = 'none';
    
    scrollToBottom();
    
    saveToLocalStorage();
    
    // Á≤æÁ°ÆÊ£ÄÊü•ÊòØÂê¶ÊòØ"Â∏ÆÂä©"‰∫åÂ≠ó
    if (content === 'Â∏ÆÂä©') {
        setTimeout(() => {
            generateHelpReply();
        }, 1000);
    } else if (Math.random() * 100 < state.autoReplyProbability && state.autoReplies.length > 0) {
        setTimeout(() => {
            generateAutoReply(content);
        }, 1000 + Math.random() * 1000);
    }
}

// ÁîüÊàêÂ∏ÆÂä©ÂõûÂ§ç - ÁÆÄÂçïÁâàÊú¨Ôºà‰øÆÊîπ‰∏∫ÂΩìÂâçÈ°µÈù¢Ë∑≥ËΩ¨Ôºâ
function generateHelpReply() {
    const currentTab = state.tabs.find(t => t.id === state.currentTabId);
    if (!currentTab) return;
    
    const now = new Date();
    const helpMessage = {
        id: Date.now() + 1,
        username: state.assistantName,
        content: 'üìñ ÁÇπÂáª‰∏ãÊñπÈìæÊé•Êü•ÁúãÂÆåÊï¥Â∏ÆÂä©ÊñáÊ°£Ôºö\n' +
                '<div style="text-align: center; margin: 15px 0;">' +
                '<a href="help.html" style="color: white; text-decoration: none; display: inline-block; padding: 12px 24px; background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); border-radius: 25px; font-weight: 600; font-size: 16px; box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3); transition: all 0.2s ease; cursor: pointer;" onclick="window.location.href=\'help.html\'">' +
                '<i class="fas fa-book" style="margin-right: 8px;"></i>ÊâìÂºÄÂ∏ÆÂä©ÊñáÊ°£</a>' +
                '</div>' +
                'Â∏ÆÂä©ÊñáÊ°£ÂåÖÂê´Ôºö\n' +
                '‚Ä¢ ‰ΩøÁî®ÊïôÁ®ã\n' +
                '‚Ä¢ ÂäüËÉΩËØ¥Êòé\n' +
                '‚Ä¢ Â∏∏ËßÅÈóÆÈ¢ò\n' +
                '‚Ä¢ ‰ΩøÁî®ÊäÄÂ∑ß\n' +
                '<div style="font-size: 14px; color: #7f8c8d; margin-top: 10px;">' +
                '<i class="fas fa-info-circle" style="color: #3498db; margin-right: 5px;"></i>ÁÇπÂáªÂêéÂ∞ÜÂú®ÂΩìÂâçÈ°µÈù¢Ë∑≥ËΩ¨Âà∞Â∏ÆÂä©ÊñáÊ°£' +
                '</div>',
        time: now,
        isSelf: false,
        formattedTime: formatTime(now)
    };
    
    currentTab.messages.push(helpMessage);
    state.messages.push(helpMessage);
    
    addMessageToChat(helpMessage);
    
    scrollToBottom();
    saveToLocalStorage();
}

        // ÁîüÊàêËá™Âä®ÂõûÂ§ç
        function generateAutoReply(userMessage) {
            const randomIndex = Math.floor(Math.random() * state.autoReplies.length);
            const replyContent = state.autoReplies[randomIndex];
            
            const now = new Date();
            const autoReplyMessage = {
                id: Date.now() + 1,
                username: state.assistantName,
                content: replyContent,
                time: now,
                isSelf: false,
                formattedTime: formatTime(now)
            };
            
            const currentTab = state.tabs.find(t => t.id === state.currentTabId);
            if (currentTab) {
                currentTab.messages.push(autoReplyMessage);
            }
            
            state.messages.push(autoReplyMessage);
            
            addMessageToChat(autoReplyMessage);
            
            scrollToBottom();
            saveToLocalStorage();
        }

        // Ê∑ªÂä†Ê∂àÊÅØÂà∞ËÅäÂ§©ÁïåÈù¢
        function addMessageToChat(message) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${message.isSelf ? 'self' : 'other'}`;
            messageDiv.dataset.messageId = message.id;
            
            const messageHeader = document.createElement('div');
            messageHeader.className = 'message-header';
            
            const username = document.createElement('span');
            username.className = 'username';
            username.textContent = message.username;
            
            const messageTime = document.createElement('span');
            messageTime.className = 'message-time';
            messageTime.textContent = message.formattedTime;
            
            if (message.isSelf) {
                messageHeader.appendChild(messageTime);
                messageHeader.appendChild(document.createTextNode(' '));
                messageHeader.appendChild(username);
            } else {
                messageHeader.appendChild(username);
                messageHeader.appendChild(document.createTextNode(' '));
                messageHeader.appendChild(messageTime);
            }
            
            const bubble = document.createElement('div');
            bubble.className = 'bubble';
            
            // Â∫îÁî®Â≠ó‰ΩìÂ§ßÂ∞è
            bubble.style.fontSize = state.settings.fontSize + 'px';
            
            if (message.content.includes('[ÈáçË¶Å]')) {
                bubble.classList.add('important');
            }
            
            if (message.content.includes('[ÂæÖÂäû]')) {
                bubble.classList.add('todo-pending');
            } else if (message.content.includes('[ÂæÖÂäûÂÆåÊàê]')) {
                bubble.classList.add('todo-completed');
            }
            
            bubble.innerHTML = formatMessageContent(message.content);
            
            messageDiv.appendChild(messageHeader);
            messageDiv.appendChild(bubble);
            
            chatContainer.appendChild(messageDiv);
        }

        // Ê†ºÂºèÂåñÊ∂àÊÅØÂÜÖÂÆπ
        function formatMessageContent(content) {
            let formatted = content.replace(/\n/g, '<br>');
            
            formatted = formatted
                .replace(/\[b\](.*?)\[\/b\]/g, '<strong>$1</strong>')
                .replace(/\[i\](.*?)\[\/i\]/g, '<em>$1</em>')
                .replace(/\[u\](.*?)\[\/u\]/g, '<u>$1</u>')
                .replace(/\[s\](.*?)\[\/s\]/g, '<s>$1</s>')
                .replace(/\[ÈáçË¶Å\] /g, '<span style="color:#e74c3c;font-weight:bold;">[ÈáçË¶Å] </span>')
                .replace(/\[ÂæÖÂäû\] /g, '<span style="color:#2ecc71;font-weight:bold;">[ÂæÖÂäû] </span>')
                .replace(/\[ÂæÖÂäûÂÆåÊàê\] /g, '<span style="color:#27ae60;font-weight:bold;">[Â∑≤ÂÆåÊàê] </span>');
          // Â¶ÇÊûúÊòØÂ∑≤ÂÆåÊàêÁä∂ÊÄÅÔºåÊ∑ªÂä†Âà†Èô§Á∫øÊ†∑Âºè
         if (content.includes('[ÂæÖÂäûÂÆåÊàê]')) {
        formatted = formatted.replace(/<span style="color:#27ae60;font-weight:bold;">\[Â∑≤ÂÆåÊàê\] <\/span>(.*)/, 
            '<span style="color:#27ae60;font-weight:bold;">[Â∑≤ÂÆåÊàê] </span><span style="text-decoration: line-through; opacity: 0.8;">$1</span>');
        }            
            return formatted;
        }

        // Ê†ºÂºèÂåñÊó∂Èó¥
        function formatTime(date) {
            const now = new Date();
            const messageDate = new Date(date);
            
            if (messageDate.toDateString() === now.toDateString()) {
                return messageDate.toLocaleTimeString('zh-CN', { 
                    hour: '2-digit', 
                    minute: '2-digit',
                    hour12: false
                });
            }
            
            const month = messageDate.getMonth() + 1;
            const day = messageDate.getDate();
            const hours = messageDate.getHours().toString().padStart(2, '0');
            const minutes = messageDate.getMinutes().toString().padStart(2, '0');
            
            return `${month}/${day} ${hours}:${minutes}`;
        }

        // Ê∏≤ÊüìÊâÄÊúâÊ∂àÊÅØ
        function renderMessages() {
            chatContainer.innerHTML = '';
            
            const currentTab = state.tabs.find(t => t.id === state.currentTabId);
            if (!currentTab || currentTab.messages.length === 0) {
                emptyState.style.display = 'flex';
                return;
            }
            
            emptyState.style.display = 'none';
            
            let lastDate = null;
            currentTab.messages.forEach((message, index) => {
                const messageDate = new Date(message.time).toDateString();
                
                if (lastDate !== messageDate) {
                    const timeDivider = document.createElement('div');
                    timeDivider.className = 'time-divider';
                    
                    const timeText = document.createElement('div');
                    timeText.className = 'time-text';
                    
                    const now = new Date();
                    const today = now.toDateString();
                    const yesterday = new Date(now.setDate(now.getDate() - 1)).toDateString();
                    
                    if (messageDate === today) {
                        timeText.textContent = '‰ªäÂ§©';
                    } else if (messageDate === yesterday) {
                        timeText.textContent = 'Êò®Â§©';
                    } else {
                        const date = new Date(message.time);
                        timeText.textContent = `${date.getMonth() + 1}/${date.getDate()}`;
                    }
                    
                    timeDivider.appendChild(timeText);
                    chatContainer.appendChild(timeDivider);
                    
                    lastDate = messageDate;
                }
                
                addMessageToChat(message);
            });
            
            scrollToBottom();
        }

        // ÊªöÂä®Âà∞Â∫ïÈÉ®
        function scrollToBottom() {
            setTimeout(() => {
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }, 100);
        }

        // ÊèíÂÖ•Ê†ºÂºèÂåñÊ†áÁ≠æ
        function insertFormatting(startTag, endTag) {
            const start = messageInput.selectionStart;
            const end = messageInput.selectionEnd;
            
            if (start !== end) {
                const selectedText = messageInput.value.substring(start, end);
                messageInput.value = messageInput.value.substring(0, start) + startTag + selectedText + endTag + messageInput.value.substring(end);
                messageInput.setSelectionRange(start + startTag.length, end + startTag.length);
            } else {
                messageInput.value = messageInput.value.substring(0, start) + startTag + endTag + messageInput.value.substring(end);
                messageInput.setSelectionRange(start + startTag.length, start + startTag.length);
            }
            
            messageInput.focus();
            handleInputChange();
        }

        // ÊèíÂÖ•ÊñáÊú¨
        function insertText(text) {
            const start = messageInput.selectionStart;
            const end = messageInput.selectionEnd;
            
            messageInput.value = messageInput.value.substring(0, start) + text + messageInput.value.substring(end);
            messageInput.focus();
            messageInput.setSelectionRange(start + text.length, start + text.length);
            
            handleInputChange();
        }

        // ÊâìÂºÄ‰æßÊªëËèúÂçï
        function openSideMenu() {
            sideMenu.classList.add('open');
            menuOverlay.classList.add('show');
        }

        // ÂÖ≥Èó≠‰æßÊªëËèúÂçï
        function closeSideMenu() {
            sideMenu.classList.remove('open');
            menuOverlay.classList.remove('show');
        }

        // ÊâìÂºÄËÆæÁΩÆËèúÂçï
        function openSettingsMenu() {
            settingsMenu.classList.add('open');
            menuOverlay.classList.add('show');
        }

        // ÂÖ≥Èó≠ËÆæÁΩÆËèúÂçï
        function closeSettingsMenu() {
            settingsMenu.classList.remove('open');
            menuOverlay.classList.remove('show');
        }

        // ÊâìÂºÄÁî®Êà∑ÂêçÂØπËØùÊ°Ü
        function openUsernameDialog() {
            usernameInput.value = state.username;
            usernameDialog.classList.add('show');
            menuOverlay.classList.add('show');
        }

        // ÂÖ≥Èó≠Áî®Êà∑ÂêçÂØπËØùÊ°Ü
        function closeUsernameDialog() {
            usernameDialog.classList.remove('show');
            menuOverlay.classList.remove('show');
        }

        // ‰øùÂ≠òÁî®Êà∑Âêç
        function saveUsername() {
            const newUsername = usernameInput.value.trim();
            if (newUsername) {
                state.username = newUsername;
                
                const currentTab = state.tabs.find(t => t.id === state.currentTabId);
                if (currentTab) {
                    currentTab.messages.forEach(message => {
                        if (message.isSelf) {
                            message.username = newUsername;
                        }
                    });
                }
                
                renderMessages();
                saveToLocalStorage();
                closeUsernameDialog();
                showConfirmDialog('‰øÆÊîπÊàêÂäü', 'Áî®Êà∑ÂêçÂ∑≤‰øÆÊîπÔºÅ', null, true);
            }
        }

        // Êõ¥Êñ∞ÂΩìÂâçÊ†áÁ≠æ
        function updateCurrentTab() {
            const currentTab = state.tabs.find(t => t.id === state.currentTabId);
            if (currentTab) {
                currentTabName.textContent = currentTab.name;
                state.messages = [...currentTab.messages];
            }
        }

        // Êõ¥Êñ∞Ê†áÁ≠æÂàóË°®
        function updateTabsList() {
            tabsList.innerHTML = '';
            
            const sortedTabs = [...state.tabs].sort((a, b) => {
                if (a.pinned && !b.pinned) return -1;
                if (!a.pinned && b.pinned) return 1;
                return a.id - b.id;
            });
            
            sortedTabs.forEach(tab => {
                const tabItem = document.createElement('div');
                tabItem.className = `tab-item ${tab.id === state.currentTabId ? 'active' : ''}`;
                tabItem.dataset.id = tab.id;
                
                const tabHeader = document.createElement('div');
                tabHeader.className = 'tab-item-header';
                
                const tabName = document.createElement('div');
                tabName.className = 'tab-name';
                tabName.textContent = tab.name;
                
                const tabActions = document.createElement('div');
                tabActions.className = 'tab-actions';
                
                // ÁΩÆÈ°∂ÊåâÈíÆ
                const pinBtn = document.createElement('button');
                pinBtn.className = `tab-action-btn pin ${tab.pinned ? 'active' : ''}`;
                pinBtn.title = tab.pinned ? 'ÂèñÊ∂àÁΩÆÈ°∂' : 'ÁΩÆÈ°∂';
                pinBtn.innerHTML = tab.pinned ? '<i class="fas fa-thumbtack"></i>' : '<i class="far fa-thumbtack"></i>';
                pinBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    togglePinTab(tab.id);
                });
                
                // ÈáçÂëΩÂêçÊåâÈíÆ
                const renameBtn = document.createElement('button');
                renameBtn.className = 'tab-action-btn rename';
                renameBtn.title = 'ÈáçÂëΩÂêç';
                renameBtn.innerHTML = '<i class="fas fa-edit"></i>';
                renameBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    openRenameDialog(tab.name, tab.id);
                });
                
                // Âà†Èô§ÊåâÈíÆ
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'tab-action-btn delete';
                deleteBtn.title = 'Âà†Èô§';
                deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    deleteTab(tab.id);
                });
                
                tabActions.appendChild(pinBtn);
                tabActions.appendChild(renameBtn);
                tabActions.appendChild(deleteBtn);
                
                tabHeader.appendChild(tabName);
                tabHeader.appendChild(tabActions);
                
                const tabPreview = document.createElement('div');
                tabPreview.className = 'tab-preview';
                
                if (tab.messages.length > 0) {
                    const lastMessage = tab.messages[tab.messages.length - 1];
                    let preview = lastMessage.content.replace(/\[.*?\]/g, '');
                    if (preview.length > 20) {
                        preview = preview.substring(0, 20) + '...';
                    }
                    tabPreview.textContent = preview;
                } else {
                    tabPreview.textContent = 'Á©∫ËÆ∞ÂΩï';
                }
                
                tabItem.appendChild(tabHeader);
                tabItem.appendChild(tabPreview);
                
                tabItem.addEventListener('click', () => {
                    document.querySelectorAll('.tab-item').forEach(item => {
                        item.classList.remove('active');
                    });
                    
                    tabItem.classList.add('active');
                    
                    state.currentTabId = tab.id;
                    updateCurrentTab();
                    renderMessages();
                    closeSideMenu();
                });
                
                tabsList.appendChild(tabItem);
            });
        }

        // ÂàáÊç¢ÁΩÆÈ°∂Áä∂ÊÄÅ
        function togglePinTab(tabId) {
            const tabIndex = state.tabs.findIndex(t => t.id === tabId);
            if (tabIndex !== -1) {
                state.tabs[tabIndex].pinned = !state.tabs[tabIndex].pinned;
                updateTabsList();
                saveToLocalStorage();
            }
        }

        // Âà†Èô§Ê†áÁ≠æ
        function deleteTab(tabId) {
            if (state.tabs.length <= 1) {
                showConfirmDialog('Êó†Ê≥ïÂà†Èô§', 'Ëá≥Â∞ëÈúÄË¶Å‰∏Ä‰∏™ËÅäÂ§©Ê†áÁ≠æÔºÅ', null, true);
                return;
            }
            
            const tab = state.tabs.find(t => t.id === tabId);
            if (!tab) return;
            
            showConfirmDialog('Âà†Èô§Ê†áÁ≠æ', `Á°ÆÂÆöË¶ÅÂà†Èô§Ê†áÁ≠æ"${tab.name}"ÂêóÔºüÊâÄÊúâÊ∂àÊÅØÂ∞ÜË¢´Âà†Èô§„ÄÇ`, () => {
                const tabIndex = state.tabs.findIndex(t => t.id === tabId);
                if (tabIndex !== -1) {
                    state.tabs.splice(tabIndex, 1);
                    
                    if (tabId === state.currentTabId) {
                        state.currentTabId = state.tabs[0].id;
                        updateCurrentTab();
                        renderMessages();
                    }
                    
                    updateTabsList();
                    saveToLocalStorage();
                }
            });
        }

        // ÂàõÂª∫Êñ∞Ê†áÁ≠æ
        function createNewTab() {
            const newTabId = Date.now();
            const newTab = {
                id: newTabId,
                name: `ËÅäÂ§© ${state.tabs.length + 1}`,
                messages: [],
                active: false,
                pinned: false
            };
            
            state.tabs.push(newTab);
            state.currentTabId = newTabId;
            
            updateCurrentTab();
            updateTabsList();
            renderMessages();
            
            closeSideMenu();
            
            saveToLocalStorage();
        }

        // ÂàáÊç¢‰∏ªÈ¢ò
        function toggleTheme() {
            if (state.settings.theme === 'light') {
                state.settings.theme = 'dark';
                document.body.style.backgroundColor = '#2c3e50';
                document.body.style.color = '#ffffff';
                document.querySelector('.top-bar').style.backgroundColor = '#34495e';
                document.querySelector('.top-bar').style.borderBottomColor = '#2c3e50';
                document.querySelector('.chat-container').style.backgroundColor = '#2c3e50';
                document.querySelector('.input-container').style.backgroundColor = '#34495e';
                document.querySelector('.input-container').style.borderTopColor = '#2c3e50';
                document.querySelector('.message-input').style.backgroundColor = '#34495e';
                document.querySelector('.message-input').style.color = '#ffffff';
                document.querySelector('.input-toolbar').style.borderTopColor = '#2c3e50';
                document.querySelectorAll('.format-btn').forEach(btn => {
                    btn.style.backgroundColor = '#2c3e50';
                    btn.style.color = '#ecf0f1';
                });
                
                showConfirmDialog('‰∏ªÈ¢òÂàáÊç¢', 'Â∑≤ÂàáÊç¢‰∏∫Ê∑±Ëâ≤‰∏ªÈ¢ò', null, true);
            } else {
                state.settings.theme = 'light';
                document.body.style.backgroundColor = '#f8f9fa';
                document.body.style.color = '#2c3e50';
                document.querySelector('.top-bar').style.backgroundColor = '#ffffff';
                document.querySelector('.top-bar').style.borderBottomColor = '#eaeaea';
                document.querySelector('.chat-container').style.backgroundColor = '#f8f9fa';
                document.querySelector('.input-container').style.backgroundColor = '#ffffff';
                document.querySelector('.input-container').style.borderTopColor = '#eaeaea';
                document.querySelector('.message-input').style.backgroundColor = '#ffffff';
                document.querySelector('.message-input').style.color = '#2c3e50';
                document.querySelector('.input-toolbar').style.borderTopColor = '#f1f1f1';
                document.querySelectorAll('.format-btn').forEach(btn => {
                    btn.style.backgroundColor = '#ecf0f1';
                    btn.style.color = '#3498db';
                });
                
                showConfirmDialog('‰∏ªÈ¢òÂàáÊç¢', 'Â∑≤ÂàáÊç¢‰∏∫ÊµÖËâ≤‰∏ªÈ¢ò', null, true);
            }
            
            saveToLocalStorage();
        }

        // ‰øùÂ≠òÂà∞Êú¨Âú∞Â≠òÂÇ®
        function saveToLocalStorage() {
            const data = {
                username: state.username,
                assistantName: state.assistantName,
                tabs: state.tabs,
                currentTabId: state.currentTabId,
                autoReplyProbability: state.autoReplyProbability,
                autoReplies: state.autoReplies,
                completedTodos: state.completedTodos,
                assistantTodoMap: state.assistantTodoMap,
                assistantTodoStates: state.assistantTodoStates,
                settings: state.settings
            };
            
            localStorage.setItem('chatNotepad_mobile', JSON.stringify(data));
        }

        // ‰ªéÊú¨Âú∞Â≠òÂÇ®Âä†ËΩΩ
        function loadFromLocalStorage() {
            try {
                const saved = localStorage.getItem('chatNotepad_mobile');
                if (saved) {
                    const data = JSON.parse(saved);
                    
                    state.username = data.username || 'Êàë';
                    state.assistantName = data.assistantName || 'Âä©Êâã';
                    state.tabs = data.tabs || state.tabs;
                    state.currentTabId = data.currentTabId || 1;
                    state.autoReplyProbability = data.autoReplyProbability || 70;
                    state.autoReplies = data.autoReplies || state.autoReplies;
                    state.completedTodos = data.completedTodos || {};
                    state.assistantTodoMap = data.assistantTodoMap || {};
                    state.assistantTodoStates = data.assistantTodoStates || {};
                    state.settings = data.settings || state.settings;
                    
                    if (state.settings.theme === 'dark') {
                        document.body.style.backgroundColor = '#2c3e50';
                        document.body.style.color = '#ffffff';
                        document.querySelector('.top-bar').style.backgroundColor = '#34495e';
                        document.querySelector('.top-bar').style.borderBottomColor = '#2c3e50';
                        document.querySelector('.chat-container').style.backgroundColor = '#2c3e50';
                        document.querySelector('.input-container').style.backgroundColor = '#34495e';
                        document.querySelector('.input-container').style.borderTopColor = '#2c3e50';
                        document.querySelector('.message-input').style.backgroundColor = '#34495e';
                        document.querySelector('.message-input').style.color = '#ffffff';
                        document.querySelector('.input-toolbar').style.borderTopColor = '#2c3e50';
                        document.querySelectorAll('.format-btn').forEach(btn => {
                            btn.style.backgroundColor = '#2c3e50';
                            btn.style.color = '#ecf0f1';
                        });
                    }
                }
            } catch (error) {
                console.error('Âä†ËΩΩÊú¨Âú∞Â≠òÂÇ®Â§±Ë¥•:', error);
            }
        }
        
// ÂÆåÊï¥ÁöÑÂø´Êç∑ÊñπÂºèÂ§ÑÁêÜ
function handleShortcutActions() {
    const urlParams = new URLSearchParams(window.location.search);
    
    // Ê£ÄÊµãÂêÑÁßçÂèÇÊï∞
    const action = urlParams.get('action');
    const newParam = urlParams.get('new');
    const todoParam = urlParams.get('todo');
    const completedParam = urlParams.get('completed');
    const importantParam = urlParams.get('important');
    
    // Ê£ÄÊµãÊòØÂê¶ÊòØ‰ªéÊêúÁ¥¢È°µÈù¢Ë∑≥ËΩ¨ÂõûÊù•ÁöÑ
    const searchJumpData = localStorage.getItem('chat_search_jump');
    if (searchJumpData) {
        try {
            const jumpData = JSON.parse(searchJumpData);
            const now = Date.now();
            
            // Ê£ÄÊü•ÊòØÂê¶Âú®5ÁßíÂÜÖÁöÑË∑≥ËΩ¨ÔºàÈò≤Ê≠¢ÊóßÁöÑË∑≥ËΩ¨Êï∞ÊçÆÔºâ
            if (now - jumpData.timestamp < 5000) {
                // ÂàáÊç¢Âà∞ÂØπÂ∫îÁöÑÊ†áÁ≠æ
                const tab = state.tabs.find(t => t.id === jumpData.tabId);
                if (tab) {
                    state.currentTabId = jumpData.tabId;
                    updateCurrentTab();
                    renderMessages();
                    
                    // ÊªöÂä®Âà∞ÂØπÂ∫îÁöÑÊ∂àÊÅØ
                    setTimeout(() => {
                        const messageElement = document.querySelector(`.message[data-message-id="${jumpData.messageId}"]`);
                        if (messageElement) {
                            messageElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            
                            // Ê∑ªÂä†È´ò‰∫ÆÊïàÊûú
                            messageElement.style.backgroundColor = 'rgba(52, 152, 219, 0.2)';
                            messageElement.style.borderRadius = '8px';
                            setTimeout(() => {
                                messageElement.style.backgroundColor = '';
                            }, 3000);
                        }
                    }, 500);
                }
            }
            
            // Ê∏ÖÈô§Ë∑≥ËΩ¨Êï∞ÊçÆ
            localStorage.removeItem('chat_search_jump');
        } catch (error) {
            console.error('Â§ÑÁêÜÊêúÁ¥¢Ë∑≥ËΩ¨Â§±Ë¥•:', error);
            localStorage.removeItem('chat_search_jump');
        }
    }
       
    // Âª∂ËøüÊâßË°åÔºåÁ°Æ‰øùÈ°µÈù¢ÂÆåÂÖ®Âä†ËΩΩ
    setTimeout(() => {
        // ‰ºòÂÖàÂ§ÑÁêÜ action ÂèÇÊï∞
        if (action) {
            switch(action) {
                case 'new':
                    focusOnInput('ËØ∑ËæìÂÖ•Êñ∞Ê∂àÊÅØ...');
                    break;
                case 'todo':
                    sendQueryToAssistant('todo');
                    break;
                case 'completed':
                    sendQueryToAssistant('completed');
                    break;
                case 'important':
                    sendQueryToAssistant('important');
                    break;
            }
        }
        // ÂÖºÂÆπÊóßÁöÑÂèÇÊï∞Ê†ºÂºè
        else if (newParam === 'true') {
            focusOnInput('ËØ∑ËæìÂÖ•Êñ∞Ê∂àÊÅØ...');
        }
        else if (todoParam === 'true') {
            sendQueryToAssistant('todo');
        }
        else if (completedParam === 'true') {
            sendQueryToAssistant('completed');
        }
        else if (importantParam === 'true') {
            sendQueryToAssistant('important');
        }
    }, 800); // Á≠âÂæÖÈ°µÈù¢ÂÆåÂÖ®Âä†ËΩΩ
    
    // Ê∏ÖÈô§URLÂèÇÊï∞
    clearUrlParams();
}

// ËÅöÁÑ¶Âà∞ËæìÂÖ•Ê°Ü
function focusOnInput(hintText) {
    messageInput.focus();
    
    // ÊòæÁ§∫ÊèêÁ§∫
    if (typeof window.showTemporaryMessage === 'function') {
    window.showTemporaryMessage(hintText);
} else {
    console.log(hintText); // ÈôçÁ∫ß
    }
    
    // Ê∑ªÂä†ËßÜËßâÂèçÈ¶à
    messageInput.style.boxShadow = '0 0 0 2px rgba(52, 152, 219, 0.5)';
    setTimeout(() => {
        messageInput.style.boxShadow = '';
    }, 1500);
}

// Ê∏ÖÈô§URLÂèÇÊï∞
function clearUrlParams() {
    if (window.history.replaceState) {
        // ‰øùÂ≠òÊªöÂä®‰ΩçÁΩÆ
        const scrollY = window.scrollY;
        
        // ÊõøÊç¢URLÔºåÂéªÊéâÂèÇÊï∞
        const cleanUrl = window.location.pathname + window.location.hash;
        window.history.replaceState({}, document.title, cleanUrl);
        
        // ÊÅ¢Â§çÊªöÂä®‰ΩçÁΩÆ
        window.scrollTo(0, scrollY);
    }
}      
 </script>
<!-- ËØ≠Èü≥Ê®°Âùó - Á∫ØÊú¨Âú∞Á¶ªÁ∫øÔºàÁü≠ÊåâÂºÄÂßã/ÂÅúÊ≠¢Ôºâ -->
<script type="module">
    import { pipeline, env } from 'https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.2/dist/transformers.min.js';

    env.allowLocalModels = true;
    env.useBrowserCache = true;
    env.useFS = false;
    env.allowRemoteModels = true;

    // Á≠âÂæÖ‰∏ª state ÊåÇËΩΩ
    function waitForState() {
        return new Promise(resolve => {
            if (window.state) return resolve(window.state);
            const check = setInterval(() => {
                if (window.state) {
                    clearInterval(check);
                    resolve(window.state);
                }
            }, 50);
        });
    }

    const mainState = await waitForState();
    if (!mainState.voice) mainState.voice = {};
    const voiceState = mainState.voice;
    voiceState.modelLoaded = false;
    voiceState.modelLoading = false;
    voiceState.modelDownloadProgress = 0;
    voiceState.transcriber = null;
    voiceState.modelName = 'Xenova/whisper-base';
    voiceState.modelSize = '142MB';

    // --- ÂΩïÈü≥ËÆ°Êó∂Áõ∏ÂÖ≥ ---
    let recordingTimer = null;
    let recordingSeconds = 0;

    // DOM ÂÖÉÁ¥†
    const get = id => document.getElementById(id);
    const micBtn = get('micBtn');
    const modelStatusValue = get('modelStatusValue');
    const voiceModelOption = get('voiceModelOption');
    const voiceModelDialog = get('voiceModelDialog');
    const downloadModelBtn = get('downloadModelBtn');
    const deleteModelBtn = get('deleteModelBtn');
    const closeModelDialogBtn = get('closeModelDialogBtn');
    const modelProgressContainer = get('modelProgressContainer');
    const modelProgressBar = get('modelProgressBar');
    const modelProgressPercent = get('modelProgressPercent');
    const modelDetailText = get('modelDetailText');
    const messageInput = get('messageInput');
    const menuOverlay = get('menuOverlay');

    // ÂÖ®Â±ÄÊèêÁ§∫ÂáΩÊï∞
    window.showTemporaryMessage = function(msg) {
        const toast = document.createElement('div');
        toast.textContent = msg;
        toast.style.position = 'fixed';
        toast.style.bottom = '100px';
        toast.style.left = '50%';
        toast.style.transform = 'translateX(-50%)';
        toast.style.backgroundColor = 'rgba(0,0,0,0.8)';
        toast.style.color = 'white';
        toast.style.padding = '12px 24px';
        toast.style.borderRadius = '30px';
        toast.style.zIndex = '9999';
        toast.style.fontSize = '14px';
        toast.style.boxShadow = '0 4px 12px rgba(0,0,0,0.2)';
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 2000);
    };

    // ---------- Ê£ÄÊü•ÁºìÂ≠ò ----------
    async function checkLocalModel() {
        try {
            const cached = await env.localModelManager?.getModelInfo(voiceState.modelName);
            if (cached) {
                voiceState.modelLoaded = true;
                micBtn && (micBtn.disabled = false, micBtn.classList.add('active'));
                modelStatusValue && (modelStatusValue.textContent = 'Â∑≤‰∏ãËΩΩ');
            } else {
                voiceState.modelLoaded = false;
                micBtn && (micBtn.disabled = true, micBtn.classList.remove('active'));
                modelStatusValue && (modelStatusValue.textContent = 'Êú™‰∏ãËΩΩ');
            }
        } catch (e) {
            console.warn('Ê£ÄÊü•Ê®°ÂûãÁºìÂ≠òÂ§±Ë¥•', e);
        }
    }

    // ---------- ‰∏ãËΩΩÊ®°Âûã ----------
async function loadVoiceModel(force = false) {
    // Â¶ÇÊûúÂ∑≤Êúâ transcriber ‰∏î ‰∏çÊòØÂº∫Âà∂ÈáçÊñ∞‰∏ãËΩΩÔºåÁõ¥Êé•ËøîÂõû
    if (voiceState.transcriber && !force) {
        window.showTemporaryMessage('Ê®°ÂûãÂ∑≤Â∞±Áª™');
        return;
    }

    if (voiceState.modelLoading) return;

    voiceState.modelLoading = true;
    voiceState.modelDownloadProgress = 0;

    const progressContainer = document.getElementById('modelProgressContainer');
    const downloadBtn = document.getElementById('downloadModelBtn');
    const detailText = document.getElementById('modelDetailText');
    const bar = document.getElementById('modelProgressBar');
    const percentEl = document.getElementById('modelProgressPercent');

    if (progressContainer) progressContainer.style.display = 'block';
    if (downloadBtn) {
        downloadBtn.disabled = true;
        downloadBtn.textContent = '‰∏ãËΩΩ‰∏≠...';
    }
    if (detailText) detailText.textContent = 'Ê≠£Âú®‰∏ãËΩΩÊ®°ÂûãÔºåËØ∑ÂãøÂÖ≥Èó≠È°µÈù¢...';

    // ----- Âº∫Âà∂ÈáçÊñ∞‰∏ãËΩΩÊó∂ÔºåÂÖàÂà†Èô§Êú¨Âú∞ÁºìÂ≠ò -----
    if (force && env.localModelManager) {
        try {
            await env.localModelManager.deleteModel(voiceState.modelName);
            console.log('Â∑≤Âà†Èô§ÊóßÊ®°ÂûãÁºìÂ≠ò');
        } catch (e) {
            console.warn('Âà†Èô§ÁºìÂ≠òÂ§±Ë¥•ÔºàÂèØËÉΩ‰∏çÂ≠òÂú®Ôºâ', e);
        }
    }

    // Á°Æ‰øùÊóßÁöÑ transcriber Ë¢´ÈáäÊîæ
    voiceState.transcriber = null;

        try {
            const progressCallback = (progress) => {
                let percent = voiceState.modelDownloadProgress || 0;
                let loadedMB = 0, totalMB = 0, displayText = '';

                if (typeof progress === 'number') {
                    if (progress >= 0 && progress <= 1) {
                        percent = Math.round(progress * 100);
                        displayText = `${percent}%`;
                    }
                } else if (progress && typeof progress === 'object') {
                    if (typeof progress.progress === 'number' && progress.progress >= 0 && progress.progress <= 1) {
                        percent = Math.round(progress.progress * 100);
                    }
                    if (typeof progress.loaded === 'number' && typeof progress.total === 'number' && progress.total > 0) {
                        const ratio = progress.loaded / progress.total;
                        if (ratio >= 0 && ratio <= 1) {
                            percent = Math.round(ratio * 100);
                        }
                        loadedMB = progress.loaded / (1024 * 1024);
                        totalMB = progress.total / (1024 * 1024);
                        displayText = `${loadedMB.toFixed(1)} MB / ${totalMB.toFixed(1)} MB`;
                    }
                }

                percent = Math.min(100, Math.max(0, percent));
                voiceState.modelDownloadProgress = percent;

                if (bar) bar.style.width = percent + '%';
                if (percentEl) {
                    percentEl.textContent = displayText || (percent + '%');
                }
                if (detailText && loadedMB > 0 && totalMB > 0) {
                    detailText.textContent = `Ê≠£Âú®‰∏ãËΩΩÊ®°Âûã ${displayText}`;
                }
            };

            voiceState.transcriber = await pipeline('automatic-speech-recognition', voiceState.modelName, {
                quantized: true,
                local_files_only: false, 
                progress_callback: progressCallback,
                temperature: 0.6,               // ÈªòËÆ§0.2ÔºåË∞ÉÈ´òÂèØÂ¢ûÂä†ÈöèÊú∫ÊÄßÔºåÊâìÁ†¥ÈáçÂ§çÂæ™ÁéØ [citation:10]
                repetition_penalty: 1.15,       // ÊÉ©ÁΩöÈáçÂ§çËØçÁªÑÔºå1.0=Êó†ÊÉ©ÁΩöÔºå1.1~1.2ÊïàÊûúÊòéÊòæ
                no_repeat_ngram_size: 3         // Á¶ÅÊ≠¢ËøûÁª≠3‰∏™ËØçÂÆåÂÖ®ÈáçÂ§ç
            });

            voiceState.modelLoaded = true;
            voiceState.modelLoading = false;

            const micBtn = document.getElementById('micBtn');
            const modelStatus = document.getElementById('modelStatusValue');
            if (micBtn) {
                micBtn.disabled = false;
                micBtn.classList.add('active');
            }
            if (modelStatus) modelStatus.textContent = 'Â∑≤‰∏ãËΩΩ';
            if (detailText) detailText.textContent = 'Ê®°ÂûãÂ∑≤Â∞±Áª™ÔºåÂèØ‰ª•Á¶ªÁ∫ø‰ΩøÁî®';
            if (downloadBtn) {
                downloadBtn.disabled = false;
                downloadBtn.textContent = 'ÈáçÊñ∞‰∏ãËΩΩ';
            }
            const deleteBtn = document.getElementById('deleteModelBtn');
            if (deleteBtn) deleteBtn.style.display = 'block';
            if (progressContainer) progressContainer.style.display = 'none';

            window.showTemporaryMessage('ËØ≠Èü≥Ê®°Âûã‰∏ãËΩΩÂÆåÊàêÔºÅ');
            } catch (error) {
            console.error('Ê®°ÂûãÂä†ËΩΩÂ§±Ë¥•:', error);
            voiceState.modelLoaded = false;
            voiceState.modelLoading = false;
            voiceState.transcriber = null;

            const micBtn = document.getElementById('micBtn');
            const modelStatus = document.getElementById('modelStatusValue');
            if (micBtn) {
                micBtn.disabled = true;
                micBtn.classList.remove('active');
            }
            if (modelStatus) modelStatus.textContent = '‰∏ãËΩΩÂ§±Ë¥•';
            if (detailText) detailText.textContent = '‰∏ãËΩΩÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúÂêéÈáçËØï„ÄÇ';
            if (downloadBtn) {
                downloadBtn.disabled = false;
                downloadBtn.textContent = 'ÈáçËØï‰∏ãËΩΩ';
            }
            window.showTemporaryMessage('Ê®°Âûã‰∏ãËΩΩÂ§±Ë¥•: ' + error.message);
            }
     }

    // ---------- Âà†Èô§Ê®°Âûã ----------
    async function deleteLocalModel() {
        try {
            if (env.localModelManager) {
                await env.localModelManager.deleteModel(voiceState.modelName);
                voiceState.modelLoaded = false;
                voiceState.transcriber = null;
                micBtn && (micBtn.disabled = true, micBtn.classList.remove('active'));
                modelStatusValue && (modelStatusValue.textContent = 'Êú™‰∏ãËΩΩ');
                modelDetailText && (modelDetailText.textContent = 'Ê®°ÂûãÂ∑≤Âà†Èô§ÔºåÂèØÈáçÊñ∞‰∏ãËΩΩ„ÄÇ');
                downloadModelBtn && (downloadModelBtn.textContent = '‰∏ãËΩΩÊ®°Âûã');
                deleteModelBtn && (deleteModelBtn.style.display = 'none');
                window.showTemporaryMessage('Ê®°ÂûãÂ∑≤Âà†Èô§');
            }
        } catch (e) {
            console.error('Âà†Èô§Ê®°ÂûãÂ§±Ë¥•', e);
            window.showTemporaryMessage('Âà†Èô§Â§±Ë¥•');
        }
    }

    // ---------- ÂΩïÈü≥Áõ∏ÂÖ≥ ----------
    let mediaRecorder;
    let audioChunks = [];
    let isRecording = false;

    // ÂºÄÂßãÂΩïÈü≥
    async function startRecording() {
        if (isRecording) {
            window.showTemporaryMessage('Ê≠£Âú®ÂΩïÈü≥‰∏≠');
            return;
        }
        if (!voiceState.modelLoaded || !voiceState.transcriber) {
            window.showTemporaryMessage('ËØ∑ÂÖà‰∏ãËΩΩËØ≠Èü≥Ê®°Âûã');
            return;
        }
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            audioChunks = [];

            mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
            mediaRecorder.onstop = async () => {
                const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                const audioCtx = new AudioContext({ sampleRate: 16000 });
                const arrayBuffer = await audioBlob.arrayBuffer();
                const audioBuffer = await audioCtx.decodeAudioData(arrayBuffer);
                const audioData = audioBuffer.getChannelData(0);

                // ÈáçÈááÊ†∑Ëá≥ 16000 Hz
                const targetSr = 16000;
                const originalSr = audioBuffer.sampleRate;
                let resampledData = audioData;
                if (originalSr !== targetSr) {
                    const offlineCtx = new OfflineAudioContext(1, Math.ceil(audioData.length * targetSr / originalSr), targetSr);
                    const bufferSource = offlineCtx.createBufferSource();
                    bufferSource.buffer = audioBuffer;
                    bufferSource.connect(offlineCtx.destination);
                    bufferSource.start();
                    const renderedBuffer = await offlineCtx.startRendering();
                    resampledData = renderedBuffer.getChannelData(0);
                }

                // Â¢ûÁõä & È´òÈÄöÊª§Ê≥¢
                for (let i = 0; i < resampledData.length; i++) {
                    resampledData[i] = Math.max(-1, Math.min(1, resampledData[i] * 2.0));
                }
                const filterCtx = new OfflineAudioContext(1, resampledData.length, targetSr);
                const src = filterCtx.createBufferSource();
                const buffer = audioCtx.createBuffer(1, resampledData.length, targetSr);
                buffer.copyToChannel(resampledData, 0);
                src.buffer = buffer;
                const filter = filterCtx.createBiquadFilter();
                filter.type = 'highpass';
                filter.frequency.value = 100;
                src.connect(filter);
                filter.connect(filterCtx.destination);
                src.start();
                const filteredBuffer = await filterCtx.startRendering();
                const filteredData = filteredBuffer.getChannelData(0);

                // ---------- ÂàÜÊÆµËØÜÂà´Ôºà30Áßí/ÊÆµÔºâ----------
                const segmentDuration = 30;
                const sampleRate = targetSr;
                const segmentLength = segmentDuration * sampleRate;
                const totalLength = filteredData.length;
                const segments = Math.ceil(totalLength / segmentLength);

                window.showTemporaryMessage(`‚è≥ Ê≠£Âú®ËØÜÂà´ÔºàÂÖ± ${segments} ÊÆµÔºâ...`);

                let fullText = '';
                let previousPrompt = '';   // Êñ∞Â¢ûÔºöÁ¥ØÁßØ‰∏ä‰∏ãÊñá
                try {
                    for (let i = 0; i < segments; i++) {
                        const start = i * segmentLength;
                        const end = Math.min(start + segmentLength, totalLength);
                        let segmentData = filteredData.slice(start, end);

                        if (segments > 1) {
                            window.showTemporaryMessage(`ËØÜÂà´Á¨¨ ${i + 1}/${segments} ÊÆµ...`);
                        }

                        try {
                            const result = await voiceState.transcriber(segmentData, {
                                language: 'zh',
                                task: 'transcribe',
                                // ÂÖ≥ÈîÆÔºöÊääÂâç‰∏ÄÊÆµÁöÑÊú´Â∞æÊñáÊú¨‰Ωú‰∏∫ initial_prompt ‰º†ËøõÂéª
                                initial_prompt: previousPrompt.slice(-200),  // Âè™ÂèñÊúÄËøë200Â≠óÁ¨¶ÔºåÈò≤Ê≠¢ËøáÈïø
                                temperature: 0.7,                 // ÊèêÈ´òÈöèÊú∫ÊÄßÔºåÊâìÁ†¥ÈáçÂ§çÂæ™ÁéØ
                                repetition_penalty: 1.25,         // Â¢ûÂº∫ÈáçÂ§çÊÉ©ÁΩö
                                no_repeat_ngram_size: 4,          // Èò≤Ê≠¢4-gramÈáçÂ§ç
                               max_new_tokens: 448                // ÈôêÂà∂ÊúÄÂ§ßÁîüÊàêÈïøÂ∫¶ÔºàÁ∫¶30ÁßíËØ≠Èü≥ÂØπÂ∫îtokenÊï∞Ôºâ
                            });
                            const chunkText = (result.text || '').trim();
                            function truncateOnRepetition(text) {
                            // Â¶ÇÊûúÊñáÊú¨ÈïøÂ∫¶Ë∂ÖËøá‰∏ÄÂÆöÈòàÂÄº‰∏îÊúÄÂêé20‰∏™Â≠óÁ¨¶ÈáçÂ§çÂá∫Áé∞ÔºåÂàôÊà™Êñ≠
                            if (text.length > 50) {
                                 const lastTwenty = text.slice(-20);
                                 const rest = text.slice(0, -20);
                                 if (rest.includes(lastTwenty)) {
                                     return rest;  // ËøîÂõûÁ¨¨‰∏ÄÊ¨°Âá∫Áé∞ÈáçÂ§çÂâçÁöÑÈÉ®ÂàÜ
                                 }
                            }
                            return text;
                          }

                          chunkText = truncateOnRepetition(chunkText);
                          fullText += chunkText + ' ';
                            // Êõ¥Êñ∞‰∏ä‰∏ãÊñáÔºöÂèñÂΩìÂâçÊÆµÊúÄÂêéÁ∫¶50Â≠ó‰Ωú‰∏∫‰∏ã‰∏ÄÊÆµÁöÑÊèêÁ§∫
                            previousPrompt = chunkText.slice(-50);
                          
                        } catch (e) {
                            console.error(`Á¨¨ ${i + 1} ÊÆµËØÜÂà´Â§±Ë¥•:`, e);
                            fullText += '[ËØÜÂà´Â§±Ë¥•] ';
                        } finally {
                            segmentData = null;
                        }
                        await new Promise(resolve => setTimeout(resolve, 10));
                    }

                    if (messageInput) {
                        messageInput.value = fullText.trim();
                        messageInput.dispatchEvent(new Event('input', { bubbles: true }));
                    }
                    window.showTemporaryMessage('‚úÖ ËØ≠Èü≥ËæìÂÖ•ÂÆåÊàê');
                } catch (error) {
                    console.error('ËØÜÂà´ËøáÁ®ãÂá∫Èîô:', error);
                    window.showTemporaryMessage('‚ùå ËØÜÂà´Â§±Ë¥•: ' + error.message);
                } finally {
                    // Á°Æ‰øùÈáäÊîæÈ∫¶ÂÖãÈ£éÂπ∂ÊÅ¢Â§çÊåâÈíÆÁä∂ÊÄÅ
                    stream.getTracks().forEach(t => t.stop());
                    if (micBtn) {
                        micBtn.classList.remove('recording');
                        micBtn.querySelector('i').className = 'fas fa-microphone';
                    }
                }
            };

            mediaRecorder.start();
            isRecording = true;

            // ---- ÊòæÁ§∫ËØ≠Èü≥Êù°ÔºåÂêØÂä®ËÆ°Êó∂Âô® ----
            const voiceStatusBar = get('voiceStatusBar');
            if (voiceStatusBar) {
                voiceStatusBar.style.display = 'flex';
                recordingSeconds = 0;
                const voiceTimer = get('voiceTimer');
                if (voiceTimer) voiceTimer.textContent = '00:00';
                recordingTimer = setInterval(() => {
                    recordingSeconds++;
                    const minutes = Math.floor(recordingSeconds / 60).toString().padStart(2, '0');
                    const seconds = (recordingSeconds % 60).toString().padStart(2, '0');
                    if (voiceTimer) voiceTimer.textContent = `${minutes}:${seconds}`;
                }, 1000);
            }

            // ÊåâÈíÆÂèò‰∏∫ÂÅúÊ≠¢ÂõæÊ†á
            if (micBtn) {
                micBtn.classList.add('recording');
                micBtn.querySelector('i').className = 'fas fa-stop';
            }
            window.showTemporaryMessage('ÂΩïÈü≥‰∏≠...ÁÇπÂáªÁªìÊùü');
        } catch (e) {
            console.error('Êó†Ê≥ïËé∑ÂèñÈ∫¶ÂÖãÈ£é', e);
            window.showTemporaryMessage('Êó†Ê≥ïËÆøÈóÆÈ∫¶ÂÖãÈ£é');
        }
    }

    // ÂÅúÊ≠¢ÂΩïÈü≥
    function stopRecording() {
        if (mediaRecorder && isRecording) {
            // Á´ãÂç≥ÈöêËóèËØ≠Èü≥Êù°„ÄÅÂÅúÊ≠¢ËÆ°Êó∂Âô®
            const voiceStatusBar = get('voiceStatusBar');
            if (voiceStatusBar) voiceStatusBar.style.display = 'none';
            if (recordingTimer) {
                clearInterval(recordingTimer);
                recordingTimer = null;
            }
            recordingSeconds = 0;

            // ÊÅ¢Â§çÊåâÈíÆÂõæÊ†á
            if (micBtn) {
                micBtn.classList.remove('recording');
                micBtn.querySelector('i').className = 'fas fa-microphone';
            }

            mediaRecorder.stop();
            isRecording = false;
            window.showTemporaryMessage('Ê≠£Âú®ËØÜÂà´...');
        }
    }

    // ---------- Áü≠ÊåâÂàáÊç¢ÂΩïÈü≥/ÂÅúÊ≠¢ ----------
    function bindMicClick() {
        if (!micBtn) return;

        micBtn.addEventListener('click', async (e) => {
            e.preventDefault();

            if (!voiceState.modelLoaded || !voiceState.transcriber) {
                window.showTemporaryMessage('ËØ∑ÂÖà‰∏ãËΩΩËØ≠Èü≥Ê®°Âûã');
                return;
            }

            if (isRecording) {
                stopRecording();
            } else {
                await startRecording();
            }
        });
    }

    // ---------- ÂØπËØùÊ°ÜÊéßÂà∂ ----------
    function openVoiceModelDialog() {
        modelDetailText && (modelDetailText.textContent = voiceState.modelLoaded ? 'Ê®°ÂûãÂ∑≤ÁºìÂ≠òÔºåÂèØÁ¶ªÁ∫ø‰ΩøÁî®„ÄÇ' : 'Ê®°ÂûãÊú™‰∏ãËΩΩÔºåÈúÄË¶ÅÁ∫¶142MBÊµÅÈáè„ÄÇ');
        downloadModelBtn && (downloadModelBtn.textContent = voiceState.modelLoaded ? 'ÈáçÊñ∞‰∏ãËΩΩ' : '‰∏ãËΩΩÊ®°Âûã');
        deleteModelBtn && (deleteModelBtn.style.display = voiceState.modelLoaded ? 'block' : 'none');
        modelProgressContainer && (modelProgressContainer.style.display = 'none');
        voiceModelDialog && voiceModelDialog.classList.add('show');
        menuOverlay && menuOverlay.classList.add('show');

        const bar = document.getElementById('modelProgressBar');
        const percentEl = document.getElementById('modelProgressPercent');
        if (bar) bar.style.width = '0%';
        if (percentEl) percentEl.textContent = '0.0 MB / 142.0 MB';
    }

    function closeVoiceModelDialog() {
        voiceModelDialog && voiceModelDialog.classList.remove('show');
        menuOverlay && menuOverlay.classList.remove('show');
    }

    // ---------- Ëá™ÂÆö‰πâÁ°ÆËÆ§Ê°Ü ----------
    function showCustomConfirm(title, message) {
        return new Promise(resolve => {
            const dlg = get('confirmDialog');
            const titleEl = get('confirmTitle');
            const msgEl = get('confirmMessage');
            const confirmBtn = get('confirmBtn');
            const cancelBtn = get('cancelConfirmBtn');
            const overlay = get('menuOverlay');
            if (!dlg || !titleEl || !msgEl || !confirmBtn || !cancelBtn) return resolve(false);
            titleEl.textContent = title;
            msgEl.textContent = message;
            dlg.classList.add('show');
            overlay && overlay.classList.add('show');
            const onConfirm = () => {
                confirmBtn.removeEventListener('click', onConfirm);
                cancelBtn.removeEventListener('click', onCancel);
                dlg.classList.remove('show');
                overlay && overlay.classList.remove('show');
                resolve(true);
            };
            const onCancel = () => {
                confirmBtn.removeEventListener('click', onConfirm);
                cancelBtn.removeEventListener('click', onCancel);
                dlg.classList.remove('show');
                overlay && overlay.classList.remove('show');
                resolve(false);
            };
            confirmBtn.addEventListener('click', onConfirm);
            cancelBtn.addEventListener('click', onCancel);
        });
    }

// ---------- ÂàùÂßãÂåñËØ≠Èü≥Ê®°ÂùóÔºà‰øÆÂ§çËá™Âä®Âä†ËΩΩÔºâ ----------
async function initVoiceModule() {
    // ÂÖàÊõ¥Êñ∞ UI Áä∂ÊÄÅÔºàÁî®‰∫éÊòæÁ§∫‚ÄúÂ∑≤‰∏ãËΩΩ‚Äù/‚ÄúÊú™‰∏ãËΩΩ‚ÄùÔºâ
    await checkLocalModel();

    // Â¶ÇÊûú transcriber Ëøò‰∏çÂ≠òÂú®ÔºåÂ∞ùËØï‰ªéÊú¨Âú∞ÁºìÂ≠òÂä†ËΩΩÔºà‰∏çËß¶Âèë‰∏ãËΩΩÔºâ
    if (!voiceState.transcriber) {
        window.showTemporaryMessage('‚è≥ Ê≠£Âú®Ê£ÄÊü•Êú¨Âú∞ËØ≠Èü≥Ê®°Âûã...');
        try {
            // ÂÖ≥ÈîÆÔºöËÆæÁΩÆ local_files_only: trueÔºåÁªù‰∏çËÅîÁΩë‰∏ãËΩΩ
            voiceState.transcriber = await pipeline('automatic-speech-recognition', voiceState.modelName, {
                quantized: true,
                local_files_only: true,
                // ÂèØ‰ª•‰øùÁïôÊäóÂπªËßâÂèÇÊï∞
                temperature: 0.6,
                repetition_penalty: 1.15,
                no_repeat_ngram_size: 3
            });

            // Âä†ËΩΩÊàêÂäü
            voiceState.modelLoaded = true;
            voiceState.modelLoading = false;
            micBtn && (micBtn.disabled = false, micBtn.classList.add('active'));
            modelStatusValue && (modelStatusValue.textContent = 'Â∑≤‰∏ãËΩΩ');
            console.log('‚úÖ ËØ≠Èü≥Ê®°ÂûãÂ∑≤‰ªéÊú¨Âú∞ÁºìÂ≠òÂä†ËΩΩ');
        } catch (e) {
            // Êú¨Âú∞‰∏çÂ≠òÂú®ÔºåÈùôÈªòÂ§±Ë¥•Ôºà‰∏çÊòæÁ§∫ÈîôËØØÔºâ
            console.log('‚ÑπÔ∏è Êú¨Âú∞Êó†Ê®°ÂûãÁºìÂ≠òÔºåÈúÄË¶ÅÊâãÂä®‰∏ãËΩΩ', e);
            voiceState.modelLoaded = false;
            voiceState.transcriber = null;
            // UI ‰øùÊåÅ‚ÄúÊú™‰∏ãËΩΩ‚ÄùÁä∂ÊÄÅÔºàÂ∑≤Âú® checkLocalModel ‰∏≠ËÆæÁΩÆÔºâ
        }
    }
}

setTimeout(initVoiceModule, 300);
  // Êö¥Èú≤ÂáΩÊï∞Âà∞ÂÖ®Â±ÄÔºå‰æõÊôÆÈÄöËÑöÊú¨Ë∞ÉÁî®
window.openVoiceModelDialog = openVoiceModelDialog;
window.closeVoiceModelDialog = closeVoiceModelDialog;
window.voiceState = voiceState;

// ========== ÁªëÂÆöÊåâÈíÆ‰∫ã‰ª∂ ==========
downloadModelBtn && downloadModelBtn.addEventListener('click', async () => {
    await loadVoiceModel(true);
});

deleteModelBtn && deleteModelBtn.addEventListener('click', async () => {
    const ok = await showCustomConfirm('Âà†Èô§Ê®°Âûã', 'Á°ÆÂÆöË¶ÅÂà†Èô§Â∑≤‰∏ãËΩΩÁöÑËØ≠Èü≥Ê®°ÂûãÂêóÔºü');
    if (ok) await deleteLocalModel();
});

closeModelDialogBtn && closeModelDialogBtn.addEventListener('click', closeVoiceModelDialog);
bindMicClick();
</script>
</body>
</html>
