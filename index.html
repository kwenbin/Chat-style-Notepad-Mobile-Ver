<!DOCTYPE html>
<html lang="zh-CN">
<head>
<script>
// ç«‹å³æ³¨å†Œ Service Worker
if ('serviceWorker' in navigator) {
  window.addEventListener('load', function() {
    navigator.serviceWorker.register('sw.js')
      .then(registration => {
        console.log('ServiceWorker æ³¨å†ŒæˆåŠŸï¼Œä½œç”¨åŸŸä¸º: ', registration.scope);
        // å¯ä»¥åœ¨è¿™é‡Œæ˜¾ç¤ºâ€œåº”ç”¨å·²å‡†å¤‡å¥½å®‰è£…â€çš„æç¤º
      })
      .catch(err => {
        console.log('ServiceWorker æ³¨å†Œå¤±è´¥: ', err);
      });
  });
}
</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>èŠå¤©å¼è®°äº‹æœ¬ - ç§»åŠ¨ç‰ˆ</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="xlsx.full.min.js"></script>
<!-- PWAç›¸å…³metaæ ‡ç­¾ -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#3498db">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="èŠå¤©è®°äº‹æœ¬">
<link rel="apple-touch-icon" href="icon-192x192.png">
<meta name="mobile-web-app-capable" content="yes">
<meta name="application-name" content="èŠå¤©è®°äº‹æœ¬">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background-color: #f8f9fa;
            color: #2c3e50;
            overflow: hidden;
            height: 100vh;
        }

        /* é¡¶éƒ¨å¯¼èˆªæ  */
        .top-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 56px;
            background-color: #ffffff;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
            border-bottom: 1px solid #eaeaea;
            z-index: 100;
        }

        .nav-btn {
            width: 44px;
            height: 44px;
            border: none;
            background: none;
            font-size: 24px;
            color: #2c3e50;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            transition: background-color 0.2s ease;
        }

        .nav-btn:hover {
            background-color: #f8f9fa;
        }

        .nav-title {
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 60%;
        }

        /* èŠå¤©å†…å®¹åŒºåŸŸ */
.chat-container {
    position: fixed;
    top: 56px;
    left: 0;
    right: 0;
    bottom: 0;
    overflow-y: auto;
    padding: 16px;
    padding-bottom: 160px;
    display: flex;
    flex-direction: column; /* æ·»åŠ è¿™ä¸€è¡Œ */
}

        /* æ—¶é—´åˆ†éš”çº¿ */
        .time-divider {
            text-align: center;
            margin: 20px 0;
            position: relative;
        }

        .time-divider::before {
            content: '';
            position: absolute;
            left: 0;
            right: 0;
            top: 50%;
            height: 1px;
            background-color: #eaeaea;
            z-index: 1;
        }

        .time-text {
            display: inline-block;
            padding: 6px 12px;
            background-color: #ffffff;
            border-radius: 12px;
            font-size: 12px;
            color: #95a5a6;
            position: relative;
            z-index: 2;
            border: 1px solid #eaeaea;
        }

        /* æ¶ˆæ¯æ°”æ³¡ - ä¿®æ”¹ï¼šç¡®ä¿è‡ªå·±çš„æ°”æ³¡é å³ */
.message {
    margin-bottom: 12px;
    display: flex;
    flex-direction: column;
    position: relative;
    max-width: 100%;
}

        .message.self {
    align-self: flex-end;
    margin-left: auto;
    margin-right: 0;
    max-width: 85vw;
    width: fit-content;
    display: flex;
    flex-direction: column;
    align-items: flex-end; /* æ·»åŠ è¿™ä¸€è¡Œ */
}

.message.other {
    align-self: flex-start;
    margin-right: auto;
    max-width: 85vw;
    width: fit-content;
    display: flex;
    flex-direction: column;
    align-items: flex-start; /* æ·»åŠ è¿™ä¸€è¡Œ */
}

        .message-header {
            display: flex;
            align-items: center;
            margin-bottom: 4px;
            font-size: 12px;
            color: #7f8c8d;
            width: 100%;
        }

        .message.self .message-header {
            justify-content: flex-end;
        }

        .message.other .message-header {
            justify-content: flex-start;
        }

        .username {
            font-weight: 600;
        }

        .message-time {
            opacity: 0.8;
        }

        .message.self .message-header .username {
            margin-left: 8px;
        }

        .message.other .message-header .username {
            margin-right: 8px;
        }

        /* ä¿®æ”¹ï¼šæ‰€æœ‰æ°”æ³¡éƒ½æœ‰é˜´å½±æ•ˆæœ */
        .bubble {
            padding: 12px 16px;
            border-radius: 20px;
            word-wrap: break-word;
            white-space: pre-wrap;
            line-height: 1.5;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            position: relative;
            user-select: text;
            cursor: pointer;
            transition: transform 0.2s ease, background-color 0.3s ease;
            /* ä¿®æ”¹ï¼šæ°”æ³¡å®½åº¦è‡ªé€‚åº”ï¼Œä½†ä¸è¶…è¿‡å±å¹•å®½åº¦çš„85% */
            min-width: 40px; /* å¤§çº¦2ä¸ªå­—ç¬¦çš„å®½åº¦ */
            max-width: 85vw; /* æœ€å¤§ä¸ºè§†å£å®½åº¦çš„85% */
            width: fit-content;
            /* å­—ä½“å¤§å°å°†ç”±JavaScriptåŠ¨æ€è®¾ç½® */
        }

        .message.self .bubble {
            background-color: #3498db;
            color: #ffffff;
            border-bottom-right-radius: 6px;
            box-shadow: 0 3px 12px rgba(0, 0, 0, 0.18);
        }

        .message.other .bubble {
            background-color: #ffffff;
            color: #2c3e50;
            border: 1px solid #eaeaea;
            border-bottom-left-radius: 6px;
        }

        /* å¾…åŠæ°”æ³¡æ ·å¼ - ä¿®æ”¹ï¼šè‡ªå·±çš„æ¶ˆæ¯ä¸æ˜¾ç¤ºå‹¾é€‰æ¡† */
        .message.self .bubble.todo-pending::before,
        .message.self .bubble.todo-completed::before {
            display: none;
        }

        .message.other .bubble.todo-pending::before {
            content: 'â˜';
            margin-right: 8px;
            font-size: 18px;
            cursor: pointer;
        }

        .message.other .bubble.todo-completed::before {
            content: 'â˜‘';
            margin-right: 8px;
            font-size: 18px;
            cursor: pointer;
            color: #27ae60;
        }

        .bubble.todo-completed {
            color: #95a5a6 !important;
            text-decoration: line-through;
        }

        .message.self .bubble.todo-completed {
            background-color: #3498db;
            opacity: 0.8;
        }

        .message.other .bubble.todo-completed {
            background-color: #ffffff;
            opacity: 0.8;
        }

        /* é‡è¦æ°”æ³¡æ ·å¼ */
        .bubble.important {
            border-left: 4px solid #e74c3c;
        }

        /* æŠ–åŠ¨åŠ¨ç”» */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-2px); }
            75% { transform: translateX(2px); }
        }

        .bubble.shake {
            animation: shake 0.3s ease;
        }

        /* è¾“å…¥åŒºåŸŸ - ä¿®æ”¹å */
        .input-container {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: #ffffff;
            border-top: 1px solid #eaeaea;
            z-index: 100;
            transition: transform 0.3s ease;
            padding-bottom: env(safe-area-inset-bottom);
        }

        .input-container.keyboard-open {
            transform: translateY(-50%);
        }

        .message-input-container {
            position: relative;
            border-top: 1px solid transparent;
            display: flex;
            flex-direction: column;
        }

        /* åœ†å½¢åŠ å·æŒ‰é’® - ä¿®å¤ä½ç½®ï¼Œæé«˜ä½ç½®é¿å…è¢«è¾“å…¥æ¡†é®æŒ¡ */
        .quick-actions {
            position: fixed;
            bottom: 120px; /* æé«˜ä½ç½®ï¼Œé¿å…è¢«è¾“å…¥æ¡†é®æŒ¡ */
            right: 16px;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            z-index: 150;
        }

        .quick-main-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: #ffffff;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
            transition: all 0.3s ease;
            z-index: 151;
            position: fixed; /* æ”¹ä¸ºfixedå®šä½ */
            bottom: 120px; /* æé«˜ä½ç½® */
            right: 16px;
        }

        .quick-main-btn:hover {
            transform: rotate(90deg);
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
        }

        .quick-sub-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 10px;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s ease;
            pointer-events: none;
            position: fixed; /* æ”¹ä¸ºfixedå®šä½ */
            bottom: 180px; /* æé«˜ä½ç½® */
            right: 16px;
        }

        .quick-sub-buttons.show {
            opacity: 1;
            transform: translateY(0);
            pointer-events: all;
        }

        .quick-sub-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            border: none;
            color: #ffffff;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
            transition: all 0.2s ease;
        }

        .quick-sub-btn.todo {
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
        }

        .quick-sub-btn.completed {
            background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
        }

        .quick-sub-btn.important {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }

        .quick-sub-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .quick-sub-btn .badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: #e74c3c;
            color: white;
            font-size: 10px;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .message-input {
            width: 100%;
            min-height: 40px;
            max-height: 200px;
            padding: 10px 16px;
            border: none;
            outline: none;
            font-size: 16px;
            line-height: 1.5;
            resize: none;
            font-family: inherit;
            background-color: #ffffff;
            overflow-y: auto;
            transition: min-height 0.2s ease;
        }

        .message-input.focused {
            min-height: 60px;
        }

        .message-input::placeholder {
            color: #95a5a6;
        }

        .input-toolbar {
            height: 44px;
            padding: 0 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-top: none;
        }

        .toolbar-left {
            display: flex;
            align-items: center;
            gap: 4px;
            flex: 1;
        }

        .toolbar-right {
            display: flex;
            align-items: center;
        }

        .format-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: none;
            background-color: #ecf0f1;
            color: #3498db;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .format-btn:hover {
            background-color: #e0e6e8;
        }

        .format-btn.active {
            background-color: #2c3e50;
            color: #ffffff;
        }

        .tag-btn {
            width: 36px;
            height: 36px;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            font-weight: bold;
            font-size: 16px;
        }

        .tag-btn.important {
            background-color: #e74c3c;
            color: #ffffff;
        }

        .tag-btn.important:hover {
            background-color: #c0392b;
        }

        .tag-btn.todo {
            background-color: #2ecc71;
            color: #ffffff;
        }

        .tag-btn.todo:hover {
            background-color: #27ae60;
        }

        .send-btn {
            width: 44px;
            height: 44px;
            border: none;
            border-radius: 50%;
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: #ffffff;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            margin-left: 8px;
        }

        .send-btn:hover {
            background: linear-gradient(135deg, #2980b9 0%, #2573a7 100%);
            transform: translateY(-1px);
        }

        .send-btn.show {
            display: flex;
            animation: slideInRight 0.3s ease;
        }

        /* æ°”æ³¡èœå• - ä¿®æ”¹ï¼šå¢åŠ æ ‡è®°å®Œæˆ/é‡æ–°å¾…åŠé€‰é¡¹ */
        .bubble-menu {
            position: fixed;
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            z-index: 2000;
            padding: 8px;
            display: none;
            flex-direction: column;
            min-width: 160px;
            border: 1px solid #eaeaea;
        }

        .bubble-menu.show {
            display: flex;
            animation: fadeIn 0.2s ease;
        }

        .bubble-menu-item {
            padding: 12px 16px;
            border: none;
            background: none;
            text-align: left;
            font-size: 15px;
            color: #2c3e50;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            border-radius: 8px;
            transition: background-color 0.2s ease;
        }

        .bubble-menu-item:hover {
            background-color: #f8f9fa;
        }

        .bubble-menu-item.important.active {
            color: #e74c3c;
        }

        .bubble-menu-item.todo.active {
            color: #2ecc71;
        }

        .bubble-menu-item.complete {
            color: #27ae60;
        }

        .bubble-menu-item.reopen {
            color: #f39c12;
        }

        .bubble-menu-item.delete {
            color: #e74c3c;
            border-top: 1px solid #f1f1f1;
            margin-top: 4px;
            padding-top: 16px;
        }

        .bubble-menu-item.delete:hover {
            background-color: #fee;
        }

        /* åŠ©æ‰‹å¾…åŠè¡¨æ ¼æ ·å¼ */
        .todo-table-container {
            margin: 12px 0;
            width: 100%;
            max-width: 85vw;
        }

        .todo-table {
            width: 100%;
            border-collapse: collapse;
            background-color: #ffffff;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            border: 1px solid #eaeaea;
        }

        .todo-table th {
            background-color: #f8f9fa;
            padding: 8px 12px;
            text-align: left;
            font-size: 12px;
            color: #7f8c8d;
            font-weight: 600;
            border-bottom: 1px solid #eaeaea;
        }

        .todo-table td {
            padding: 12px;
            border-bottom: 1px solid #f1f1f1;
            vertical-align: middle;
        }

        .todo-table tr:last-child td {
            border-bottom: none;
        }

        .todo-date {
            font-size: 12px;
            color: #7f8c8d;
            white-space: nowrap;
        }

        .todo-tag {
            font-size: 12px;
            font-weight: bold;
            color: #2ecc71;
        }

        .todo-content {
            font-size: 14px;
            color: #2c3e50;
            word-break: break-word;
        }

        .todo-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .todo-table tr.completed .todo-content {
            text-decoration: line-through;
            color: #95a5a6;
        }

        .save-todo-btn {
            margin-top: 12px;
            padding: 10px 20px;
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: #ffffff;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(52, 152, 219, 0.3);
        }

        .save-todo-btn:hover {
            background: linear-gradient(135deg, #2980b9 0%, #2573a7 100%);
            transform: translateY(-1px);
        }

        /* å‘é€æ–¹å¼é€‰é¡¹æ ·å¼ */
        .dialog-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin: 20px 0;
        }

        .send-key-option {
            display: flex;
            align-items: flex-start;
            padding: 16px;
            border: 2px solid #eaeaea;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .send-key-option:hover {
            border-color: #3498db;
            background-color: #f8f9fa;
        }

        .send-key-option.selected {
            border-color: #3498db;
            background-color: #f0f7ff;
        }

        .option-radio {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid #bdc3c7;
            margin-right: 12px;
            margin-top: 2px;
            position: relative;
            transition: all 0.2s ease;
        }

        .send-key-option.selected .option-radio {
            border-color: #3498db;
            background-color: #3498db;
        }

        .send-key-option.selected .option-radio::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: white;
        }

        .option-text-full {
            flex: 1;
        }

        .option-title {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 4px;
        }

        .option-desc {
            font-size: 13px;
            color: #7f8c8d;
            line-height: 1.4;
        }

        /* åŠ©æ‰‹å›å¤çš„å¾…åŠåˆ—è¡¨æ ·å¼ï¼ˆæ—§ç‰ˆï¼Œä¿ç•™å…¼å®¹ï¼‰ */
        .todo-list-item {
            margin-bottom: 8px;
            padding: 8px;
            border-radius: 8px;
            background-color: #f8f9fa;
            border: 1px solid #eaeaea;
        }

        .todo-list-header {
            display: flex;
            align-items: center;
            margin-bottom: 4px;
        }

        .todo-list-date {
            font-size: 12px;
            color: #7f8c8d;
            margin-right: 8px;
        }

        .todo-list-checkbox {
            margin-right: 8px;
            cursor: pointer;
        }

        .todo-list-content {
            margin-left: 6px;
            font-size: 14px;
            color: #2c3e50;
        }

        .todo-list-item.completed .todo-list-content {
            text-decoration: line-through;
            color: #95a5a6;
        }

        /* ä¾§æ»‘èœå• - æ ‡ç­¾ç®¡ç† */
        .side-menu {
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            width: 85%;
            max-width: 320px;
            background-color: #2c3e50;
            color: #ffffff;
            transform: translateX(-100%);
            transition: transform 0.3s ease;
            z-index: 1000;
            overflow-y: auto;
        }

        .side-menu.open {
            transform: translateX(0);
            box-shadow: 5px 0 30px rgba(0, 0, 0, 0.3);
        }

        .menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 999;
            display: none;
            cursor: pointer;
        }

        .menu-overlay.show {
            display: block;
        }

        .menu-header {
            padding: 20px 16px;
            border-bottom: 1px solid #34495e;
        }

        .menu-title {
            font-size: 20px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .tabs-list {
            padding: 16px;
        }

        .tab-item {
            padding: 12px 16px;
            border-radius: 8px;
            background-color: rgba(255, 255, 255, 0.1);
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid transparent;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        .tab-item:hover {
            background-color: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.2);
        }

        .tab-item.active {
            background-color: rgba(52, 152, 219, 0.8) !important;
            border-color: #3498db !important;
        }

        .tab-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }

        .tab-name {
            font-size: 16px;
            font-weight: 600;
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .tab-actions {
            display: flex;
            gap: 8px;
            opacity: 1;
        }

        .tab-action-btn {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 6px;
            background-color: rgba(255, 255, 255, 0.1);
            color: #ffffff;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .tab-action-btn:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        .tab-action-btn.pin {
            color: #f39c12;
        }

        .tab-action-btn.pin.active {
            background-color: rgba(243, 156, 18, 0.3);
        }

        .tab-action-btn.rename {
            color: #3498db;
        }

        .tab-action-btn.delete {
            color: #e74c3c;
        }

        .tab-preview {
            font-size: 13px;
            color: #ecf0f1;
            opacity: 0.8;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .menu-actions {
            padding: 16px;
            border-top: 1px solid #34495e;
            margin-top: auto;
        }

        .new-tab-btn {
            width: 100%;
            padding: 14px;
            border-radius: 12px;
            border: none;
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: #ffffff;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .new-tab-btn:hover {
            transform: translateY(-2px);
        }

        /* è®¾ç½®èœå• - åº•éƒ¨å¼¹å‡º */
        .settings-menu {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: #ffffff;
            border-radius: 16px 16px 0 0;
            transform: translateY(100%);
            transition: transform 0.3s ease;
            z-index: 1001;
            box-shadow: 0 -10px 40px rgba(0, 0, 0, 0.1);
            max-height: 80vh;
            overflow-y: auto;
        }

        .settings-menu.open {
            transform: translateY(0);
        }

        .settings-header {
            padding: 20px 16px;
            border-bottom: 1px solid #eaeaea;
            text-align: center;
            position: relative;
        }

        .settings-title {
            font-size: 18px;
            font-weight: 700;
            color: #2c3e50;
        }

        .close-settings {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            width: 44px;
            height: 44px;
            border: none;
            background: none;
            font-size: 24px;
            color: #7f8c8d;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
        }

        .close-settings:hover {
            background-color: #f8f9fa;
        }

        .settings-options {
            padding: 8px 0;
        }

        .settings-option {
            padding: 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            transition: background-color 0.2s ease;
            border-bottom: 1px solid #f8f9fa;
        }

        .settings-option:last-child {
            border-bottom: none;
        }

        .settings-option:hover {
            background-color: #f8f9fa;
        }

        .option-text {
            font-size: 16px;
            color: #2c3e50;
            flex: 1;
        }

        .option-value {
            font-size: 14px;
            color: #7f8c8d;
            margin-right: 8px;
        }

        .option-icon {
            color: #7f8c8d;
            font-size: 20px;
        }

        /* ç”¨æˆ·åä¿®æ”¹å¼¹çª— */
        .username-dialog {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #ffffff;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            z-index: 2000;
            padding: 24px;
            width: 90%;
            max-width: 400px;
            display: none;
        }

        .username-dialog.show {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .dialog-header {
            margin-bottom: 20px;
        }

        .dialog-title {
            font-size: 20px;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 8px;
        }

        .dialog-text {
            font-size: 14px;
            color: #7f8c8d;
            line-height: 1.5;
        }

        .username-input {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #eaeaea;
            border-radius: 12px;
            font-size: 16px;
            margin-bottom: 24px;
            transition: border-color 0.2s ease;
        }

        .username-input:focus {
            outline: none;
            border-color: #3498db;
        }

        .dialog-actions {
            display: flex;
            gap: 12px;
        }

        .dialog-btn {
            flex: 1;
            padding: 14px;
            border-radius: 12px;
            border: none;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .dialog-btn.cancel {
            background-color: #ecf0f1;
            color: #2c3e50;
        }

        .dialog-btn.cancel:hover {
            background-color: #e0e6e8;
        }

        .dialog-btn.save {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: #ffffff;
        }

        .dialog-btn.save:hover {
            background: linear-gradient(135deg, #2980b9 0%, #2573a7 100%);
        }

        /* ç¡®è®¤å¯¹è¯æ¡† */
        .confirm-dialog {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #ffffff;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            z-index: 2000;
            padding: 24px;
            width: 90%;
            max-width: 400px;
            display: none;
        }

        .confirm-dialog.show {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .confirm-message {
            font-size: 16px;
            color: #2c3e50;
            line-height: 1.5;
            margin-bottom: 24px;
        }

        /* é‡å‘½åå¯¹è¯æ¡† */
        .rename-dialog {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #ffffff;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            z-index: 2000;
            padding: 24px;
            width: 90%;
            max-width: 400px;
            display: none;
        }

        .rename-dialog.show {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .rename-input {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #eaeaea;
            border-radius: 12px;
            font-size: 16px;
            margin-bottom: 24px;
            transition: border-color 0.2s ease;
        }

        .rename-input:focus {
            outline: none;
            border-color: #3498db;
        }

        /* åŠ©æ‰‹åç§°å¯¹è¯æ¡† */
        .assistant-dialog {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #ffffff;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            z-index: 2000;
            padding: 24px;
            width: 90%;
            max-width: 400px;
            display: none;
        }

        .assistant-dialog.show {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .assistant-input {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #eaeaea;
            border-radius: 12px;
            font-size: 16px;
            margin-bottom: 24px;
            transition: border-color 0.2s ease;
        }

        .assistant-input:focus {
            outline: none;
            border-color: #3498db;
        }

        /* å‘é€æ–¹å¼è®¾ç½®å¯¹è¯æ¡† */
        .send-key-dialog {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #ffffff;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            z-index: 2000;
            padding: 24px;
            width: 90%;
            max-width: 400px;
            display: none;
        }

        .send-key-dialog.show {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        /* æ¦‚ç‡è®¾ç½®å¯¹è¯æ¡† */
        .probability-dialog {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #ffffff;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            z-index: 2000;
            padding: 24px;
            width: 90%;
            max-width: 400px;
            display: none;
        }

        .probability-dialog.show {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .probability-slider {
            width: 100%;
            margin: 20px 0;
        }

        .probability-value {
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            color: #3498db;
            margin: 10px 0;
        }

        /* å­—ä½“å¤§å°è®¾ç½®å¯¹è¯æ¡† */
        .font-size-dialog {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #ffffff;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            z-index: 2000;
            padding: 24px;
            width: 90%;
            max-width: 400px;
            display: none;
        }

        .font-size-dialog.show {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .font-size-slider {
            width: 100%;
            margin: 20px 0;
        }

        .font-size-value {
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            color: #3498db;
            margin: 10px 0;
        }

        /* è‡ªåŠ¨å›å¤å†…å®¹ç®¡ç†å¯¹è¯æ¡† */
        .reply-content-dialog {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #ffffff;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            z-index: 2000;
            padding: 24px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            display: none;
            overflow-y: auto;
        }

        .reply-content-dialog.show {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .reply-list {
            margin: 20px 0;
            max-height: 300px;
            overflow-y: auto;
        }

        .reply-item {
            padding: 12px;
            border: 1px solid #eaeaea;
            border-radius: 8px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #f8f9fa;
        }

        .reply-text {
            flex: 1;
            margin-right: 12px;
            font-size: 14px;
            color: #2c3e50;
        }

        .reply-actions {
            display: flex;
            gap: 8px;
        }

        .reply-action-btn {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 6px;
            background-color: #ecf0f1;
            color: #7f8c8d;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .reply-action-btn:hover {
            background-color: #e0e6e8;
        }

        .reply-action-btn.delete {
            color: #e74c3c;
        }

        .add-reply-container {
            display: flex;
            gap: 8px;
            margin-top: 20px;
        }

        .add-reply-input {
            flex: 1;
            padding: 12px;
            border: 2px solid #eaeaea;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.2s ease;
        }

        .add-reply-input:focus {
            outline: none;
            border-color: #3498db;
        }

        .add-reply-btn {
            width: 44px;
            height: 44px;
            border: none;
            border-radius: 50%;
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
            color: #ffffff;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.2s ease;
        }

        .add-reply-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(46, 204, 113, 0.3);
        }

        /* ç©ºçŠ¶æ€ */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            padding: 40px 20px;
            text-align: center;
        }

        .empty-icon {
            font-size: 60px;
            color: #bdc3c7;
            margin-bottom: 20px;
        }

        .empty-title {
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
        }

        .empty-text {
            font-size: 14px;
            color: #7f8c8d;
            line-height: 1.5;
        }

        /* åŠ¨ç”» */
        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* æ¶ˆæ¯åŠ¨ç”» */
        .message {
            opacity: 0;
            animation: fadeIn 0.3s ease forwards;
        }

        /* æ»šåŠ¨æ¡æ ·å¼ */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb {
            background: #bdc3c7;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #95a5a6;
        }

        .chat-container::-webkit-scrollbar {
            width: 4px;
        }

        /* é”®ç›˜å¼¹å‡ºæ—¶æé«˜å¿«é€ŸæŒ‰é’®ä½ç½® */
        .input-container.keyboard-open ~ .quick-actions .quick-main-btn {
            bottom: 180px;
        }

        .input-container.keyboard-open ~ .quick-actions .quick-sub-buttons {
            bottom: 240px;
        }

        /* å“åº”å¼è°ƒæ•´ */
        @media (max-width: 320px) {
            .format-btn {
                width: 32px;
                height: 32px;
                font-size: 12px;
            }
            
            .tag-btn {
                width: 32px;
                height: 32px;
                font-size: 14px;
            }
            
            .send-btn {
                width: 36px;
                height: 36px;
            }
            
            .quick-main-btn {
                width: 44px;
                height: 44px;
                font-size: 20px;
            }
            
            .quick-sub-btn {
                width: 40px;
                height: 40px;
                font-size: 16px;
            }
            
            .todo-table th,
            .todo-table td {
                padding: 8px;
                font-size: 12px;
            }
            
            .todo-table {
                font-size: 12px;
            }
        }

        @media (min-width: 768px) {
            .message {
                max-width: 75%;
            }
            
            .side-menu {
                width: 70%;
                max-width: 400px;
            }
            
            .todo-table-container {
                max-width: 600px;
            }
        }

        /* å®‰å…¨åŒºåŸŸé€‚é…ï¼ˆå…¨é¢å±æ‰‹æœºï¼‰ */
        @supports (padding-top: env(safe-area-inset-top)) {
            .top-bar {
                padding-top: env(safe-area-inset-top);
                height: calc(56px + env(safe-area-inset-top));
            }
            
            .chat-container {
                top: calc(56px + env(safe-area-inset-top));
            }
            
            .side-menu {
                padding-top: env(safe-area-inset-top);
            }
            
            .settings-menu {
                padding-bottom: env(safe-area-inset-bottom);
            }
            
            .quick-main-btn {
                bottom: calc(120px + env(safe-area-inset-bottom));
            }
            
            .quick-sub-buttons {
                bottom: calc(180px + env(safe-area-inset-bottom));
            }
            
            .input-container.keyboard-open ~ .quick-actions .quick-main-btn {
                bottom: calc(180px + env(safe-area-inset-bottom));
            }
            
            .input-container.keyboard-open ~ .quick-actions .quick-sub-buttons {
                bottom: calc(240px + env(safe-area-inset-bottom));
            }
        }
/* å¯¼å‡ºå¯¹è¯æ¡†æ ·å¼ */
.export-option {
    padding: 12px;
    border: 2px solid #eaeaea;
    border-radius: 8px;
    margin-bottom: 12px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.export-option:hover {
    border-color: #3498db;
    background-color: #f8f9fa;
}

.export-option input[type="radio"]:checked ~ label {
    color: #3498db;
}

.export-option input[type="radio"]:checked {
    accent-color: #3498db;
}

.progress-container {
    animation: fadeIn 0.3s ease;
}

/* å‚¨å­˜ç©ºé—´ç®¡ç†å¯¹è¯æ¡†æ ·å¼ */
.storage-dialog {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background-color: #ffffff;
    border-radius: 16px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
    z-index: 2000;
    padding: 24px;
    width: 90%;
    max-width: 500px;
    max-height: 80vh;
    display: none;
    overflow-y: auto;
}

.storage-dialog.show {
    display: block;
    animation: fadeIn 0.3s ease;
}

.storage-summary {
    background-color: #f8f9fa;
    border-radius: 12px;
    padding: 16px;
    margin: 16px 0;
    border: 1px solid #eaeaea;
}

.storage-item {
    display: flex;
    justify-content: space-between;
    margin-bottom: 8px;
    font-size: 14px;
}

.storage-item:last-child {
    margin-bottom: 0;
}

.storage-label {
    color: #7f8c8d;
}

.storage-value {
    color: #2c3e50;
    font-weight: 600;
}

.time-range-selector {
    margin: 20px 0;
    padding: 16px;
    background-color: #f8f9fa;
    border-radius: 12px;
}

.date-inputs {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin: 12px 0;
}

.date-input-group {
    display: flex;
    flex-direction: column;
    gap: 6px;
}

.date-input-group label {
    font-size: 14px;
    color: #2c3e50;
    font-weight: 500;
}

.date-input {
    padding: 10px;
    border: 2px solid #eaeaea;
    border-radius: 8px;
    font-size: 14px;
    transition: border-color 0.2s ease;
}

.date-input:focus {
    outline: none;
    border-color: #3498db;
}

.quick-buttons {
    display: flex;
    gap: 8px;
    margin-top: 12px;
    flex-wrap: wrap;
}

.time-range-btn {
    flex: 1;
    padding: 10px 16px;
    border: 2px solid #eaeaea;
    background-color: #ffffff;
    color: #2c3e50;
    border-radius: 8px;
    cursor: pointer;
    font-size: 13px;
    transition: all 0.2s ease;
    min-width: 80px;
}

.time-range-btn:hover {
    border-color: #3498db;
    background-color: #f8f9fa;
}

.time-range-btn.active {
    border-color: #3498db;
    background-color: #f0f7ff;
    color: #3498db;
    font-weight: 600;
}

.preview-section {
    margin: 20px 0;
    padding: 16px;
    background-color: #f8f9fa;
    border-radius: 12px;
    max-height: 200px;
    overflow-y: auto;
}

.preview-list {
    max-height: 150px;
    overflow-y: auto;
    margin: 12px 0;
}

.preview-item {
    padding: 8px;
    border-bottom: 1px solid #eaeaea;
    font-size: 13px;
    color: #2c3e50;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.preview-item:last-child {
    border-bottom: none;
}

.preview-date {
    color: #7f8c8d;
    font-size: 12px;
    min-width: 70px;
}

.preview-content {
    flex: 1;
    margin: 0 12px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.preview-label {
    font-size: 11px;
    padding: 2px 6px;
    border-radius: 4px;
    background-color: #ecf0f1;
    color: #2c3e50;
}

.preview-stats {
    text-align: center;
    font-size: 14px;
    color: #7f8c8d;
    margin-top: 12px;
    padding-top: 12px;
    border-top: 1px solid #eaeaea;
}

.storage-actions {
    display: flex;
    gap: 12px;
    margin-top: 20px;
}

.dialog-btn.delete {
    background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
    color: #ffffff;
}

.dialog-btn.delete:hover {
    background: linear-gradient(135deg, #c0392b 0%, #a93226 100%);
}

.dialog-btn.delete:disabled {
    background: #bdc3c7;
    cursor: not-allowed;
    transform: none;
}
.mic-btn {
    width: 44px;
    height: 44px;
    border: none;
    border-radius: 50%;
    background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
    color: #ffffff;
    cursor: not-allowed;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    margin-left: 8px;
    opacity: 0.7;
}
.mic-btn.active {
    background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
    cursor: pointer;
    opacity: 1;
}
.mic-btn.recording {
    background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
    animation: pulse 1s infinite;
}
@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); }
}
    </style>
</head>
<body>
    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <div class="top-bar">
        <button class="nav-btn" id="menuBtn" title="æ‰“å¼€æ ‡ç­¾ç®¡ç†">
            <i class="fas fa-bars"></i>
        </button>
        <div class="nav-title" id="currentTabName">èŠå¤©1</div>
        <button class="nav-btn" id="settingsBtn" title="æ‰“å¼€è®¾ç½®">
            <i class="fas fa-cog"></i>
        </button>
    </div>

    <!-- èŠå¤©å†…å®¹åŒºåŸŸ -->
    <div class="chat-container" id="chatContainer">
        <!-- æ¶ˆæ¯ä¼šåŠ¨æ€æ·»åŠ åœ¨è¿™é‡Œ -->
        <div class="empty-state" id="emptyState">
            <div class="empty-icon">ğŸ’¬</div>
            <div class="empty-title">èŠå¤©å¼è®°äº‹æœ¬</div>
            <div class="empty-text">åœ¨è¿™é‡Œè®°å½•æ‚¨çš„æƒ³æ³•ã€çµæ„Ÿå’Œå¾…åŠäº‹é¡¹</div>
            <div class="empty-text" style="margin-top: 16px;">ç‚¹å‡»ä¸‹æ–¹å¼€å§‹è¾“å…¥...</div>
        </div>
    </div>

    <!-- è¾“å…¥åŒºåŸŸ -->
    <div class="input-container" id="inputContainer">
        <div class="message-input-container">
            <textarea 
                class="message-input" 
                id="messageInput" 
                placeholder="è¿™é‡Œè¾“å…¥..."
                rows="1"
            ></textarea>
        </div>
        <div class="input-toolbar">
            <div class="toolbar-left">
                <button class="format-btn" id="boldBtn" title="åŠ ç²—">
                    B
                </button>
                <button class="format-btn" id="italicBtn" title="æ–œä½“">
                    I
                </button>
                <button class="format-btn" id="underlineBtn" title="ä¸‹åˆ’çº¿">
                    U
                </button>
                <button class="format-btn" id="strikeBtn" title="åˆ é™¤çº¿">
                    S
                </button>
                <button class="tag-btn important" id="importantBtn" title="æ ‡è®°é‡è¦">
                    !
                </button>
                <button class="tag-btn todo" id="todoBtn" title="æ ‡è®°å¾…åŠ">
                    âœ“
                </button>
            </div>
<div class="toolbar-right">
    <button class="mic-btn" id="micBtn" title="é•¿æŒ‰è¯­éŸ³è¾“å…¥ï¼ˆéœ€è¦å…ˆä¸‹è½½æ¨¡å‹ï¼‰" disabled>
        <i class="fas fa-microphone"></i>
    </button>
    <button class="send-btn" id="sendBtn">
        <i class="fas fa-paper-plane"></i>
    </button>
</div>
        </div>
    </div>

    <!-- åœ†å½¢åŠ å·æŒ‰é’® -->
    <div class="quick-actions">
        <div class="quick-sub-buttons" id="quickSubButtons">
            <button class="quick-sub-btn todo" id="todoListBtn" title="å¾…åŠåˆ—è¡¨">
                <i class="fas fa-tasks"></i>
            </button>
            <button class="quick-sub-btn completed" id="completedListBtn" title="å®Œæˆåˆ—è¡¨">
                <i class="fas fa-check-double"></i>
            </button>
            <button class="quick-sub-btn important" id="importantListBtn" title="é‡è¦åˆ—è¡¨">
                <i class="fas fa-star"></i>
            </button>
        </div>
        <button class="quick-main-btn" id="quickMainBtn" title="å¿«é€Ÿæ“ä½œ">
            <i class="fas fa-plus"></i>
        </button>
    </div>

    <!-- æ°”æ³¡èœå• -->
    <div class="bubble-menu" id="bubbleMenu">
        <!-- æ³¨æ„ï¼šåŠ©æ‰‹æ¶ˆæ¯çš„åŒå‡»èœå•ä¼šåŠ¨æ€ä¿®æ”¹ï¼Œåªæ˜¾ç¤ºåˆ é™¤æŒ‰é’® -->
    </div>

    <!-- ä¾§æ»‘èœå• - æ ‡ç­¾ç®¡ç† -->
    <div class="side-menu" id="sideMenu">
        <div class="menu-header">
            <div class="menu-title">
                <i class="fas fa-comments"></i> èŠå¤©æ ‡ç­¾
            </div>
        </div>
        <div class="tabs-list" id="tabsList">
            <!-- æ ‡ç­¾ä¼šåŠ¨æ€æ·»åŠ åœ¨è¿™é‡Œ -->
        </div>
        <div class="menu-actions">
            <button class="new-tab-btn" id="newTabBtn">
                <i class="fas fa-plus"></i> æ–°å»ºèŠå¤©
            </button>
        </div>
    </div>
    <div class="menu-overlay" id="menuOverlay"></div>

    <!-- è®¾ç½®èœå• - åº•éƒ¨å¼¹å‡º -->
    <div class="settings-menu" id="settingsMenu">
        <div class="settings-header">
            <div class="settings-title">è®¾ç½®</div>
            <button class="close-settings" id="closeSettingsBtn">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="settings-options">
            <div class="settings-option" id="usernameOption">
                <span class="option-text">ä¿®æ”¹ç”¨æˆ·å</span>
                <i class="fas fa-chevron-right option-icon"></i>
            </div>
            <div class="settings-option" id="assistantOption">
                <span class="option-text">ä¿®æ”¹åŠ©æ‰‹åç§°</span>
                <i class="fas fa-chevron-right option-icon"></i>
            </div>
            <div class="settings-option" id="replyContentOption">
                <span class="option-text">è‡ªåŠ¨å›å¤æ¦‚ç‡åŠå†…å®¹</span>
                <i class="fas fa-chevron-right option-icon"></i>
            </div>
            <div class="settings-option" id="sendKeyOption">
                <span class="option-text">å‘é€é”®è®¾ç½®</span>
                <span class="option-value" id="sendKeyValue">Enterå‘é€</span>
                <i class="fas fa-chevron-right option-icon"></i>
            </div>
            <div class="settings-option" id="fontSizeOption">
                <span class="option-text">æ°”æ³¡å­—ä½“å¤§å°</span>
                <span class="option-value" id="fontSizeValue">16px</span>
                <i class="fas fa-chevron-right option-icon"></i>
            </div>
            <div class="settings-option" id="voiceModelOption">
                <span class="option-text">è¯­éŸ³æ¨¡å‹ç®¡ç†</span>
                <span class="option-value" id="modelStatusValue">æœªä¸‹è½½</span>
                <i class="fas fa-chevron-right option-icon"></i>
            </div>    
            <div class="settings-option" id="clearCacheOption">
                <span class="option-text">æ¸…é™¤æ‰€æœ‰ç”¨æˆ·è®¾å®šå’Œç¼“å­˜</span>
                <i class="fas fa-chevron-right option-icon"></i>
            </div>
            <div class="settings-option" id="searchOption">
            <span class="option-text">æœç´¢èŠå¤©è®°å½•</span>
            <i class="fas fa-chevron-right option-icon"></i>
            </div>
            <div class="settings-option" id="exportOption">
                <span class="option-text">å¯¼å‡ºèŠå¤©è®°å½•</span>
                <span style="color:#95a5a6; font-size:14px;">ä»…Excelæ ¼å¼ï¼Œå…¶ä»–æ­£åœ¨å¼€å‘ä¸­</span>
                <i class="fas fa-chevron-right option-icon"></i>
            </div>
            <div class="settings-option" id="storageOption">
            <span class="option-text">å‚¨å­˜ç©ºé—´ç®¡ç†</span>
            <span class="option-value" id="storageUsage">æ£€æŸ¥ä¸­...</span>
            <i class="fas fa-chevron-right option-icon"></i>
            </div>
            <div class="settings-option" id="themeOption">
                <span class="option-text">é¢œè‰²ä¸»é¢˜</span>
                <i class="fas fa-chevron-right option-icon"></i>
            </div>
            <div class="settings-option" id="aboutOption">
                <span class="option-text">å…³äº</span>
                <i class="fas fa-chevron-right option-icon"></i>
            </div>
        </div>
    </div>

    <!-- ç”¨æˆ·åä¿®æ”¹å¼¹çª— -->
    <div class="username-dialog" id="usernameDialog">
        <div class="dialog-header">
            <div class="dialog-title">ä¿®æ”¹ç”¨æˆ·å</div>
            <div class="dialog-text">è®¾ç½®æ‚¨æƒ³è¦æ˜¾ç¤ºçš„ç”¨æˆ·å</div>
        </div>
        <input type="text" class="username-input" id="usernameInput" placeholder="è¯·è¾“å…¥ç”¨æˆ·å" maxlength="20">
        <div class="dialog-actions">
            <button class="dialog-btn cancel" id="cancelUsernameBtn">å–æ¶ˆ</button>
            <button class="dialog-btn save" id="saveUsernameBtn">ä¿å­˜</button>
        </div>
    </div>

    <!-- ç¡®è®¤å¯¹è¯æ¡† -->
    <div class="confirm-dialog" id="confirmDialog">
        <div class="dialog-header">
            <div class="dialog-title" id="confirmTitle">ç¡®è®¤æ“ä½œ</div>
        </div>
        <div class="confirm-message" id="confirmMessage"></div>
        <div class="dialog-actions">
            <button class="dialog-btn cancel" id="cancelConfirmBtn">å–æ¶ˆ</button>
            <button class="dialog-btn save" id="confirmBtn">ç¡®è®¤</button>
        </div>
    </div>

    <!-- é‡å‘½åå¯¹è¯æ¡† -->
    <div class="rename-dialog" id="renameDialog">
        <div class="dialog-header">
            <div class="dialog-title">é‡å‘½åæ ‡ç­¾</div>
            <div class="dialog-text">è¯·è¾“å…¥æ–°çš„æ ‡ç­¾åç§°</div>
        </div>
        <input type="text" class="rename-input" id="renameInput" placeholder="è¯·è¾“å…¥æ ‡ç­¾åç§°" maxlength="20">
        <div class="dialog-actions">
            <button class="dialog-btn cancel" id="cancelRenameBtn">å–æ¶ˆ</button>
            <button class="dialog-btn save" id="saveRenameBtn">ä¿å­˜</button>
        </div>
    </div>

    <!-- åŠ©æ‰‹åç§°å¯¹è¯æ¡† -->
    <div class="assistant-dialog" id="assistantDialog">
        <div class="dialog-header">
            <div class="dialog-title">ä¿®æ”¹åŠ©æ‰‹åç§°</div>
            <div class="dialog-text">è®¾ç½®è‡ªåŠ¨å›å¤åŠ©æ‰‹çš„æ˜¾ç¤ºåç§°</div>
        </div>
        <input type="text" class="assistant-input" id="assistantInput" placeholder="è¯·è¾“å…¥åŠ©æ‰‹åç§°" maxlength="20">
        <div class="dialog-actions">
            <button class="dialog-btn cancel" id="cancelAssistantBtn">å–æ¶ˆ</button>
            <button class="dialog-btn save" id="saveAssistantBtn">ä¿å­˜</button>
        </div>
    </div>

<!-- å‚¨å­˜ç©ºé—´ç®¡ç†å¯¹è¯æ¡† -->
<div class="storage-dialog" id="storageDialog">
    <div class="dialog-header">
        <div class="dialog-title">å‚¨å­˜ç©ºé—´ç®¡ç†</div>
        <div class="dialog-text">ç®¡ç†æ‚¨çš„èŠå¤©è®°å½•å‚¨å­˜ç©ºé—´</div>
    </div>
    
    <!-- å‚¨å­˜ä½¿ç”¨æƒ…å†µç»Ÿè®¡ -->
    <div class="storage-summary" id="storageSummary">
        <div class="storage-item">
            <span class="storage-label">æ€»æ¶ˆæ¯æ•°ï¼š</span>
            <span class="storage-value" id="totalMessages">0</span>
        </div>
        <div class="storage-item">
            <span class="storage-label">æ ‡ç­¾æ•°é‡ï¼š</span>
            <span class="storage-value" id="totalTabs">0</span>
        </div>
        <div class="storage-item">
            <span class="storage-label">æ€»å‚¨å­˜é‡ï¼š</span>
            <span class="storage-value" id="totalStorage">0 KB</span>
        </div>
    </div>
    
    <!-- æ—¶é—´é€‰æ‹©å™¨ -->
    <div class="time-range-selector">
        <div class="dialog-text">é€‰æ‹©åˆ é™¤çš„æ—¶é—´èŒƒå›´ï¼š</div>
        <div class="date-inputs">
            <div class="date-input-group">
                <label for="startDate">å¼€å§‹æ—¥æœŸï¼š</label>
                <input type="date" class="date-input" id="startDate">
            </div>
            <div class="date-input-group">
                <label for="endDate">ç»“æŸæ—¥æœŸï¼š</label>
                <input type="date" class="date-input" id="endDate">
            </div>
        </div>
        <div class="quick-buttons">
            <button class="time-range-btn" data-range="7d">æœ€è¿‘7å¤©</button>
            <button class="time-range-btn" data-range="30d">æœ€è¿‘30å¤©</button>
            <button class="time-range-btn" data-range="all">å…¨éƒ¨æ—¶é—´</button>
        </div>
    </div>
    
    <!-- é¢„è§ˆåŒºåŸŸ -->
    <div class="preview-section">
        <div class="dialog-text">å°†åˆ é™¤çš„æ¶ˆæ¯ï¼š</div>
        <div class="preview-list" id="previewList">
            <!-- é¢„è§ˆå†…å®¹å°†åŠ¨æ€æ˜¾ç¤ºåœ¨è¿™é‡Œ -->
        </div>
        <div class="preview-stats" id="previewStats">
            æ— é€‰ä¸­æ¶ˆæ¯
        </div>
    </div>
    
    <!-- æ“ä½œæŒ‰é’® -->
    <div class="storage-actions">
        <button class="dialog-btn cancel" id="cancelStorageBtn">å–æ¶ˆ</button>
        <button class="dialog-btn delete" id="deleteSelectedBtn" disabled>åˆ é™¤é€‰ä¸­</button>
    </div>
</div>

    <!-- å‘é€æ–¹å¼è®¾ç½®å¯¹è¯æ¡† -->
    <div class="send-key-dialog" id="sendKeyDialog">
        <div class="dialog-header">
            <div class="dialog-title">å‘é€é”®è®¾ç½®</div>
            <div class="dialog-text">é€‰æ‹©æŒ‰Enteré”®æ—¶çš„è¡Œä¸º</div>
        </div>
        <div class="dialog-options">
            <div class="send-key-option" data-value="enter">
                <div class="option-radio"></div>
                <div class="option-text-full">
                    <div class="option-title">Enterå‘é€æ¶ˆæ¯</div>
                    <div class="option-desc">æŒ‰Enteré”®ç›´æ¥å‘é€æ¶ˆæ¯ï¼ŒShift+Enteræ¢è¡Œ</div>
                </div>
            </div>
            <div class="send-key-option" data-value="shift-enter">
                <div class="option-radio"></div>
                <div class="option-text-full">
                    <div class="option-title">Enteræ¢è¡Œ</div>
                    <div class="option-desc">æŒ‰Enteré”®æ¢è¡Œï¼ŒShift+Enterå‘é€æ¶ˆæ¯</div>
                </div>
            </div>
        </div>
        <div class="dialog-actions">
            <button class="dialog-btn cancel" id="cancelSendKeyBtn">å–æ¶ˆ</button>
            <button class="dialog-btn save" id="saveSendKeyBtn">ä¿å­˜</button>
        </div>
    </div>

    <!-- å­—ä½“å¤§å°è®¾ç½®å¯¹è¯æ¡† -->
    <div class="font-size-dialog" id="fontSizeDialog">
        <div class="dialog-header">
            <div class="dialog-title">æ°”æ³¡å­—ä½“å¤§å°</div>
            <div class="dialog-text">è°ƒæ•´å¯¹è¯æ°”æ³¡ä¸­çš„å­—ä½“å¤§å°</div>
        </div>
        
        <div class="font-size-value" id="fontSizeDisplay">16px</div>
        <input type="range" class="font-size-slider" id="fontSizeSlider" min="12" max="24" step="1" value="16">
        
        <div class="dialog-actions" style="margin-top: 24px;">
            <button class="dialog-btn cancel" id="cancelFontSizeBtn">å–æ¶ˆ</button>
            <button class="dialog-btn save" id="saveFontSizeBtn">ä¿å­˜</button>
        </div>
    </div>

    <!-- è‡ªåŠ¨å›å¤å†…å®¹ç®¡ç†å¯¹è¯æ¡† -->
    <div class="reply-content-dialog" id="replyContentDialog">
        <div class="dialog-header">
            <div class="dialog-title">è‡ªåŠ¨å›å¤è®¾ç½®</div>
            <div class="dialog-text">è®¾ç½®è‡ªåŠ¨å›å¤æ¦‚ç‡å’Œç®¡ç†å›å¤å†…å®¹</div>
        </div>
        
        <div class="probability-value" id="probabilityDisplay">æ¦‚ç‡: 70%</div>
        <input type="range" class="probability-slider" id="probabilitySlider" min="0" max="100" step="10" value="70">
        
        <div style="margin-top: 24px;">
            <div class="dialog-text">è‡ªåŠ¨å›å¤å†…å®¹åˆ—è¡¨ï¼š</div>
            <div class="reply-list" id="replyList">
                <!-- å›å¤å†…å®¹ä¼šåŠ¨æ€æ·»åŠ åœ¨è¿™é‡Œ -->
            </div>
        </div>
        
        <div class="add-reply-container">
            <input type="text" class="add-reply-input" id="addReplyInput" placeholder="è¾“å…¥æ–°çš„å›å¤å†…å®¹" maxlength="100">
            <button class="add-reply-btn" id="addReplyBtn">
                <i class="fas fa-plus"></i>
            </button>
        </div>
        
        <div class="dialog-actions" style="margin-top: 24px;">
            <button class="dialog-btn cancel" id="cancelReplyContentBtn">å–æ¶ˆ</button>
            <button class="dialog-btn save" id="saveReplyContentBtn">ä¿å­˜</button>
        </div>
    </div>
<!-- è¯­éŸ³æ¨¡å‹ç®¡ç†å¯¹è¯æ¡† -->
<div class="confirm-dialog" id="voiceModelDialog">
    <div class="dialog-header">
        <div class="dialog-title">è¯­éŸ³æ¨¡å‹ç®¡ç†</div>
        <div class="dialog-text" id="modelDetailText"></div>
    </div>
    <div style="padding: 20px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
            <span style="font-size: 16px; color: #2c3e50;">æ¨¡å‹ï¼šWhisper tinyï¼ˆä¸­æ–‡ï¼‰</span>
            <span id="modelSizeLabel" style="font-size: 14px; color: #7f8c8d;">çº¦75MB</span>
        </div>
        <div id="modelProgressContainer" style="display: none; margin: 16px 0;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                <span>ä¸‹è½½è¿›åº¦</span>
                <span id="modelProgressPercent">0%</span>
            </div>
            <div style="width: 100%; height: 8px; background-color: #ecf0f1; border-radius: 4px;">
                <div id="modelProgressBar" style="width: 0%; height: 100%; background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%); border-radius: 4px;"></div>
            </div>
        </div>
        <div id="modelButtons">
            <button class="dialog-btn save" id="downloadModelBtn" style="width: 100%;">ä¸‹è½½æ¨¡å‹</button>
            <button class="dialog-btn cancel" id="deleteModelBtn" style="width: 100%; margin-top: 12px; display: none;">åˆ é™¤æ¨¡å‹</button>
        </div>
    </div>
    <div class="dialog-actions" style="padding: 0 24px 24px;">
        <button class="dialog-btn cancel" id="closeModelDialogBtn">å…³é—­</button>
    </div>
</div>
    <script>
        // çŠ¶æ€ç®¡ç†
        const state = {
            messages: [],
            username: 'æˆ‘',
            assistantName: 'åŠ©æ‰‹',
            tabs: [
                { id: 1, name: 'èŠå¤©1', messages: [], active: true, pinned: false },
                { id: 2, name: 'èŠå¤©2', messages: [], active: false, pinned: false },
                { id: 3, name: 'èŠå¤©3', messages: [], active: false, pinned: false }
            ],
            currentTabId: 1,
            autoReplyProbability: 70,
            autoReplies: [
                "æ”¶åˆ°ï¼å·²è®°å½•ã€‚",
                "æ˜ç™½ï¼Œç»§ç»­è¯´å§ã€‚",
                "å¥½çš„ï¼Œæˆ‘åœ¨å¬ã€‚",
                "å—¯ï¼Œæœ‰é“ç†ã€‚",
                "æ˜¯çš„ï¼Œæˆ‘åŒæ„ã€‚",
                "äº†è§£äº†ï¼Œè°¢è°¢åˆ†äº«ã€‚",
                "è¿™ä¸ªæƒ³æ³•ä¸é”™ï¼",
                "ç»§ç»­ï¼Œæˆ‘åœ¨è®¤çœŸè®°å½•ã€‚",
                "å¥½çš„ï¼Œè¿˜æœ‰ä»€ä¹ˆè¦è¡¥å……çš„å—ï¼Ÿ",
                "å·²æ”¶åˆ°ï¼Œè¯·ç»§ç»­ã€‚"
            ],
            completedTodos: {},
            assistantTodoMap: {},
            assistantTodoStates: {},
            assistantTodoTableMessages: {}, // è®°å½•åŠ©æ‰‹ç”Ÿæˆçš„å¾…åŠè¡¨æ ¼æ¶ˆæ¯ID
            settings: {
                sendKey: 'enter', // é»˜è®¤Enterå‘é€
                theme: 'light',
                fontSize: 16 // é»˜è®¤å­—ä½“å¤§å°
            },
            selectedMessage: null,
            lastTapTime: 0,
            tapTimeout: null,
            quickMenuOpen: false,
            voice: {} 
        };
        window.state = state;

        // DOMå…ƒç´ å¼•ç”¨
        const chatContainer = document.getElementById('chatContainer');
        const emptyState = document.getElementById('emptyState');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const currentTabName = document.getElementById('currentTabName');
        const sideMenu = document.getElementById('sideMenu');
        const menuOverlay = document.getElementById('menuOverlay');
        const menuBtn = document.getElementById('menuBtn');
        const settingsMenu = document.getElementById('settingsMenu');
        const settingsBtn = document.getElementById('settingsBtn');
        const closeSettingsBtn = document.getElementById('closeSettingsBtn');
        const tabsList = document.getElementById('tabsList');
        const newTabBtn = document.getElementById('newTabBtn');
        const inputContainer = document.getElementById('inputContainer');
        
        // æ ¼å¼æŒ‰é’®
        const boldBtn = document.getElementById('boldBtn');
        const italicBtn = document.getElementById('italicBtn');
        const underlineBtn = document.getElementById('underlineBtn');
        const strikeBtn = document.getElementById('strikeBtn');
        const importantBtn = document.getElementById('importantBtn');
        const todoBtn = document.getElementById('todoBtn');
        
        // å¿«é€ŸæŒ‰é’®
        const quickMainBtn = document.getElementById('quickMainBtn');
        const quickSubButtons = document.getElementById('quickSubButtons');
        const todoListBtn = document.getElementById('todoListBtn');
        const completedListBtn = document.getElementById('completedListBtn');
        const importantListBtn = document.getElementById('importantListBtn');
        
        // æ°”æ³¡èœå•
        const bubbleMenu = document.getElementById('bubbleMenu');
        
        // å¯¹è¯æ¡†
        const usernameDialog = document.getElementById('usernameDialog');
        const usernameInput = document.getElementById('usernameInput');
        const saveUsernameBtn = document.getElementById('saveUsernameBtn');
        const cancelUsernameBtn = document.getElementById('cancelUsernameBtn');
        
        const confirmDialog = document.getElementById('confirmDialog');
        const confirmTitle = document.getElementById('confirmTitle');
        const confirmMessage = document.getElementById('confirmMessage');
        const confirmBtn = document.getElementById('confirmBtn');
        const cancelConfirmBtn = document.getElementById('cancelConfirmBtn');
        
        const renameDialog = document.getElementById('renameDialog');
        const renameInput = document.getElementById('renameInput');
        const saveRenameBtn = document.getElementById('saveRenameBtn');
        const cancelRenameBtn = document.getElementById('cancelRenameBtn');
        
        const assistantDialog = document.getElementById('assistantDialog');
        const assistantInput = document.getElementById('assistantInput');
        const saveAssistantBtn = document.getElementById('saveAssistantBtn');
        const cancelAssistantBtn = document.getElementById('cancelAssistantBtn');
        
        const replyContentDialog = document.getElementById('replyContentDialog');
        const probabilitySlider = document.getElementById('probabilitySlider');
        const probabilityDisplay = document.getElementById('probabilityDisplay');
        const replyList = document.getElementById('replyList');
        const addReplyInput = document.getElementById('addReplyInput');
        const addReplyBtn = document.getElementById('addReplyBtn');
        const saveReplyContentBtn = document.getElementById('saveReplyContentBtn');
        const cancelReplyContentBtn = document.getElementById('cancelReplyContentBtn');
        const replyContentOption = document.getElementById('replyContentOption');
        const clearCacheOption = document.getElementById('clearCacheOption');
        
        // å­—ä½“å¤§å°è®¾ç½®
        const fontSizeOption = document.getElementById('fontSizeOption');
        const fontSizeValue = document.getElementById('fontSizeValue');
        const fontSizeDialog = document.getElementById('fontSizeDialog');
        const fontSizeSlider = document.getElementById('fontSizeSlider');
        const fontSizeDisplay = document.getElementById('fontSizeDisplay');
        const saveFontSizeBtn = document.getElementById('saveFontSizeBtn');
        const cancelFontSizeBtn = document.getElementById('cancelFontSizeBtn');
        
        // å‘é€æ–¹å¼è®¾ç½®
        const sendKeyOption = document.getElementById('sendKeyOption');
        const sendKeyValue = document.getElementById('sendKeyValue');
        const sendKeyDialog = document.getElementById('sendKeyDialog');
        const cancelSendKeyBtn = document.getElementById('cancelSendKeyBtn');
        const saveSendKeyBtn = document.getElementById('saveSendKeyBtn');

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            loadFromLocalStorage();
            updateCurrentTab();
            renderMessages();
            updateTabsList();

    if ('serviceWorker' in navigator) {
        // ç«‹å³æ³¨å†ŒService Workerï¼Œä¸ç­‰å¾…loadäº‹ä»¶
        navigator.serviceWorker.register('sw.js').then(registration => {
            console.log('ServiceWorkeræ³¨å†ŒæˆåŠŸ:', registration.scope);
            
            // æ˜¾ç¤ºå®‰è£…æç¤º
            showInstallPrompt();
        }).catch(err => {
            console.log('ServiceWorkeræ³¨å†Œå¤±è´¥:', err);
        });
    }
   
            setupEventListeners();
         
            const currentTab = state.tabs.find(t => t.id === state.currentTabId);
            if (currentTab) {
                currentTabName.textContent = currentTab.name;
            }
            
            // æ›´æ–°å‘é€æ–¹å¼æ˜¾ç¤º
            updateSendKeyDisplay();
            
            // æ›´æ–°å­—ä½“å¤§å°æ˜¾ç¤º
            updateFontSizeDisplay();
            
            updateProbabilityDisplay();
            updateReplyList();
            // æ›´æ–°å‚¨å­˜ä½¿ç”¨æƒ…å†µæ˜¾ç¤º
           updateStorageStats();

           // è®¾ç½®å‚¨å­˜ä½¿ç”¨æƒ…å†µåˆå§‹æ˜¾ç¤º
           document.getElementById('storageUsage').textContent = 'æ£€æŸ¥ä¸­...';
           setTimeout(() => {
               updateStorageStats();
           }, 500);

           // å¤„ç†å¿«æ·æ–¹å¼å‚æ•°
           handleShortcutActions();  
           });

function showInstallPrompt() {
    let deferredPrompt;
    
    window.addEventListener('beforeinstallprompt', (e) => {
        // é˜»æ­¢è‡ªåŠ¨æ˜¾ç¤ºå®‰è£…æç¤º
        e.preventDefault();
        deferredPrompt = e;
        
        // æ£€æŸ¥æ˜¯å¦å·²ç»å®‰è£…
        if (window.matchMedia('(display-mode: standalone)').matches) {
            // å¦‚æœå·²ç»å®‰è£…ï¼Œç§»é™¤æŒ‰é’®ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            const existingBtn = document.getElementById('installBtn');
            if (existingBtn) {
                existingBtn.remove();
            }
            return;
        }
        
        // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨å®‰è£…æŒ‰é’®
        let installBtn = document.getElementById('installBtn');
        
        if (!installBtn) {
            // åˆ›å»ºå®‰è£…æŒ‰é’®
            installBtn = document.createElement('button');
            installBtn.innerHTML = '<i class="fas fa-download"></i>';
            installBtn.className = 'nav-btn';
            installBtn.title = 'å®‰è£…åº”ç”¨';
            installBtn.style.marginLeft = '8px';
            installBtn.id = 'installBtn';
            
            // æ·»åŠ åˆ°è®¾ç½®æŒ‰é’®å‰é¢
            const settingsBtn = document.getElementById('settingsBtn');
            if (settingsBtn) {
                settingsBtn.parentNode.insertBefore(installBtn, settingsBtn);
            }
            
            // æ·»åŠ ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨ï¼ˆåªæ·»åŠ ä¸€æ¬¡ï¼‰
            installBtn.addEventListener('click', async () => {
                if (!deferredPrompt) return;
                
                try {
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    
                    if (outcome === 'accepted') {
                        console.log('ç”¨æˆ·æ¥å—äº†å®‰è£…æç¤º');
                        // å®‰è£…æˆåŠŸåç§»é™¤æŒ‰é’®
                        if (installBtn) {
                            installBtn.style.display = 'none';
                            installBtn.remove();
                        }
                    } else {
                        console.log('ç”¨æˆ·å–æ¶ˆäº†å®‰è£…');
                        // ç”¨æˆ·å–æ¶ˆå®‰è£…ï¼Œä¿ç•™æŒ‰é’®ä½†ä¸ç§»é™¤ï¼Œå…è®¸å†æ¬¡å°è¯•
                        // é‡ç½® deferredPrompt ä»¥ä¾¿ä¸‹æ¬¡ä½¿ç”¨
                        deferredPrompt = null;
                    }
                } catch (error) {
                    console.error('å®‰è£…è¿‡ç¨‹ä¸­å‡ºé”™:', error);
                    deferredPrompt = null;
                }
            });
        } else {
            // å¦‚æœæŒ‰é’®å·²å­˜åœ¨ï¼Œç¡®ä¿å®ƒæ˜¯å¯è§çš„
            installBtn.style.display = 'flex';
        }
    });
    
    // æ·»åŠ ä¸€ä¸ªæ£€æµ‹å®‰è£…çŠ¶æ€çš„å˜åŒ–ç›‘å¬å™¨
    window.addEventListener('appinstalled', () => {
        console.log('åº”ç”¨å·²å®‰è£…');
        // ç§»é™¤å®‰è£…æŒ‰é’®
        const installBtn = document.getElementById('installBtn');
        if (installBtn) {
            installBtn.remove();
        }
    });
}

        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            // å‘é€æŒ‰é’®
            sendBtn.addEventListener('click', sendMessage);
            
            // è¾“å…¥æ¡†è¾“å…¥ç›‘å¬
            messageInput.addEventListener('input', handleInputChange);
            messageInput.addEventListener('focus', handleInputFocus);
            messageInput.addEventListener('blur', handleInputBlur);
            
            // è¾“å…¥æ¡†æŒ‰é”®ç›‘å¬
            messageInput.addEventListener('keydown', handleKeyDown);
            
            // è¾“å…¥æ³•å¤„ç†
            messageInput.addEventListener('compositionstart', () => {
                window.isComposing = true;
            });
            
            messageInput.addEventListener('compositionend', () => {
                window.isComposing = false;
            });
            
            // èœå•æŒ‰é’®
            menuBtn.addEventListener('click', openSideMenu);
            menuOverlay.addEventListener('click', (e) => {
                e.stopPropagation();
                closeAllMenusAndDialogs();
            });
            
            // è®¾ç½®æŒ‰é’®
            settingsBtn.addEventListener('click', openSettingsMenu);
            closeSettingsBtn.addEventListener('click', closeSettingsMenu);
            
            // æ–°å»ºæ ‡ç­¾æŒ‰é’®
            newTabBtn.addEventListener('click', createNewTab);
            
            // æ ¼å¼æŒ‰é’®
            boldBtn.addEventListener('click', () => insertFormatting('[b]', '[/b]'));
            italicBtn.addEventListener('click', () => insertFormatting('[i]', '[/i]'));
            underlineBtn.addEventListener('click', () => insertFormatting('[u]', '[/u]'));
            strikeBtn.addEventListener('click', () => insertFormatting('[s]', '[/s]'));
            
            // æ ‡ç­¾æŒ‰é’®
            importantBtn.addEventListener('click', () => insertText('[é‡è¦] '));
            todoBtn.addEventListener('click', () => insertText('[å¾…åŠ] '));
            
            // å¿«é€ŸæŒ‰é’®
            quickMainBtn.addEventListener('click', toggleQuickMenu);
            todoListBtn.addEventListener('click', () => sendQueryToAssistant('todo'));
            completedListBtn.addEventListener('click', () => sendQueryToAssistant('completed'));
            importantListBtn.addEventListener('click', () => sendQueryToAssistant('important'));
            
            // ç”¨æˆ·åä¿®æ”¹
            document.getElementById('usernameOption').addEventListener('click', () => {
                closeSettingsMenu();
                openUsernameDialog();
            });
            
            saveUsernameBtn.addEventListener('click', saveUsername);
            cancelUsernameBtn.addEventListener('click', closeUsernameDialog);
            
            // åŠ©æ‰‹åç§°ä¿®æ”¹
            document.getElementById('assistantOption').addEventListener('click', () => {
                closeSettingsMenu();
                openAssistantDialog();
            });
            
            saveAssistantBtn.addEventListener('click', saveAssistantName);
            cancelAssistantBtn.addEventListener('click', closeAssistantDialog);
            
            // å­—ä½“å¤§å°è®¾ç½®
            fontSizeOption.addEventListener('click', () => {
                closeSettingsMenu();
                openFontSizeDialog();
            });
            
            fontSizeSlider.addEventListener('input', () => {
                fontSizeDisplay.textContent = fontSizeSlider.value + 'px';
            });
            
            saveFontSizeBtn.addEventListener('click', saveFontSizeSetting);
            cancelFontSizeBtn.addEventListener('click', closeFontSizeDialog);
            
            // è‡ªåŠ¨å›å¤å†…å®¹ç®¡ç†
            replyContentOption.addEventListener('click', () => {
                closeSettingsMenu();
                openReplyContentDialog();
            });
            
            probabilitySlider.addEventListener('input', () => {
                probabilityDisplay.textContent = `æ¦‚ç‡: ${probabilitySlider.value}%`;
            });
            
            addReplyBtn.addEventListener('click', addNewReply);
            addReplyInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    addNewReply();
                }
            });
            
            saveReplyContentBtn.addEventListener('click', saveReplyContentSettings);
            cancelReplyContentBtn.addEventListener('click', closeReplyContentDialog);
            
            // å‘é€æ–¹å¼è®¾ç½®
            sendKeyOption.addEventListener('click', () => {
                closeSettingsMenu();
                openSendKeyDialog();
            });
            
            saveSendKeyBtn.addEventListener('click', saveSendKeySetting);
            cancelSendKeyBtn.addEventListener('click', closeSendKeyDialog);
            
            // æ¸…é™¤æ‰€æœ‰ç”¨æˆ·è®¾å®šå’Œç¼“å­˜
            clearCacheOption.addEventListener('click', () => {
                closeSettingsMenu();
                showClearCacheConfirm();
            });
            
            // ç¡®è®¤å¯¹è¯æ¡†æŒ‰é’®
            confirmBtn.addEventListener('click', handleConfirmAction);
            cancelConfirmBtn.addEventListener('click', closeConfirmDialog);
            
            // é‡å‘½åå¯¹è¯æ¡†æŒ‰é’®
            saveRenameBtn.addEventListener('click', saveRename);
            cancelRenameBtn.addEventListener('click', closeRenameDialog);
            
            // è®¾ç½®é€‰é¡¹
            document.getElementById('exportOption').addEventListener('click', () => {
                closeSettingsMenu();
                showExportInfo();
            });
            
            document.getElementById('themeOption').addEventListener('click', () => {
                toggleTheme();
                closeSettingsMenu();
            });
            
            document.getElementById('aboutOption').addEventListener('click', () => {
                closeSettingsMenu();
                showAboutInfo();
            });
            
            // ç‚¹å‡»å¤–éƒ¨å…³é—­èœå•
            document.addEventListener('click', (e) => {
                if (!bubbleMenu.contains(e.target) && bubbleMenu.classList.contains('show')) {
                    closeBubbleMenu();
                }
                if (!quickMainBtn.contains(e.target) && !quickSubButtons.contains(e.target)) {
                    closeQuickMenu();
                }
            });
            
            // å¤„ç†çª—å£å¤§å°å˜åŒ–
            window.addEventListener('resize', handleResize);
            
            // åŒå‡»äº‹ä»¶
            setupDoubleClickEvents();

            // æœç´¢èŠå¤©è®°å½•
            document.getElementById('searchOption').addEventListener('click', () => {
            closeSettingsMenu();
            window.location.href = 'search.html';
            });
            
            // å‚¨å­˜ç©ºé—´ç®¡ç†é€‰é¡¹
            document.getElementById('storageOption').addEventListener('click', () => {
            closeSettingsMenu();
            openStorageDialog();
            });

// è·å–å¯¹è¯æ¡†å…ƒç´ å¹¶æ·»åŠ äº‹ä»¶
const storageDialog = document.getElementById('storageDialog');
const cancelStorageBtn = document.getElementById('cancelStorageBtn');
const deleteSelectedBtn = document.getElementById('deleteSelectedBtn');
const startDate = document.getElementById('startDate');
const endDate = document.getElementById('endDate');

cancelStorageBtn.addEventListener('click', closeStorageDialog);
deleteSelectedBtn.addEventListener('click', deleteSelectedMessages);

// å¿«é€Ÿæ—¶é—´èŒƒå›´æŒ‰é’®
document.querySelectorAll('.time-range-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        setTimeRange(this.dataset.range);
    });
});

// æ—¥æœŸå˜åŒ–æ—¶æ›´æ–°é¢„è§ˆ
startDate.addEventListener('change', updatePreview);
endDate.addEventListener('change', updatePreview);
}

// æ‰“å¼€å‚¨å­˜ç©ºé—´ç®¡ç†å¯¹è¯æ¡†
function openStorageDialog() {
    // æ›´æ–°å‚¨å­˜ä½¿ç”¨æƒ…å†µ
    updateStorageStats();
    
    // è®¾ç½®é»˜è®¤æ—¥æœŸèŒƒå›´ï¼ˆæœ€è¿‘30å¤©ï¼‰
    const end = new Date();
    const start = new Date();
    start.setDate(end.getDate() - 30);
    
    startDate.value = formatDateForInput(start);
    endDate.value = formatDateForInput(end);
    
    // æ›´æ–°é¢„è§ˆ
    updatePreview();
    
    storageDialog.classList.add('show');
    menuOverlay.classList.add('show');
}

// å…³é—­å‚¨å­˜ç©ºé—´å¯¹è¯æ¡†
function closeStorageDialog() {
    storageDialog.classList.remove('show');
    menuOverlay.classList.remove('show');
}

// æ›´æ–°å‚¨å­˜ä½¿ç”¨æƒ…å†µç»Ÿè®¡
function updateStorageStats() {
    let totalMessages = 0;
    let totalStorage = 0;
    
    // è®¡ç®—æ‰€æœ‰æ ‡ç­¾çš„æ¶ˆæ¯æ€»æ•°å’Œå‚¨å­˜é‡
    state.tabs.forEach(tab => {
        totalMessages += tab.messages.length;
        totalStorage += JSON.stringify(tab.messages).length;
    });
    
    // æ›´æ–°æ˜¾ç¤º
    document.getElementById('totalMessages').textContent = totalMessages;
    document.getElementById('totalTabs').textContent = state.tabs.length;
    document.getElementById('totalStorage').textContent = formatStorageSize(totalStorage);
    
    // æ›´æ–°è®¾ç½®èœå•ä¸­çš„ç®€ç•¥æ˜¾ç¤º
    document.getElementById('storageUsage').textContent = formatStorageSize(totalStorage);
}

// æ ¼å¼åŒ–å‚¨å­˜å¤§å°
function formatStorageSize(bytes) {
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
    return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
}

// ä¸ºæ—¥æœŸè¾“å…¥æ¡†æ ¼å¼åŒ–æ—¥æœŸ
function formatDateForInput(date) {
    return date.toISOString().split('T')[0];
}

// è®¾ç½®æ—¶é—´èŒƒå›´
function setTimeRange(range) {
    const end = new Date();
    const start = new Date();
    
    switch(range) {
        case '7d':
            start.setDate(end.getDate() - 7);
            break;
        case '30d':
            start.setDate(end.getDate() - 30);
            break;
        case 'all':
            // æ‰¾åˆ°æœ€æ—©çš„æ—¥æœŸ
            let earliestDate = new Date();
            state.tabs.forEach(tab => {
                tab.messages.forEach(msg => {
                    const msgDate = new Date(msg.time);
                    if (msgDate < earliestDate) {
                        earliestDate = msgDate;
                    }
                });
            });
            start.setTime(earliestDate.getTime());
            break;
    }
    
    startDate.value = formatDateForInput(start);
    endDate.value = formatDateForInput(end);
    
    updatePreview();
}

// æ›´æ–°é¢„è§ˆ
function updatePreview() {
    const start = new Date(startDate.value);
    const end = new Date(endDate.value);
    end.setHours(23, 59, 59, 999); // åŒ…æ‹¬ç»“æŸæ—¥çš„å…¨å¤©
    
    const previewList = document.getElementById('previewList');
    const previewStats = document.getElementById('previewStats');
    
    // æ¸…ç©ºé¢„è§ˆ
    previewList.innerHTML = '';
    
    let selectedMessages = [];
    let selectedMessagesCount = 0;
    
    // æ”¶é›†é€‰å®šæ—¶é—´èŒƒå›´å†…çš„æ¶ˆæ¯
    state.tabs.forEach(tab => {
        tab.messages.forEach(msg => {
            const msgDate = new Date(msg.time);
            if (msgDate >= start && msgDate <= end) {
                selectedMessages.push({
                    tab: tab.name,
                    date: msgDate,
                    content: msg.content,
                    username: msg.username
                });
                selectedMessagesCount++;
            }
        });
    });
    
    // æ˜¾ç¤ºé¢„è§ˆï¼ˆæœ€å¤šæ˜¾ç¤º10æ¡ï¼‰
    const maxPreview = 10;
    selectedMessages.slice(0, maxPreview).forEach(msg => {
        const previewItem = document.createElement('div');
        previewItem.className = 'preview-item';
        
        const dateSpan = document.createElement('span');
        dateSpan.className = 'preview-date';
        dateSpan.textContent = formatTime(msg.date);
        
        const contentSpan = document.createElement('span');
        contentSpan.className = 'preview-content';
        contentSpan.textContent = msg.content.replace(/\[.*?\]/g, '').substring(0, 30);
        
        const labelSpan = document.createElement('span');
        labelSpan.className = 'preview-label';
        labelSpan.textContent = msg.tab;
        
        previewItem.appendChild(dateSpan);
        previewItem.appendChild(contentSpan);
        previewItem.appendChild(labelSpan);
        previewList.appendChild(previewItem);
    });
    
    if (selectedMessagesCount > maxPreview) {
        const moreItem = document.createElement('div');
        moreItem.className = 'preview-item';
        moreItem.style.justifyContent = 'center';
        moreItem.style.color = '#7f8c8d';
        moreItem.textContent = `...è¿˜æœ‰${selectedMessagesCount - maxPreview}æ¡æ¶ˆæ¯`;
        previewList.appendChild(moreItem);
    }
    
    // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
    if (selectedMessagesCount > 0) {
        previewStats.textContent = `å°†åˆ é™¤ ${selectedMessagesCount} æ¡æ¶ˆæ¯ï¼Œæ¥è‡ª ${new Set(selectedMessages.map(m => m.tab)).size} ä¸ªæ ‡ç­¾`;
        deleteSelectedBtn.disabled = false;
    } else {
        previewStats.textContent = 'æ— é€‰ä¸­æ¶ˆæ¯';
        deleteSelectedBtn.disabled = true;
    }
}

// åˆ é™¤é€‰å®šçš„æ¶ˆæ¯
function deleteSelectedMessages() {
    const start = new Date(startDate.value);
    const end = new Date(endDate.value);
    end.setHours(23, 59, 59, 999);
    
    let deleteCount = 0;
    
    // ä»æ¯ä¸ªæ ‡ç­¾ä¸­åˆ é™¤æ¶ˆæ¯
    state.tabs.forEach(tab => {
        const originalLength = tab.messages.length;
        tab.messages = tab.messages.filter(msg => {
            const msgDate = new Date(msg.time);
            return !(msgDate >= start && msgDate <= end);
        });
        deleteCount += (originalLength - tab.messages.length);
    });
    
    // å¦‚æœå½“å‰æ ‡ç­¾æœ‰æ¶ˆæ¯è¢«åˆ é™¤ï¼Œé‡æ–°æ¸²æŸ“
    const currentTab = state.tabs.find(t => t.id === state.currentTabId);
    if (currentTab) {
        state.messages = [...currentTab.messages];
        renderMessages();
    }
    
    // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
    saveToLocalStorage();
    
    // å…³é—­å¯¹è¯æ¡†å¹¶æ˜¾ç¤ºç¡®è®¤
    closeStorageDialog();
    showConfirmDialog('åˆ é™¤å®Œæˆ', `å·²åˆ é™¤ ${deleteCount} æ¡æ¶ˆæ¯`, null, true);
    
    // æ›´æ–°å‚¨å­˜ç»Ÿè®¡
    updateStorageStats();
}

        // å…³é—­æ‰€æœ‰èœå•å’Œå¯¹è¯æ¡†
        function closeAllMenusAndDialogs() {
            // å…³é—­æ‰€æœ‰å¯¹è¯æ¡†
            if (renameDialog.classList.contains('show')) {
                closeRenameDialog();
            } else if (confirmDialog.classList.contains('show')) {
                closeConfirmDialog();
            } else if (usernameDialog.classList.contains('show')) {
                closeUsernameDialog();
            } else if (assistantDialog.classList.contains('show')) {
                closeAssistantDialog();
            } else if (replyContentDialog.classList.contains('show')) {
                closeReplyContentDialog();
            } else if (sendKeyDialog.classList.contains('show')) {
                closeSendKeyDialog();
            } else if (fontSizeDialog.classList.contains('show')) {
                closeFontSizeDialog();
            } else if (settingsMenu.classList.contains('open')) {
                closeSettingsMenu();
            } else if (sideMenu.classList.contains('open')) {
                closeSideMenu();
            }
            
            // ç¡®ä¿é®ç½©å±‚ä¹Ÿå…³é—­
            menuOverlay.classList.remove('show');
        }

        // åˆ‡æ¢å¿«é€Ÿèœå•
        function toggleQuickMenu() {
            if (state.quickMenuOpen) {
                closeQuickMenu();
            } else {
                openQuickMenu();
            }
        }

        // æ‰“å¼€å¿«é€Ÿèœå•
        function openQuickMenu() {
            quickSubButtons.classList.add('show');
            quickMainBtn.style.transform = 'rotate(45deg)';
            state.quickMenuOpen = true;
        }

        // å…³é—­å¿«é€Ÿèœå•
        function closeQuickMenu() {
            quickSubButtons.classList.remove('show');
            quickMainBtn.style.transform = 'rotate(0deg)';
            state.quickMenuOpen = false;
        }

        // æ‰“å¼€å­—ä½“å¤§å°å¯¹è¯æ¡†
        function openFontSizeDialog() {
            fontSizeSlider.value = state.settings.fontSize;
            fontSizeDisplay.textContent = state.settings.fontSize + 'px';
            fontSizeDialog.classList.add('show');
            menuOverlay.classList.add('show');
        }

        // å…³é—­å­—ä½“å¤§å°å¯¹è¯æ¡†
        function closeFontSizeDialog() {
            fontSizeDialog.classList.remove('show');
            menuOverlay.classList.remove('show');
        }

        // ä¿å­˜å­—ä½“å¤§å°è®¾ç½®
        function saveFontSizeSetting() {
            const newSize = parseInt(fontSizeSlider.value);
            if (newSize >= 12 && newSize <= 24) {
                state.settings.fontSize = newSize;
                updateFontSizeDisplay();
                applyFontSizeToBubbles();
                saveToLocalStorage();
                closeFontSizeDialog();
                showConfirmDialog('è®¾ç½®æˆåŠŸ', `æ°”æ³¡å­—ä½“å¤§å°å·²è°ƒæ•´ä¸º${newSize}px`, null, true);
            }
        }

        // æ›´æ–°å­—ä½“å¤§å°æ˜¾ç¤º
        function updateFontSizeDisplay() {
            fontSizeValue.textContent = state.settings.fontSize + 'px';
        }

        // åº”ç”¨å­—ä½“å¤§å°åˆ°æ‰€æœ‰æ°”æ³¡
        function applyFontSizeToBubbles() {
            const bubbles = document.querySelectorAll('.bubble');
            bubbles.forEach(bubble => {
                bubble.style.fontSize = state.settings.fontSize + 'px';
            });
        }

        // æ‰“å¼€è‡ªåŠ¨å›å¤å†…å®¹å¯¹è¯æ¡†
        function openReplyContentDialog() {
            probabilitySlider.value = state.autoReplyProbability;
            probabilityDisplay.textContent = `æ¦‚ç‡: ${state.autoReplyProbability}%`;
            replyContentDialog.classList.add('show');
            menuOverlay.classList.add('show');
            updateReplyList();
        }

        // æ›´æ–°å›å¤åˆ—è¡¨
        function updateReplyList() {
            replyList.innerHTML = '';
            
            state.autoReplies.forEach((reply, index) => {
                const replyItem = document.createElement('div');
                replyItem.className = 'reply-item';
                
                const replyText = document.createElement('div');
                replyText.className = 'reply-text';
                replyText.textContent = reply;
                
                const replyActions = document.createElement('div');
                replyActions.className = 'reply-actions';
                
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'reply-action-btn delete';
                deleteBtn.title = 'åˆ é™¤';
                deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
                deleteBtn.addEventListener('click', () => {
                    state.autoReplies.splice(index, 1);
                    updateReplyList();
                });
                
                replyActions.appendChild(deleteBtn);
                
                replyItem.appendChild(replyText);
                replyItem.appendChild(replyActions);
                
                replyList.appendChild(replyItem);
            });
        }

        // æ·»åŠ æ–°å›å¤
        function addNewReply() {
            const newReply = addReplyInput.value.trim();
            if (newReply) {
                state.autoReplies.push(newReply);
                addReplyInput.value = '';
                updateReplyList();
            }
        }

        // ä¿å­˜è‡ªåŠ¨å›å¤å†…å®¹è®¾ç½®
        function saveReplyContentSettings() {
            state.autoReplyProbability = parseInt(probabilitySlider.value);
            updateProbabilityDisplay();
            saveToLocalStorage();
            closeReplyContentDialog();
            showConfirmDialog('è®¾ç½®æˆåŠŸ', `è‡ªåŠ¨å›å¤è®¾ç½®å·²ä¿å­˜ï¼`, null, true);
        }

        // å…³é—­è‡ªåŠ¨å›å¤å†…å®¹å¯¹è¯æ¡†
        function closeReplyContentDialog() {
            replyContentDialog.classList.remove('show');
            menuOverlay.classList.remove('show');
        }

        // æ‰“å¼€å‘é€æ–¹å¼å¯¹è¯æ¡†
        function openSendKeyDialog() {
            // æ›´æ–°é€‰é¡¹çŠ¶æ€
            document.querySelectorAll('.send-key-option').forEach(option => {
                option.classList.remove('selected');
                if (option.dataset.value === state.settings.sendKey) {
                    option.classList.add('selected');
                }
            });
            
            // æ·»åŠ é€‰é¡¹ç‚¹å‡»äº‹ä»¶
            document.querySelectorAll('.send-key-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.send-key-option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    this.classList.add('selected');
                });
            });
            
            sendKeyDialog.classList.add('show');
            menuOverlay.classList.add('show');
        }

        // å…³é—­å‘é€æ–¹å¼å¯¹è¯æ¡†
        function closeSendKeyDialog() {
            sendKeyDialog.classList.remove('show');
            menuOverlay.classList.remove('show');
        }

        // ä¿å­˜å‘é€æ–¹å¼è®¾ç½®
        function saveSendKeySetting() {
            const selectedOption = document.querySelector('.send-key-option.selected');
            if (selectedOption) {
                const newSendKey = selectedOption.dataset.value;
                state.settings.sendKey = newSendKey;
                
                // æ›´æ–°æ˜¾ç¤º
                updateSendKeyDisplay();
                
                saveToLocalStorage();
                closeSendKeyDialog();
                showConfirmDialog('è®¾ç½®æˆåŠŸ', `å‘é€é”®å·²è®¾ç½®ä¸º${newSendKey === 'enter' ? 'Enterå‘é€' : 'Enteræ¢è¡Œ'}`, null, true);
            }
        }

        // æ›´æ–°å‘é€æ–¹å¼æ˜¾ç¤º
        function updateSendKeyDisplay() {
            const displayText = state.settings.sendKey === 'enter' ? 'Enterå‘é€' : 'Enteræ¢è¡Œ';
            sendKeyValue.textContent = displayText;
        }

        // è®¾ç½®åŒå‡»äº‹ä»¶
        function setupDoubleClickEvents() {
            chatContainer.addEventListener('click', (e) => {
                const bubble = e.target.closest('.bubble');
                if (!bubble) return;
                
                // å¦‚æœç‚¹å‡»çš„æ˜¯å¾…åŠå¤é€‰æ¡†ï¼Œåˆ‡æ¢å®ŒæˆçŠ¶æ€
                if (bubble.classList.contains('todo-pending') || bubble.classList.contains('todo-completed')) {
                    const messageElement = bubble.closest('.message');
                    if (messageElement && messageElement.classList.contains('other')) {
                        const messageId = parseInt(messageElement.dataset.messageId);
                        toggleTodoStatus(messageId);
                        return;
                    }
                }
                
                const messageElement = bubble.closest('.message');
                if (messageElement) {
                    const messageId = parseInt(messageElement.dataset.messageId);
                    const message = findMessageById(messageId);
                    if (message) {
                        state.selectedMessage = message;
                        
                        // åŒå‡»æ£€æµ‹
                        const currentTime = new Date().getTime();
                        const tapLength = currentTime - state.lastTapTime;
                        
                        if (tapLength < 300 && tapLength > 0) {
                            // åŒå‡»äº‹ä»¶
                            e.preventDefault();
                            e.stopPropagation();
                            
                            // æ·»åŠ æŠ–åŠ¨æ•ˆæœ
                            bubble.classList.add('shake');
                            setTimeout(() => {
                                bubble.classList.remove('shake');
                            }, 300);
                            
                            // æ˜¾ç¤ºæ°”æ³¡èœå•
                            showBubbleMenu(e.clientX, e.clientY);
                            
                            // æ›´æ–°èœå•é¡¹çŠ¶æ€ï¼ˆæ ¹æ®æ¶ˆæ¯å‘é€è€…æ˜¾ç¤ºä¸åŒèœå•ï¼‰
                            updateBubbleMenuItems(message);
                            
                            state.lastTapTime = 0;
                            
                            if (state.tapTimeout) {
                                clearTimeout(state.tapTimeout);
                                state.tapTimeout = null;
                            }
                        } else {
                            state.lastTapTime = currentTime;
                            state.tapTimeout = setTimeout(() => {
                                state.lastTapTime = 0;
                            }, 300);
                        }
                    }
                }
            });
            
            // æ°”æ³¡èœå•é¡¹ç‚¹å‡»äº‹ä»¶
            bubbleMenu.addEventListener('click', (e) => {
                const menuItem = e.target.closest('.bubble-menu-item');
                if (menuItem && state.selectedMessage) {
                    const action = menuItem.dataset.action;
                    handleBubbleMenuAction(action);
                }
            });
            
            // å¤„ç†åŠ©æ‰‹å¾…åŠè¡¨æ ¼çš„å‹¾é€‰
            chatContainer.addEventListener('click', (e) => {
                // å¤„ç†åŠ©æ‰‹å¾…åŠè¡¨æ ¼çš„ä¿å­˜æŒ‰é’®
                const saveBtn = e.target.closest('.save-todo-btn');
                if (saveBtn) {
                    const tableContainer = saveBtn.closest('.todo-table-container');
                    if (tableContainer) {
                        const table = tableContainer.querySelector('.todo-table');
                        const checkboxes = table.querySelectorAll('.todo-checkbox');
                        let checkedCount = 0;
                        
                        checkboxes.forEach((checkbox, index) => {
                            if (checkbox.checked) {
                                checkedCount++;
                                const row = checkbox.closest('tr');
                                const mapKey = row.dataset.mapKey;
                                const originalInfo = state.assistantTodoMap[mapKey];
                                
                                if (originalInfo) {
                                    // æ›´æ–°åŸå§‹æ¶ˆæ¯ä¸ºå®ŒæˆçŠ¶æ€
                                    const currentTab = state.tabs.find(t => t.id === state.currentTabId);
                                    if (currentTab) {
                                        const originalMessage = currentTab.messages.find(m => m.id === originalInfo.originalMessageId);
                                        if (originalMessage && originalMessage.content.includes('[å¾…åŠ]') && !originalMessage.content.includes('[å¾…åŠå®Œæˆ]')) {
                                            originalMessage.content = originalMessage.content.replace('[å¾…åŠ]', '[å¾…åŠå®Œæˆ]');
                                            // æ ‡è®°ä¸ºå·²å®ŒæˆçŠ¶æ€
                                            state.assistantTodoStates[mapKey] = true;
                                            updateMessageDisplay(originalMessage.id);
                                        }
                                    }
                                }
                            }
                        });
                        
                        // ç”Ÿæˆæç¤ºæ¶ˆæ¯
                        const now = new Date();
                        const assistantMessageId = Date.now() + 1;
                        const assistantReplyMessage = {
                            id: assistantMessageId,
                            username: state.assistantName,
                            content: `å‹¾é€‰çš„å†…å®¹å·²æ ‡è®°ä¸ºå·²å®Œæˆï¼Œåç»­å¯åœ¨å·²å®Œæˆä¸­æŸ¥çœ‹ã€‚`,
                            time: now,
                            isSelf: false,
                            formattedTime: formatTime(now)
                        };
                        
                        const currentTab = state.tabs.find(t => t.id === state.currentTabId);
                        if (currentTab) {
                            currentTab.messages.push(assistantReplyMessage);
                        }
                        
                        addMessageToChat(assistantReplyMessage);
                        saveToLocalStorage();
                        
                        // ç§»é™¤è¡¨æ ¼ï¼ˆä¸ä¿å­˜åˆ°æ¶ˆæ¯è®°å½•ä¸­ï¼‰
                        tableContainer.remove();
                    }
                }
            });
        }

        // æ›´æ–°æ°”æ³¡èœå•é¡¹çŠ¶æ€ - ä¿®æ”¹ï¼šå¢åŠ æ ‡è®°å®Œæˆ/é‡æ–°å¾…åŠé€‰é¡¹
        function updateBubbleMenuItems(message) {
            // æ¸…ç©ºæ°”æ³¡èœå•
            bubbleMenu.innerHTML = '';
            
            // å¦‚æœæ˜¯åŠ©æ‰‹å‘é€çš„æ¶ˆæ¯ï¼Œåªæ˜¾ç¤ºåˆ é™¤é€‰é¡¹
            if (!message.isSelf) {
                const deleteItem = document.createElement('button');
                deleteItem.className = 'bubble-menu-item delete';
                deleteItem.dataset.action = 'delete';
                deleteItem.innerHTML = '<i class="fas fa-trash"></i> åˆ é™¤æ¶ˆæ¯';
                bubbleMenu.appendChild(deleteItem);
                return;
            }
            
            // å¦‚æœæ˜¯è‡ªå·±å‘é€çš„æ¶ˆæ¯ï¼Œæ˜¾ç¤ºå®Œæ•´èœå•
            
            // é‡è¦é€‰é¡¹
            const importantItem = document.createElement('button');
            importantItem.className = 'bubble-menu-item important';
            importantItem.dataset.action = 'toggleImportant';
            
            const importantIcon = document.createElement('i');
            importantIcon.className = 'fas fa-exclamation-circle';
            
            const importantText = document.createElement('span');
            importantText.textContent = message.content.includes('[é‡è¦]') ? 'å–æ¶ˆé‡è¦' : 'é‡è¦';
            
            importantItem.appendChild(importantIcon);
            importantItem.appendChild(importantText);
            
            // å¾…åŠ/å®Œæˆ/é‡æ–°å¾…åŠé€‰é¡¹
            let todoItem;
            
            if (message.content.includes('[å¾…åŠå®Œæˆ]')) {
                // å·²å®ŒæˆçŠ¶æ€ï¼šæ˜¾ç¤ºé‡æ–°å¾…åŠå’Œå–æ¶ˆå¾…åŠ
                const reopenItem = document.createElement('button');
                reopenItem.className = 'bubble-menu-item reopen';
                reopenItem.dataset.action = 'reopenTodo';
                
                const reopenIcon = document.createElement('i');
                reopenIcon.className = 'fas fa-undo';
                
                const reopenText = document.createElement('span');
                reopenText.textContent = 'é‡æ–°å¾…åŠ';
                
                reopenItem.appendChild(reopenIcon);
                reopenItem.appendChild(reopenText);
                bubbleMenu.appendChild(reopenItem);
                
                todoItem = document.createElement('button');
                todoItem.className = 'bubble-menu-item todo';
                todoItem.dataset.action = 'toggleTodo';
                
                const todoIcon = document.createElement('i');
                todoIcon.className = 'fas fa-times-circle';
                
                const todoText = document.createElement('span');
                todoText.textContent = 'å–æ¶ˆå¾…åŠ';
                
                todoItem.appendChild(todoIcon);
                todoItem.appendChild(todoText);
            } else if (message.content.includes('[å¾…åŠ]')) {
                // å¾…åŠçŠ¶æ€ï¼šæ˜¾ç¤ºæ ‡è®°å®Œæˆå’Œå–æ¶ˆå¾…åŠ
                const completeItem = document.createElement('button');
                completeItem.className = 'bubble-menu-item complete';
                completeItem.dataset.action = 'completeTodo';
                
                const completeIcon = document.createElement('i');
                completeIcon.className = 'fas fa-check-circle';
                
                const completeText = document.createElement('span');
                completeText.textContent = 'æ ‡è®°å®Œæˆ';
                
                completeItem.appendChild(completeIcon);
                completeItem.appendChild(completeText);
                bubbleMenu.appendChild(completeItem);
                
                todoItem = document.createElement('button');
                todoItem.className = 'bubble-menu-item todo';
                todoItem.dataset.action = 'toggleTodo';
                
                const todoIcon = document.createElement('i');
                todoIcon.className = 'fas fa-times-circle';
                
                const todoText = document.createElement('span');
                todoText.textContent = 'å–æ¶ˆå¾…åŠ';
                
                todoItem.appendChild(todoIcon);
                todoItem.appendChild(todoText);
            } else {
                // éå¾…åŠçŠ¶æ€ï¼šæ˜¾ç¤ºå¾…åŠé€‰é¡¹
                todoItem = document.createElement('button');
                todoItem.className = 'bubble-menu-item todo';
                todoItem.dataset.action = 'toggleTodo';
                
                const todoIcon = document.createElement('i');
                todoIcon.className = 'fas fa-check-circle';
                
                const todoText = document.createElement('span');
                todoText.textContent = 'å¾…åŠ';
                
                todoItem.appendChild(todoIcon);
                todoItem.appendChild(todoText);
            }
            
            // åˆ é™¤é€‰é¡¹
            const deleteItem = document.createElement('button');
            deleteItem.className = 'bubble-menu-item delete';
            deleteItem.dataset.action = 'delete';
            deleteItem.innerHTML = '<i class="fas fa-trash"></i> åˆ é™¤æ¶ˆæ¯';
            
            // æ·»åŠ åˆ°æ°”æ³¡èœå•ï¼ˆæ ¹æ®æƒ…å†µæ·»åŠ ï¼‰
            bubbleMenu.appendChild(importantItem);
            if (todoItem) {
                bubbleMenu.appendChild(todoItem);
            }
            bubbleMenu.appendChild(deleteItem);
        }

        // å³æ—¶æ›´æ–°å•ä¸ªæ¶ˆæ¯çš„æ˜¾ç¤ºçŠ¶æ€
        function updateMessageDisplay(messageId) {
        // æ‰¾åˆ°æ¶ˆæ¯çš„DOMå…ƒç´ 
        const messageElement = document.querySelector(`.message[data-message-id="${messageId}"]`);
        if (!messageElement) return;
    
        const bubble = messageElement.querySelector('.bubble');
        if (!bubble) return;
    
        const currentTab = state.tabs.find(t => t.id === state.currentTabId);
        if (!currentTab) return;
    
        const message = currentTab.messages.find(m => m.id === messageId);
        if (!message) return;
    
        // æ›´æ–°æ°”æ³¡æ ·å¼
        if (message.content.includes('[å¾…åŠå®Œæˆ]')) {
            bubble.classList.add('todo-completed');
            bubble.classList.remove('todo-pending');
            bubble.style.textDecoration = 'line-through';
            bubble.style.opacity = '0.8';
        } else if (message.content.includes('[å¾…åŠ]')) {
            bubble.classList.add('todo-pending');
            bubble.classList.remove('todo-completed');
            bubble.style.textDecoration = 'none';
            bubble.style.opacity = '1';
        }
    
        // æ›´æ–°æ°”æ³¡å†…å®¹ï¼ˆä¿æŒæ ¼å¼æ ‡è®°ï¼‰
        bubble.innerHTML = formatMessageContent(message.content);
        }
        
        // åˆ‡æ¢å¾…åŠçŠ¶æ€ï¼ˆç”¨äºåŠ©æ‰‹æ¶ˆæ¯çš„å‹¾é€‰æ¡†ï¼‰
        function toggleTodoStatus(messageId) {
            const currentTab = state.tabs.find(t => t.id === state.currentTabId);
            if (!currentTab) return;
            
            const messageIndex = currentTab.messages.findIndex(m => m.id === messageId);
            if (messageIndex === -1) return;
            
            const message = currentTab.messages[messageIndex];
            
            if (!message.content.includes('[å¾…åŠ]') && !message.content.includes('[å¾…åŠå®Œæˆ]')) {
                return;
            }
            
            if (message.content.includes('[å¾…åŠå®Œæˆ]')) {
                message.content = message.content.replace('[å¾…åŠå®Œæˆ]', '[å¾…åŠ]');
            } else {
                message.content = message.content.replace('[å¾…åŠ]', '[å¾…åŠå®Œæˆ]');
            }
            updateMessageDisplay(messageId);
            renderMessages();
            saveToLocalStorage();
        }

        // æ˜¾ç¤ºæ°”æ³¡èœå•
        function showBubbleMenu(x, y) {
            const menuWidth = 160;
            const menuHeight = 200;
            const windowWidth = window.innerWidth;
            const windowHeight = window.innerHeight;
            
            let posX = x;
            let posY = y;
            
            if (posX + menuWidth > windowWidth) {
                posX = windowWidth - menuWidth - 10;
            }
            
            if (posY + menuHeight > windowHeight) {
                posY = windowHeight - menuHeight - 10;
            }
            
            bubbleMenu.style.left = posX + 'px';
            bubbleMenu.style.top = posY + 'px';
            bubbleMenu.classList.add('show');
        }

        // å…³é—­æ°”æ³¡èœå•
        function closeBubbleMenu() {
            bubbleMenu.classList.remove('show');
            state.selectedMessage = null;
        }

        // å¤„ç†æ°”æ³¡èœå•åŠ¨ä½œ
        function handleBubbleMenuAction(action) {
            if (!state.selectedMessage) return;
            
            const currentTab = state.tabs.find(t => t.id === state.currentTabId);
            if (!currentTab) return;
            
            const messageIndex = currentTab.messages.findIndex(m => m.id === state.selectedMessage.id);
            if (messageIndex === -1) return;
            
            let newContent = currentTab.messages[messageIndex].content;
            
            switch (action) {
                case 'toggleImportant':
                    if (newContent.includes('[é‡è¦]')) {
                        newContent = newContent.replace('[é‡è¦] ', '');
                    } else {
                        newContent = '[é‡è¦] ' + newContent;
                    }
                    break;
                    
                case 'toggleTodo':
                    // å–æ¶ˆå¾…åŠï¼ˆç§»é™¤å¾…åŠæ ‡è®°ï¼‰
                    if (newContent.includes('[å¾…åŠ]')) {
                        newContent = newContent.replace('[å¾…åŠ] ', '');
                    } else if (newContent.includes('[å¾…åŠå®Œæˆ]')) {
                        newContent = newContent.replace('[å¾…åŠå®Œæˆ] ', '');
                    } else {
                        newContent = '[å¾…åŠ] ' + newContent;
                    }
                    break;
                    
                case 'completeTodo':
                    // æ ‡è®°å®Œæˆï¼ˆä»å¾…åŠè½¬ä¸ºå®Œæˆï¼‰
                    if (newContent.includes('[å¾…åŠ]')) {
                        newContent = newContent.replace('[å¾…åŠ]', '[å¾…åŠå®Œæˆ]');
                    }
                    break;
                    
                case 'reopenTodo':
                    // é‡æ–°å¾…åŠï¼ˆä»å®Œæˆè½¬ä¸ºå¾…åŠï¼‰
                    if (newContent.includes('[å¾…åŠå®Œæˆ]')) {
                        newContent = newContent.replace('[å¾…åŠå®Œæˆ]', '[å¾…åŠ]');
                    }
                    break;
                    
                case 'delete':
                    showConfirmDialog('åˆ é™¤æ¶ˆæ¯', 'ç¡®å®šè¦åˆ é™¤è¿™æ¡æ¶ˆæ¯å—ï¼Ÿ', () => {
                        currentTab.messages.splice(messageIndex, 1);
                        renderMessages();
                        saveToLocalStorage();
                    });
                    break;
            }
            
            if (action !== 'delete') {
                currentTab.messages[messageIndex].content = newContent;
                renderMessages();
                saveToLocalStorage();
            }
            
            closeBubbleMenu();
        }

        // å‘é€æŸ¥è¯¢ç»™åŠ©æ‰‹
        function sendQueryToAssistant(type) {
            closeQuickMenu();
            
            let queryText = '';
            if (type === 'todo') {
                queryText = 'å‘ä¸€ä¸‹æˆ‘çš„å¾…åŠäº‹é¡¹ç»™æˆ‘ã€‚';
            } else if (type === 'completed') {
                queryText = 'å‘ä¸€ä¸‹æˆ‘çš„å®Œæˆäº‹é¡¹ç»™æˆ‘ã€‚';
            } else if (type === 'important') {
                queryText = 'å‘ä¸€ä¸‹æˆ‘çš„é‡è¦äº‹é¡¹ç»™æˆ‘ã€‚';
            }
            
            const now = new Date();
            const queryMessage = {
                id: Date.now(),
                username: state.username,
                content: queryText,
                time: now,
                isSelf: true,
                formattedTime: formatTime(now)
            };
            
            const currentTab = state.tabs.find(t => t.id === state.currentTabId);
            if (currentTab) {
                currentTab.messages.push(queryMessage);
            }
            
            state.messages.push(queryMessage);
            
            addMessageToChat(queryMessage);
            
            messageInput.value = '';
            adjustInputHeight();
            sendBtn.classList.remove('show');
            
            emptyState.style.display = 'none';
            
            scrollToBottom();
            
            saveToLocalStorage();
            
            setTimeout(() => {
                if (type === 'todo') {
                    generateAssistantTodoTable();
                } else {
                    generateAssistantReply(type);
                }
            }, 1000);
        }

        // ç”ŸæˆåŠ©æ‰‹å›å¤ï¼ˆç”¨äºå®Œæˆäº‹é¡¹å’Œé‡è¦äº‹é¡¹ï¼‰
        function generateAssistantReply(type) {
            const currentTab = state.tabs.find(t => t.id === state.currentTabId);
            if (!currentTab) return;
            
            let replyContent = '';
            const foundItems = [];
            
            const assistantMessageId = Date.now() + 1;
            
            currentTab.messages.forEach(message => {
                if (message.isSelf) {
                    const dateStr = formatDate(message.time);
                    const contentWithoutTags = message.content.replace(/\[.*?\]/g, '').trim();
                    
                    if (type === 'todo' && message.content.includes('[å¾…åŠ]') && !message.content.includes('[å¾…åŠå®Œæˆ]')) {
                        foundItems.push({
                            date: dateStr,
                            content: contentWithoutTags,
                            id: message.id,
                            completed: false
                        });
                    } else if (type === 'completed' && message.content.includes('[å¾…åŠå®Œæˆ]')) {
                        foundItems.push({
                            date: dateStr,
                            content: contentWithoutTags,
                            id: message.id,
                            completed: true
                        });
                    } else if (type === 'important' && message.content.includes('[é‡è¦]')) {
                        foundItems.push({
                            date: dateStr,
                            content: contentWithoutTags,
                            id: message.id,
                            important: true
                        });
                    }
                }
            });
            
            if (foundItems.length === 0) {
                if (type === 'todo') { 
                    replyContent = 'æ‚¨ç›®å‰æ²¡æœ‰å¾…åŠäº‹é¡¹ã€‚'; 
                } else if (type === 'completed') { 
                    replyContent = 'æ‚¨ç›®å‰æ²¡æœ‰å·²å®Œæˆçš„äº‹é¡¹ã€‚'; 
                } else if (type === 'important') { 
                    replyContent = 'æ‚¨ç›®å‰æ²¡æœ‰é‡è¦äº‹é¡¹ã€‚'; 
                }
            } else { 
                if (type === 'todo') { 
                    replyContent = 'ä»¥ä¸‹æ˜¯æ‚¨çš„å¾…åŠäº‹é¡¹ï¼š<br>';
                    foundItems.forEach((item, index) => {
                        const mapKey = assistantMessageId + '_' + index;
                        state.assistantTodoMap[mapKey] = {
                            originalMessageId: item.id,
                            todoIndex: index
                        };
                        
                        // æ£€æŸ¥æ˜¯å¦å·²ç»å®Œæˆ
                        const stateKey = `${item.id}_${index}`;
                        const isCompleted = state.assistantTodoStates[stateKey] || false;
                        const checked = isCompleted ? 'checked' : '';
                        const completedClass = isCompleted ? 'completed' : '';
                        
                        replyContent += '<div class="todo-list-item ' + completedClass + '" data-message-id="' + assistantMessageId + '" data-todo-index="' + index + '"><div class="todo-list-header"><span class="todo-list-date">' + item.date + '</span><input type="checkbox" class="todo-list-checkbox" ' + checked + '></div><div class="todo-list-content">' + item.content + '</div></div>';
                    });
                } else if (type === 'completed') { 
                    replyContent = 'ä»¥ä¸‹æ˜¯æ‚¨å·²å®Œæˆçš„äº‹é¡¹ï¼š<br>';
                    foundItems.forEach((item, index) => {
                        replyContent += '<div class="todo-list-item completed"><div class="todo-list-header"><span class="todo-list-date">' + item.date + '</span><span>âœ“</span></div><div class="todo-list-content">' + item.content + '</div></div>';
                    });
                } else if (type === 'important') { 
                    replyContent = 'ä»¥ä¸‹æ˜¯æ‚¨çš„é‡è¦äº‹é¡¹ï¼š<br>';
                    foundItems.forEach((item, index) => {
                        replyContent += '<div class="todo-list-item"><div class="todo-list-header"><span class="todo-list-date">' + item.date + '</span><span style="color:#e74c3c;">â˜…</span></div><div class="todo-list-content">' + item.content + '</div></div>';
                    });
                }
            }
            
            const now = new Date();
            const assistantReplyMessage = {
                id: assistantMessageId,
                username: state.assistantName,
                content: replyContent,
                time: now,
                isSelf: false,
                formattedTime: formatTime(now)
            };
            
            currentTab.messages.push(assistantReplyMessage);
            state.messages.push(assistantReplyMessage);
            
            addMessageToChat(assistantReplyMessage);
            saveToLocalStorage();
        }

        // ç”ŸæˆåŠ©æ‰‹å¾…åŠè¡¨æ ¼ï¼ˆæ–°æ ¼å¼ï¼‰
        function generateAssistantTodoTable() {
            const currentTab = state.tabs.find(t => t.id === state.currentTabId);
            if (!currentTab) return;
            
            const foundItems = [];
            
            // æŸ¥æ‰¾æ‰€æœ‰å¾…åŠäº‹é¡¹
            currentTab.messages.forEach(message => {
                if (message.isSelf) {
                    const dateStr = formatDate(message.time);
                    const contentWithoutTags = message.content.replace(/\[.*?\]/g, '').trim();
                    
                    if (message.content.includes('[å¾…åŠ]') && !message.content.includes('[å¾…åŠå®Œæˆ]')) {
                        foundItems.push({
                            date: dateStr,
                            content: contentWithoutTags,
                            id: message.id,
                            completed: false
                        });
                    }
                }
            });
            
            const assistantMessageId = Date.now() + 1;
            
            // ç”Ÿæˆç¬¬ä¸€ä¸ªæ°”æ³¡ï¼šæç¤ºæ–‡æœ¬
            const now = new Date();
            const assistantReplyMessage = {
                id: assistantMessageId,
                username: state.assistantName,
                content: 'ä»¥ä¸‹æ˜¯æ‚¨çš„å¾…åŠäº‹é¡¹ï¼š',
                time: now,
                isSelf: false,
                formattedTime: formatTime(now)
            };
            
            currentTab.messages.push(assistantReplyMessage);
            state.messages.push(assistantReplyMessage);
            
            addMessageToChat(assistantReplyMessage);
            
            if (foundItems.length === 0) {
                // æ²¡æœ‰å¾…åŠäº‹é¡¹
                const emptyMessage = {
                    id: assistantMessageId + 1,
                    username: state.assistantName,
                    content: 'æ‚¨ç›®å‰æ²¡æœ‰å¾…åŠäº‹é¡¹ã€‚',
                    time: now,
                    isSelf: false,
                    formattedTime: formatTime(now)
                };
                
                currentTab.messages.push(emptyMessage);
                state.messages.push(emptyMessage);
                
                addMessageToChat(emptyMessage);
            } else {
                // åˆ›å»ºè¡¨æ ¼å®¹å™¨ï¼ˆä¸ä¿å­˜åˆ°æ¶ˆæ¯è®°å½•ä¸­ï¼‰
                const tableContainer = document.createElement('div');
                tableContainer.className = 'todo-table-container';
                
                // åˆ›å»ºè¡¨æ ¼
                const table = document.createElement('table');
                table.className = 'todo-table';
                
                // åˆ›å»ºè¡¨å¤´
                const thead = document.createElement('thead');
                const headerRow = document.createElement('tr');
                const headers = ['æ—¥æœŸ', 'æ ‡è®°', 'å†…å®¹', 'æ“ä½œ'];
                
                headers.forEach(headerText => {
                    const th = document.createElement('th');
                    th.textContent = headerText;
                    headerRow.appendChild(th);
                });
                
                thead.appendChild(headerRow);
                table.appendChild(thead);
                
                // åˆ›å»ºè¡¨æ ¼ä¸»ä½“
                const tbody = document.createElement('tbody');
                
                foundItems.forEach((item, index) => {
                    const mapKey = assistantMessageId + '_' + index;
                    state.assistantTodoMap[mapKey] = {
                        originalMessageId: item.id,
                        todoIndex: index
                    };
                    
                    const stateKey = `${item.id}_${index}`;
                    const isCompleted = state.assistantTodoStates[stateKey] || false;
                    
                    const row = document.createElement('tr');
                    row.dataset.mapKey = mapKey;
                    if (isCompleted) {
                        row.classList.add('completed');
                    }
                    
                    // æ—¥æœŸå•å…ƒæ ¼
                    const dateCell = document.createElement('td');
                    dateCell.className = 'todo-date';
                    dateCell.textContent = item.date;
                    
                    // æ ‡è®°å•å…ƒæ ¼
                    const tagCell = document.createElement('td');
                    tagCell.className = 'todo-tag';
                    tagCell.textContent = '[å¾…åŠ]';
                    
                    // å†…å®¹å•å…ƒæ ¼
                    const contentCell = document.createElement('td');
                    contentCell.className = 'todo-content';
                    contentCell.textContent = item.content;
                    if (isCompleted) {
                        contentCell.style.textDecoration = 'line-through';
                        contentCell.style.color = '#95a5a6';
                    }
                    
                    // æ“ä½œå•å…ƒæ ¼ï¼ˆå‹¾é€‰æ¡†ï¼‰
                    const actionCell = document.createElement('td');
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.className = 'todo-checkbox';
                    checkbox.checked = isCompleted;
                    actionCell.appendChild(checkbox);
                    
                    row.appendChild(dateCell);
                    row.appendChild(tagCell);
                    row.appendChild(contentCell);
                    row.appendChild(actionCell);
                    
                    tbody.appendChild(row);
                });
                
                table.appendChild(tbody);
                tableContainer.appendChild(table);
                
                // æ·»åŠ ä¿å­˜æŒ‰é’®
                const saveButton = document.createElement('button');
                saveButton.className = 'save-todo-btn';
                saveButton.textContent = 'ä¿å­˜å‹¾é€‰çŠ¶æ€';
                tableContainer.appendChild(saveButton);
                
                // æ·»åŠ åˆ°èŠå¤©å®¹å™¨ä¸­ï¼ˆä½†ä¸ä¿å­˜åˆ°æ¶ˆæ¯è®°å½•ï¼‰
                chatContainer.appendChild(tableContainer);
                
                // è®°å½•è¡¨æ ¼æ¶ˆæ¯IDï¼Œç”¨äºåˆ·æ–°æ—¶æ¸…ç†
                state.assistantTodoTableMessages[assistantMessageId] = true;
            }
            
            saveToLocalStorage();
            scrollToBottom();
        }

        // æ ¼å¼åŒ–æ—¥æœŸ
        function formatDate(date) {
            const d = new Date(date);
            const year = d.getFullYear();
            const month = (d.getMonth() + 1).toString().padStart(2, '0');
            const day = d.getDate().toString().padStart(2, '0');
            return `${year}/${month}/${day}`;
        }

        // æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
        function showConfirmDialog(title, message, callback, noCancel = false) {
            confirmTitle.textContent = title;
            confirmMessage.textContent = message;
            confirmDialog.classList.add('show');
            menuOverlay.classList.add('show');
            
            confirmDialog.dataset.callback = callback ? 'true' : 'false';
            if (callback) {
                confirmDialog.callback = callback;
            }
            
            if (noCancel) {
                cancelConfirmBtn.style.display = 'none';
                confirmBtn.textContent = 'ç¡®å®š';
            } else {
                cancelConfirmBtn.style.display = 'block';
                confirmBtn.textContent = 'ç¡®è®¤';
            }
        }

        // å¤„ç†ç¡®è®¤æ“ä½œ
        function handleConfirmAction() {
            if (confirmDialog.callback) {
                confirmDialog.callback();
            }
            closeConfirmDialog();
        }

        // å…³é—­ç¡®è®¤å¯¹è¯æ¡†
        function closeConfirmDialog() {
            confirmDialog.classList.remove('show');
            menuOverlay.classList.remove('show');
            confirmDialog.callback = null;
            cancelConfirmBtn.style.display = 'block';
            confirmBtn.textContent = 'ç¡®è®¤';
        }

        // æ›´æ–°æ¦‚ç‡æ˜¾ç¤º
        function updateProbabilityDisplay() {
            const probabilityValue = document.getElementById('probabilityValue');
            if (probabilityValue) {
                probabilityValue.textContent = state.autoReplyProbability + '%';
            }
        }

        // æ‰“å¼€é‡å‘½åå¯¹è¯æ¡†
        function openRenameDialog(currentName, tabId) {
            renameInput.value = currentName;
            renameDialog.dataset.tabId = tabId;
            renameDialog.classList.add('show');
            menuOverlay.classList.add('show');
            setTimeout(() => {
                renameInput.focus();
                renameInput.select();
            }, 100);
        }

        // ä¿å­˜é‡å‘½å
        function saveRename() {
            const newName = renameInput.value.trim();
            const tabId = parseInt(renameDialog.dataset.tabId);
            
            if (newName && tabId) {
                const tabIndex = state.tabs.findIndex(t => t.id === tabId);
                if (tabIndex !== -1) {
                    state.tabs[tabIndex].name = newName;
                    if (state.tabs[tabIndex].id === state.currentTabId) {
                        currentTabName.textContent = newName;
                    }
                    updateTabsList();
                    saveToLocalStorage();
                }
            }
            closeRenameDialog();
        }

        // å…³é—­é‡å‘½åå¯¹è¯æ¡†
        function closeRenameDialog() {
            renameDialog.classList.remove('show');
            menuOverlay.classList.remove('show');
            delete renameDialog.dataset.tabId;
        }

        // æ‰“å¼€åŠ©æ‰‹åç§°å¯¹è¯æ¡†
        function openAssistantDialog() {
            assistantInput.value = state.assistantName;
            assistantDialog.classList.add('show');
            menuOverlay.classList.add('show');
        }

        // ä¿å­˜åŠ©æ‰‹åç§°
        function saveAssistantName() {
            const newName = assistantInput.value.trim();
            if (newName) {
                const oldName = state.assistantName;
                state.assistantName = newName;
                
                const currentTab = state.tabs.find(t => t.id === state.currentTabId);
                if (currentTab) {
                    currentTab.messages.forEach(message => {
                        if (!message.isSelf && message.username === oldName) {
                            message.username = newName;
                        }
                    });
                }
                
                renderMessages();
                saveToLocalStorage();
                closeAssistantDialog();
                showConfirmDialog('ä¿®æ”¹æˆåŠŸ', 'åŠ©æ‰‹åç§°å·²ä¿®æ”¹ï¼', null, true);
            }
        }

        // å…³é—­åŠ©æ‰‹åç§°å¯¹è¯æ¡†
        function closeAssistantDialog() {
            assistantDialog.classList.remove('show');
            menuOverlay.classList.remove('show');
        }

        // æ˜¾ç¤ºæ¸…é™¤ç¼“å­˜ç¡®è®¤
        function showClearCacheConfirm() {
            showConfirmDialog('æ¸…é™¤æ‰€æœ‰è®¾å®š', 'ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰ç”¨æˆ·è®¾å®šå’Œç¼“å­˜å—ï¼Ÿæ­¤æ“ä½œå°†é‡ç½®æ‰€æœ‰è®¾ç½®å¹¶æ¸…ç©ºç¼“å­˜æ•°æ®ï¼', () => {
                // æ¸…é™¤localStorage
                localStorage.clear();
                localStorage.removeItem('voice_model_downloaded');
                
                // é‡ç½®çŠ¶æ€åˆ°åˆå§‹å€¼
                state.username = 'æˆ‘';
                state.assistantName = 'åŠ©æ‰‹';
                state.tabs = [
                    { id: 1, name: 'èŠå¤©1', messages: [], active: true, pinned: false },
                    { id: 2, name: 'èŠå¤©2', messages: [], active: false, pinned: false },
                    { id: 3, name: 'èŠå¤©3', messages: [], active: false, pinned: false }
                ];
                state.currentTabId = 1;
                state.autoReplyProbability = 70;
                state.autoReplies = [
                    "æ”¶åˆ°ï¼å·²è®°å½•ã€‚",
                    "æ˜ç™½ï¼Œç»§ç»­è¯´å§ã€‚",
                    "å¥½çš„ï¼Œæˆ‘åœ¨å¬ã€‚",
                    "å—¯ï¼Œæœ‰é“ç†ã€‚",
                    "æ˜¯çš„ï¼Œæˆ‘åŒæ„ã€‚",
                    "å—¯å—¯ï¼Œäº†è§£äº†ã€‚",
                    "è¿™ä¸ªæƒ³æ³•ä¸é”™ï¼",
                    "ç»§ç»­ï¼Œæˆ‘åœ¨è®°å½•ã€‚",
                    "å¥½çš„ï¼Œè¿˜æœ‰ä»€ä¹ˆè¦è¡¥å……çš„å—ï¼Ÿ",
                    "å·²æ”¶åˆ°ï¼Œè¯·ç»§ç»­ã€‚"
                ];
                state.completedTodos = {};
                state.assistantTodoMap = {};
                state.assistantTodoStates = {};
                state.assistantTodoTableMessages = {};
                state.settings = {
                    sendKey: 'enter',
                    theme: 'light',
                    fontSize: 16
                };
                
                // æ›´æ–°UI
                updateCurrentTab();
                updateTabsList();
                renderMessages();
                updateSendKeyDisplay();
                updateFontSizeDisplay();
                applyFontSizeToBubbles();
                
                // é‡ç½®ä¸»é¢˜åˆ°æµ…è‰²
                if (state.settings.theme === 'dark') {
                    toggleTheme();
                }
                
                showConfirmDialog('æ“ä½œæˆåŠŸ', 'æ‰€æœ‰ç”¨æˆ·è®¾å®šå’Œç¼“å­˜å·²æ¸…é™¤ï¼', null, true);
            });
        }

// æ˜¾ç¤ºå¯¼å‡ºé€‰é¡¹å¯¹è¯æ¡†
function showExportInfo() {
    closeSettingsMenu();
    
    // åˆ›å»ºè‡ªå®šä¹‰å¯¼å‡ºå¯¹è¯æ¡†
    const exportDialog = document.createElement('div');
    exportDialog.className = 'confirm-dialog';
    exportDialog.id = 'exportDialog';
    exportDialog.style.display = 'block';
    exportDialog.innerHTML = `
        <div class="dialog-header">
            <div class="dialog-title">å¯¼å‡ºèŠå¤©è®°å½•</div>
            <div class="dialog-text">é€‰æ‹©å¯¼å‡ºé€‰é¡¹</div>
        </div>
        <div style="padding: 20px;">
            <div class="export-option" style="margin-bottom: 15px;">
                <input type="radio" id="exportAll" name="exportOption" checked>
                <label for="exportAll" style="margin-left: 10px; cursor: pointer;">
                    <strong>å¯¼å‡ºæ‰€æœ‰æ ‡ç­¾</strong><br>
                    <span style="font-size: 13px; color: #7f8c8d;">åŒ…å«æ‰€æœ‰æ ‡ç­¾çš„å®Œæ•´èŠå¤©è®°å½•</span>
                </label>
            </div>
            <div class="export-option">
                <input type="radio" id="exportCurrent" name="exportOption">
                <label for="exportCurrent" style="margin-left: 10px; cursor: pointer;">
                    <strong>ä»…å¯¼å‡ºå½“å‰æ ‡ç­¾</strong><br>
                    <span style="font-size: 13px; color: #7f8c8d;">ä»…å¯¼å‡º"${state.tabs.find(t => t.id === state.currentTabId)?.name || 'å½“å‰æ ‡ç­¾'}"</span>
                </label>
            </div>
            <div class="progress-container" id="exportProgress" style="display: none; margin-top: 20px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                    <span>æ­£åœ¨å¯¼å‡º...</span>
                    <span id="progressPercent">0%</span>
                </div>
                <div style="width: 100%; height: 8px; background-color: #ecf0f1; border-radius: 4px; overflow: hidden;">
                    <div id="progressBar" style="width: 0%; height: 100%; background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%); transition: width 0.3s ease;"></div>
                </div>
            </div>
        </div>
        <div class="dialog-actions" style="padding: 0 24px 24px;">
            <button class="dialog-btn cancel" id="cancelExportBtn">å–æ¶ˆ</button>
            <button class="dialog-btn save" id="confirmExportBtn">å¼€å§‹å¯¼å‡º</button>
        </div>
    `;
    
    // æ·»åŠ åˆ°é¡µé¢
    document.body.appendChild(exportDialog);
    menuOverlay.classList.add('show');
    
    // æ·»åŠ äº‹ä»¶ç›‘å¬
    document.getElementById('cancelExportBtn').addEventListener('click', () => {
        document.body.removeChild(exportDialog);
        menuOverlay.classList.remove('show');
    });
    
    document.getElementById('confirmExportBtn').addEventListener('click', () => {
        const exportAll = document.getElementById('exportAll').checked;
        startExport(exportAll, exportDialog);
    });
}

// å¼€å§‹å¯¼å‡º
function startExport(exportAll, exportDialog) {
    const progressContainer = document.getElementById('exportProgress');
    const progressBar = document.getElementById('progressBar');
    const progressPercent = document.getElementById('progressPercent');
    
    // æ˜¾ç¤ºè¿›åº¦æ¡
    progressContainer.style.display = 'block';
    
    // ç¦ç”¨æŒ‰é’®
    document.getElementById('confirmExportBtn').disabled = true;
    document.getElementById('cancelExportBtn').disabled = true;
    
    // æ¨¡æ‹Ÿè¿›åº¦æ›´æ–°
    let progress = 0;
    const progressInterval = setInterval(() => {
        progress += 10;
        progressBar.style.width = progress + '%';
        progressPercent.textContent = progress + '%';
        
        if (progress >= 100) {
            clearInterval(progressInterval);
            // æ‰§è¡Œå®é™…å¯¼å‡º
            exportToExcel(exportAll, exportDialog);
        }
    }, 100);
}

// å¯¼å‡ºä¸ºExcelæ–‡ä»¶ï¼ˆå¢å¼ºç‰ˆï¼‰
function exportToExcel(exportAll = true, exportDialog = null) {
    try {
        // åˆ›å»ºå·¥ä½œç°¿
        const wb = XLSX.utils.book_new();
        
        // ç¡®å®šè¦å¯¼å‡ºçš„æ ‡ç­¾
        const tabsToExport = exportAll ? state.tabs : [state.tabs.find(t => t.id === state.currentTabId)].filter(Boolean);
        
        let totalMessages = 0;
        tabsToExport.forEach(tab => {
            if (tab && tab.messages) {
                totalMessages += tab.messages.length;
            }
        });
        
        if (totalMessages === 0) {
            if (exportDialog) {
                document.body.removeChild(exportDialog);
                menuOverlay.classList.remove('show');
            }
            showConfirmDialog('å¯¼å‡ºå¤±è´¥', 'æ²¡æœ‰èŠå¤©è®°å½•å¯å¯¼å‡ºï¼', null, true);
            return;
        }
        
        // ä¸ºæ¯ä¸ªæ ‡ç­¾åˆ›å»ºä¸€ä¸ªå·¥ä½œè¡¨
        tabsToExport.forEach((tab, index) => {
            if (!tab || tab.messages.length === 0) return;
            
            // å‡†å¤‡æ•°æ®è¡Œ
            const data = [];
            
            // æ·»åŠ è¡¨å¤´ï¼ˆå¸¦æ ·å¼æ ‡è®°ï¼‰
            data.push(['ç”¨æˆ·å', 'æ—¶é—´', 'å†…å®¹', 'æ ‡ç­¾', 'æ¶ˆæ¯ç±»å‹', 'çŠ¶æ€']);
            
            // æ·»åŠ æ¶ˆæ¯æ•°æ®
            tab.messages.forEach(message => {
                const time = new Date(message.time);
                const formattedTime = time.toLocaleString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: false
                }).replace(/\//g, '-');
                
                // æ¸…ç†å†…å®¹
                const cleanContent = cleanMessageContent(message.content);
                
                // åˆ¤æ–­æ¶ˆæ¯ç±»å‹
                let messageType = 'æ™®é€šæ¶ˆæ¯';
                if (message.content.includes('[é‡è¦]')) {
                    messageType = 'é‡è¦æ¶ˆæ¯';
                } else if (message.content.includes('[å¾…åŠ]') || message.content.includes('[å¾…åŠå®Œæˆ]')) {
                    messageType = 'å¾…åŠäº‹é¡¹';
                }
                
                // åˆ¤æ–­çŠ¶æ€
                let status = message.isSelf ? 'è‡ªå·±å‘é€' : 'åŠ©æ‰‹å›å¤';
                if (message.content.includes('[å¾…åŠå®Œæˆ]')) {
                    status = 'å·²å®Œæˆ';
                } else if (message.content.includes('[å¾…åŠ]')) {
                    status = 'å¾…åŠä¸­';
                }
                
                data.push([
                    message.username,
                    formattedTime,
                    cleanContent,
                    tab.name,
                    messageType,
                    status
                ]);
            });
            
            // åˆ›å»ºå·¥ä½œè¡¨
            const ws = XLSX.utils.aoa_to_sheet(data);
            
            // è®¾ç½®åˆ—å®½
            const colWidths = [
                { wch: 12 }, // ç”¨æˆ·å
                { wch: 20 }, // æ—¶é—´
                { wch: 60 }, // å†…å®¹
                { wch: 12 }, // æ ‡ç­¾
                { wch: 12 }, // æ¶ˆæ¯ç±»å‹
                { wch: 10 }  // çŠ¶æ€
            ];
            ws['!cols'] = colWidths;
            
            // æ·»åŠ å·¥ä½œè¡¨åˆ°å·¥ä½œç°¿
            const sheetName = tab.name
                .replace(/[\\\/:*?"<>|]/g, '_')
                .substring(0, 30) || `æ ‡ç­¾${tab.id}`;
            XLSX.utils.book_append_sheet(wb, ws, sheetName);
        });
        
        // ç”Ÿæˆæ–‡ä»¶å
        const now = new Date();
        const timestamp = now.toLocaleString('zh-CN', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit',
            hour12: false
        }).replace(/[\/:\s]/g, '').replace(/[å¹´æœˆæ—¥æ—¶åˆ†ç§’]/g, '');
        
        const filename = `${state.username}çš„èŠå¤©è®°å½•${timestamp}.xlsx`;
        
        // å¯¼å‡ºæ–‡ä»¶
        XLSX.writeFile(wb, filename);
        
        // æ¸…ç†å¯¹è¯æ¡†
        if (exportDialog) {
            document.body.removeChild(exportDialog);
            menuOverlay.classList.remove('show');
        }
        
        // æ˜¾ç¤ºæˆåŠŸæç¤º
        showConfirmDialog('å¯¼å‡ºæˆåŠŸ', 
            `âœ“ èŠå¤©è®°å½•å¯¼å‡ºå®Œæˆï¼\n\n` +
            `æ–‡ä»¶åï¼š${filename}\n` +
            `å¯¼å‡ºæ ‡ç­¾ï¼š${tabsToExport.filter(t => t.messages.length > 0).length}ä¸ª\n` +
            `æ€»æ¶ˆæ¯æ•°ï¼š${totalMessages}æ¡\n\n` +
            `æ–‡ä»¶å·²ä¿å­˜åˆ°æ‚¨çš„ä¸‹è½½æ–‡ä»¶å¤¹`, 
            null, true);
        
    } catch (error) {
        console.error('å¯¼å‡ºå¤±è´¥:', error);
        
        // æ¸…ç†å¯¹è¯æ¡†
        if (exportDialog) {
            document.body.removeChild(exportDialog);
            menuOverlay.classList.remove('show');
        }
        
        showConfirmDialog('å¯¼å‡ºå¤±è´¥', 
            `å¯¼å‡ºè¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ï¼š\n${error.message}\n\n` +
            `å»ºè®®ï¼š\n` +
            `1. ç¡®ä¿æµè§ˆå™¨å…è®¸ä¸‹è½½æ–‡ä»¶\n` +
            `2. æ£€æŸ¥æ˜¯å¦æœ‰è¶³å¤Ÿçš„å­˜å‚¨ç©ºé—´\n` +
            `3. å¦‚æœé—®é¢˜æŒç»­ï¼Œè¯·å°è¯•åˆ·æ–°é¡µé¢`, 
            null, true);
    }
}

// æ¸…ç†æ¶ˆæ¯å†…å®¹çš„è¾…åŠ©å‡½æ•°
function cleanMessageContent(content) {
    return content
        .replace(/<br\s*\/?>/gi, '\n')  // æ›¿æ¢æ¢è¡Œç¬¦
        .replace(/<[^>]*>/g, '')        // ç§»é™¤HTMLæ ‡ç­¾
        // ç§»é™¤æ ¼å¼æ ‡ç­¾
        .replace(/\[b\](.*?)\[\/b\]/g, '$1')
        .replace(/\[i\](.*?)\[\/i\]/g, '$1')
        .replace(/\[u\](.*?)\[\/u\]/g, '$1')
        .replace(/\[s\](.*?)\[\/s\]/g, '$1')
        // ç§»é™¤ç‰¹æ®Šæ ‡è®°
        .replace(/\[é‡è¦\]/g, '')
        .replace(/\[å¾…åŠ\]/g, '')
        .replace(/\[å¾…åŠå®Œæˆ\]/g, '')
        .replace(/\n{3,}/g, '\n\n')     // åˆå¹¶å¤šä¸ªç©ºè¡Œ
        .trim();
}

function showAboutInfo() {
    showConfirmDialog('å…³äº', '', null, true);
    confirmMessage.innerHTML = 'Kwenbinçš„èŠå¤©å¼è®°äº‹æœ¬<br>ç‰ˆæœ¬v1.0.0<br>Â© 2026<br><br>' +
        '<a href="help.html" style="color: #3498db; text-decoration: none; display: inline-block; margin-top: 10px; padding: 8px 16px; background: #f0f7ff; border-radius: 20px; font-weight: 600;">' +
        '<i class="fas fa-question-circle"></i> æŸ¥çœ‹è¯¦ç»†å¸®åŠ©æ–‡æ¡£</a>';
    confirmBtn.textContent = 'ç¡®å®š';
}

        // æ ¹æ®IDæŸ¥æ‰¾æ¶ˆæ¯
        function findMessageById(id) {
            const currentTab = state.tabs.find(t => t.id === state.currentTabId);
            if (!currentTab) return null;
            return currentTab.messages.find(m => m.id === id);
        }

        // å¤„ç†è¾“å…¥å˜åŒ–
        function handleInputChange() {
            adjustInputHeight();
            
            if (messageInput.value.trim().length > 0) {
                sendBtn.classList.add('show');
            } else {
                sendBtn.classList.remove('show');
            }
        }

        // å¤„ç†è¾“å…¥æ¡†èšç„¦
        function handleInputFocus() {
            messageInput.classList.add('focused');
        }

        // å¤„ç†è¾“å…¥æ¡†å¤±ç„¦
        function handleInputBlur() {
            messageInput.classList.remove('focused');
            inputContainer.classList.remove('keyboard-open');
        }

        // å¤„ç†çª—å£å¤§å°å˜åŒ–
        function handleResize() {
            if (window.visualViewport) {
                if (window.visualViewport.height < window.innerHeight * 0.7) {
                    inputContainer.classList.add('keyboard-open');
                } else {
                    inputContainer.classList.remove('keyboard-open');
                }
            }
        }

        // è°ƒæ•´è¾“å…¥æ¡†é«˜åº¦
        function adjustInputHeight() {
            messageInput.style.height = 'auto';
            const newHeight = Math.min(messageInput.scrollHeight, 200);
            messageInput.style.height = newHeight + 'px';
        }

        // å¤„ç†é”®ç›˜æŒ‰é”® - ä¿®å¤ï¼šæ ¹æ®è®¾ç½®å¤„ç†Enteré”®
        function handleKeyDown(event) {
            if (window.isComposing) return;
            
            // æ ¹æ®è®¾ç½®åˆ¤æ–­å‘é€æ–¹å¼
            if (state.settings.sendKey === 'enter') {
                // Enter å‘é€ï¼ŒShift+Enter æ¢è¡Œ
                if (event.key === 'Enter' && !event.shiftKey) {
                    event.preventDefault();
                    sendMessage();
                }
                // Shift+Enter è‡ªåŠ¨æ¢è¡Œï¼Œæ— éœ€ç‰¹æ®Šå¤„ç†
            } else {
                // Shift+Enter å‘é€ï¼ŒEnter æ¢è¡Œ
                if (event.key === 'Enter' && event.shiftKey) {
                    event.preventDefault();
                    sendMessage();
                }
                // Enter è‡ªåŠ¨æ¢è¡Œï¼Œæ— éœ€ç‰¹æ®Šå¤„ç†
            }
        }

// å‘é€æ¶ˆæ¯
function sendMessage() {
    const content = messageInput.value.trim();
    
    if (!content) {
        showConfirmDialog('æç¤º', 'è¯·è¾“å…¥å†…å®¹ï¼', null, true);
        return;
    }
    
    const now = new Date();
    const message = {
        id: Date.now(),
        username: state.username,
        content: content,
        time: now,
        isSelf: true,
        formattedTime: formatTime(now)
    };
    
    const currentTab = state.tabs.find(t => t.id === state.currentTabId);
    if (currentTab) {
        currentTab.messages.push(message);
    }
    
    state.messages.push(message);
    
    addMessageToChat(message);
    
    messageInput.value = '';
    adjustInputHeight();
    sendBtn.classList.remove('show');
    
    emptyState.style.display = 'none';
    
    scrollToBottom();
    
    saveToLocalStorage();
    
    // ç²¾ç¡®æ£€æŸ¥æ˜¯å¦æ˜¯"å¸®åŠ©"äºŒå­—
    if (content === 'å¸®åŠ©') {
        setTimeout(() => {
            generateHelpReply();
        }, 1000);
    } else if (Math.random() * 100 < state.autoReplyProbability && state.autoReplies.length > 0) {
        setTimeout(() => {
            generateAutoReply(content);
        }, 1000 + Math.random() * 1000);
    }
}

// ç”Ÿæˆå¸®åŠ©å›å¤ - ç®€å•ç‰ˆæœ¬ï¼ˆä¿®æ”¹ä¸ºå½“å‰é¡µé¢è·³è½¬ï¼‰
function generateHelpReply() {
    const currentTab = state.tabs.find(t => t.id === state.currentTabId);
    if (!currentTab) return;
    
    const now = new Date();
    const helpMessage = {
        id: Date.now() + 1,
        username: state.assistantName,
        content: 'ğŸ“– ç‚¹å‡»ä¸‹æ–¹é“¾æ¥æŸ¥çœ‹å®Œæ•´å¸®åŠ©æ–‡æ¡£ï¼š\n' +
                '<div style="text-align: center; margin: 15px 0;">' +
                '<a href="help.html" style="color: white; text-decoration: none; display: inline-block; padding: 12px 24px; background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); border-radius: 25px; font-weight: 600; font-size: 16px; box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3); transition: all 0.2s ease; cursor: pointer;" onclick="window.location.href=\'help.html\'">' +
                '<i class="fas fa-book" style="margin-right: 8px;"></i>æ‰“å¼€å¸®åŠ©æ–‡æ¡£</a>' +
                '</div>' +
                'å¸®åŠ©æ–‡æ¡£åŒ…å«ï¼š\n' +
                'â€¢ ä½¿ç”¨æ•™ç¨‹\n' +
                'â€¢ åŠŸèƒ½è¯´æ˜\n' +
                'â€¢ å¸¸è§é—®é¢˜\n' +
                'â€¢ ä½¿ç”¨æŠ€å·§\n' +
                '<div style="font-size: 14px; color: #7f8c8d; margin-top: 10px;">' +
                '<i class="fas fa-info-circle" style="color: #3498db; margin-right: 5px;"></i>ç‚¹å‡»åå°†åœ¨å½“å‰é¡µé¢è·³è½¬åˆ°å¸®åŠ©æ–‡æ¡£' +
                '</div>',
        time: now,
        isSelf: false,
        formattedTime: formatTime(now)
    };
    
    currentTab.messages.push(helpMessage);
    state.messages.push(helpMessage);
    
    addMessageToChat(helpMessage);
    
    scrollToBottom();
    saveToLocalStorage();
}

        // ç”Ÿæˆè‡ªåŠ¨å›å¤
        function generateAutoReply(userMessage) {
            const randomIndex = Math.floor(Math.random() * state.autoReplies.length);
            const replyContent = state.autoReplies[randomIndex];
            
            const now = new Date();
            const autoReplyMessage = {
                id: Date.now() + 1,
                username: state.assistantName,
                content: replyContent,
                time: now,
                isSelf: false,
                formattedTime: formatTime(now)
            };
            
            const currentTab = state.tabs.find(t => t.id === state.currentTabId);
            if (currentTab) {
                currentTab.messages.push(autoReplyMessage);
            }
            
            state.messages.push(autoReplyMessage);
            
            addMessageToChat(autoReplyMessage);
            
            scrollToBottom();
            saveToLocalStorage();
        }

        // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©ç•Œé¢
        function addMessageToChat(message) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${message.isSelf ? 'self' : 'other'}`;
            messageDiv.dataset.messageId = message.id;
            
            const messageHeader = document.createElement('div');
            messageHeader.className = 'message-header';
            
            const username = document.createElement('span');
            username.className = 'username';
            username.textContent = message.username;
            
            const messageTime = document.createElement('span');
            messageTime.className = 'message-time';
            messageTime.textContent = message.formattedTime;
            
            if (message.isSelf) {
                messageHeader.appendChild(messageTime);
                messageHeader.appendChild(document.createTextNode(' '));
                messageHeader.appendChild(username);
            } else {
                messageHeader.appendChild(username);
                messageHeader.appendChild(document.createTextNode(' '));
                messageHeader.appendChild(messageTime);
            }
            
            const bubble = document.createElement('div');
            bubble.className = 'bubble';
            
            // åº”ç”¨å­—ä½“å¤§å°
            bubble.style.fontSize = state.settings.fontSize + 'px';
            
            if (message.content.includes('[é‡è¦]')) {
                bubble.classList.add('important');
            }
            
            if (message.content.includes('[å¾…åŠ]')) {
                bubble.classList.add('todo-pending');
            } else if (message.content.includes('[å¾…åŠå®Œæˆ]')) {
                bubble.classList.add('todo-completed');
            }
            
            bubble.innerHTML = formatMessageContent(message.content);
            
            messageDiv.appendChild(messageHeader);
            messageDiv.appendChild(bubble);
            
            chatContainer.appendChild(messageDiv);
        }

        // æ ¼å¼åŒ–æ¶ˆæ¯å†…å®¹
        function formatMessageContent(content) {
            let formatted = content.replace(/\n/g, '<br>');
            
            formatted = formatted
                .replace(/\[b\](.*?)\[\/b\]/g, '<strong>$1</strong>')
                .replace(/\[i\](.*?)\[\/i\]/g, '<em>$1</em>')
                .replace(/\[u\](.*?)\[\/u\]/g, '<u>$1</u>')
                .replace(/\[s\](.*?)\[\/s\]/g, '<s>$1</s>')
                .replace(/\[é‡è¦\] /g, '<span style="color:#e74c3c;font-weight:bold;">[é‡è¦] </span>')
                .replace(/\[å¾…åŠ\] /g, '<span style="color:#2ecc71;font-weight:bold;">[å¾…åŠ] </span>')
                .replace(/\[å¾…åŠå®Œæˆ\] /g, '<span style="color:#27ae60;font-weight:bold;">[å·²å®Œæˆ] </span>');
          // å¦‚æœæ˜¯å·²å®ŒæˆçŠ¶æ€ï¼Œæ·»åŠ åˆ é™¤çº¿æ ·å¼
         if (content.includes('[å¾…åŠå®Œæˆ]')) {
        formatted = formatted.replace(/<span style="color:#27ae60;font-weight:bold;">\[å·²å®Œæˆ\] <\/span>(.*)/, 
            '<span style="color:#27ae60;font-weight:bold;">[å·²å®Œæˆ] </span><span style="text-decoration: line-through; opacity: 0.8;">$1</span>');
        }            
            return formatted;
        }

        // æ ¼å¼åŒ–æ—¶é—´
        function formatTime(date) {
            const now = new Date();
            const messageDate = new Date(date);
            
            if (messageDate.toDateString() === now.toDateString()) {
                return messageDate.toLocaleTimeString('zh-CN', { 
                    hour: '2-digit', 
                    minute: '2-digit',
                    hour12: false
                });
            }
            
            const month = messageDate.getMonth() + 1;
            const day = messageDate.getDate();
            const hours = messageDate.getHours().toString().padStart(2, '0');
            const minutes = messageDate.getMinutes().toString().padStart(2, '0');
            
            return `${month}/${day} ${hours}:${minutes}`;
        }

        // æ¸²æŸ“æ‰€æœ‰æ¶ˆæ¯
        function renderMessages() {
            chatContainer.innerHTML = '';
            
            const currentTab = state.tabs.find(t => t.id === state.currentTabId);
            if (!currentTab || currentTab.messages.length === 0) {
                emptyState.style.display = 'flex';
                return;
            }
            
            emptyState.style.display = 'none';
            
            let lastDate = null;
            currentTab.messages.forEach((message, index) => {
                const messageDate = new Date(message.time).toDateString();
                
                if (lastDate !== messageDate) {
                    const timeDivider = document.createElement('div');
                    timeDivider.className = 'time-divider';
                    
                    const timeText = document.createElement('div');
                    timeText.className = 'time-text';
                    
                    const now = new Date();
                    const today = now.toDateString();
                    const yesterday = new Date(now.setDate(now.getDate() - 1)).toDateString();
                    
                    if (messageDate === today) {
                        timeText.textContent = 'ä»Šå¤©';
                    } else if (messageDate === yesterday) {
                        timeText.textContent = 'æ˜¨å¤©';
                    } else {
                        const date = new Date(message.time);
                        timeText.textContent = `${date.getMonth() + 1}/${date.getDate()}`;
                    }
                    
                    timeDivider.appendChild(timeText);
                    chatContainer.appendChild(timeDivider);
                    
                    lastDate = messageDate;
                }
                
                addMessageToChat(message);
            });
            
            scrollToBottom();
        }

        // æ»šåŠ¨åˆ°åº•éƒ¨
        function scrollToBottom() {
            setTimeout(() => {
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }, 100);
        }

        // æ’å…¥æ ¼å¼åŒ–æ ‡ç­¾
        function insertFormatting(startTag, endTag) {
            const start = messageInput.selectionStart;
            const end = messageInput.selectionEnd;
            
            if (start !== end) {
                const selectedText = messageInput.value.substring(start, end);
                messageInput.value = messageInput.value.substring(0, start) + startTag + selectedText + endTag + messageInput.value.substring(end);
                messageInput.setSelectionRange(start + startTag.length, end + startTag.length);
            } else {
                messageInput.value = messageInput.value.substring(0, start) + startTag + endTag + messageInput.value.substring(end);
                messageInput.setSelectionRange(start + startTag.length, start + startTag.length);
            }
            
            messageInput.focus();
            handleInputChange();
        }

        // æ’å…¥æ–‡æœ¬
        function insertText(text) {
            const start = messageInput.selectionStart;
            const end = messageInput.selectionEnd;
            
            messageInput.value = messageInput.value.substring(0, start) + text + messageInput.value.substring(end);
            messageInput.focus();
            messageInput.setSelectionRange(start + text.length, start + text.length);
            
            handleInputChange();
        }

        // æ‰“å¼€ä¾§æ»‘èœå•
        function openSideMenu() {
            sideMenu.classList.add('open');
            menuOverlay.classList.add('show');
        }

        // å…³é—­ä¾§æ»‘èœå•
        function closeSideMenu() {
            sideMenu.classList.remove('open');
            menuOverlay.classList.remove('show');
        }

        // æ‰“å¼€è®¾ç½®èœå•
        function openSettingsMenu() {
            settingsMenu.classList.add('open');
            menuOverlay.classList.add('show');
        }

        // å…³é—­è®¾ç½®èœå•
        function closeSettingsMenu() {
            settingsMenu.classList.remove('open');
            menuOverlay.classList.remove('show');
        }

        // æ‰“å¼€ç”¨æˆ·åå¯¹è¯æ¡†
        function openUsernameDialog() {
            usernameInput.value = state.username;
            usernameDialog.classList.add('show');
            menuOverlay.classList.add('show');
        }

        // å…³é—­ç”¨æˆ·åå¯¹è¯æ¡†
        function closeUsernameDialog() {
            usernameDialog.classList.remove('show');
            menuOverlay.classList.remove('show');
        }

        // ä¿å­˜ç”¨æˆ·å
        function saveUsername() {
            const newUsername = usernameInput.value.trim();
            if (newUsername) {
                state.username = newUsername;
                
                const currentTab = state.tabs.find(t => t.id === state.currentTabId);
                if (currentTab) {
                    currentTab.messages.forEach(message => {
                        if (message.isSelf) {
                            message.username = newUsername;
                        }
                    });
                }
                
                renderMessages();
                saveToLocalStorage();
                closeUsernameDialog();
                showConfirmDialog('ä¿®æ”¹æˆåŠŸ', 'ç”¨æˆ·åå·²ä¿®æ”¹ï¼', null, true);
            }
        }

        // æ›´æ–°å½“å‰æ ‡ç­¾
        function updateCurrentTab() {
            const currentTab = state.tabs.find(t => t.id === state.currentTabId);
            if (currentTab) {
                currentTabName.textContent = currentTab.name;
                state.messages = [...currentTab.messages];
            }
        }

        // æ›´æ–°æ ‡ç­¾åˆ—è¡¨
        function updateTabsList() {
            tabsList.innerHTML = '';
            
            const sortedTabs = [...state.tabs].sort((a, b) => {
                if (a.pinned && !b.pinned) return -1;
                if (!a.pinned && b.pinned) return 1;
                return a.id - b.id;
            });
            
            sortedTabs.forEach(tab => {
                const tabItem = document.createElement('div');
                tabItem.className = `tab-item ${tab.id === state.currentTabId ? 'active' : ''}`;
                tabItem.dataset.id = tab.id;
                
                const tabHeader = document.createElement('div');
                tabHeader.className = 'tab-item-header';
                
                const tabName = document.createElement('div');
                tabName.className = 'tab-name';
                tabName.textContent = tab.name;
                
                const tabActions = document.createElement('div');
                tabActions.className = 'tab-actions';
                
                // ç½®é¡¶æŒ‰é’®
                const pinBtn = document.createElement('button');
                pinBtn.className = `tab-action-btn pin ${tab.pinned ? 'active' : ''}`;
                pinBtn.title = tab.pinned ? 'å–æ¶ˆç½®é¡¶' : 'ç½®é¡¶';
                pinBtn.innerHTML = tab.pinned ? '<i class="fas fa-thumbtack"></i>' : '<i class="far fa-thumbtack"></i>';
                pinBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    togglePinTab(tab.id);
                });
                
                // é‡å‘½åæŒ‰é’®
                const renameBtn = document.createElement('button');
                renameBtn.className = 'tab-action-btn rename';
                renameBtn.title = 'é‡å‘½å';
                renameBtn.innerHTML = '<i class="fas fa-edit"></i>';
                renameBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    openRenameDialog(tab.name, tab.id);
                });
                
                // åˆ é™¤æŒ‰é’®
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'tab-action-btn delete';
                deleteBtn.title = 'åˆ é™¤';
                deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    deleteTab(tab.id);
                });
                
                tabActions.appendChild(pinBtn);
                tabActions.appendChild(renameBtn);
                tabActions.appendChild(deleteBtn);
                
                tabHeader.appendChild(tabName);
                tabHeader.appendChild(tabActions);
                
                const tabPreview = document.createElement('div');
                tabPreview.className = 'tab-preview';
                
                if (tab.messages.length > 0) {
                    const lastMessage = tab.messages[tab.messages.length - 1];
                    let preview = lastMessage.content.replace(/\[.*?\]/g, '');
                    if (preview.length > 20) {
                        preview = preview.substring(0, 20) + '...';
                    }
                    tabPreview.textContent = preview;
                } else {
                    tabPreview.textContent = 'ç©ºè®°å½•';
                }
                
                tabItem.appendChild(tabHeader);
                tabItem.appendChild(tabPreview);
                
                tabItem.addEventListener('click', () => {
                    document.querySelectorAll('.tab-item').forEach(item => {
                        item.classList.remove('active');
                    });
                    
                    tabItem.classList.add('active');
                    
                    state.currentTabId = tab.id;
                    updateCurrentTab();
                    renderMessages();
                    closeSideMenu();
                });
                
                tabsList.appendChild(tabItem);
            });
        }

        // åˆ‡æ¢ç½®é¡¶çŠ¶æ€
        function togglePinTab(tabId) {
            const tabIndex = state.tabs.findIndex(t => t.id === tabId);
            if (tabIndex !== -1) {
                state.tabs[tabIndex].pinned = !state.tabs[tabIndex].pinned;
                updateTabsList();
                saveToLocalStorage();
            }
        }

        // åˆ é™¤æ ‡ç­¾
        function deleteTab(tabId) {
            if (state.tabs.length <= 1) {
                showConfirmDialog('æ— æ³•åˆ é™¤', 'è‡³å°‘éœ€è¦ä¸€ä¸ªèŠå¤©æ ‡ç­¾ï¼', null, true);
                return;
            }
            
            const tab = state.tabs.find(t => t.id === tabId);
            if (!tab) return;
            
            showConfirmDialog('åˆ é™¤æ ‡ç­¾', `ç¡®å®šè¦åˆ é™¤æ ‡ç­¾"${tab.name}"å—ï¼Ÿæ‰€æœ‰æ¶ˆæ¯å°†è¢«åˆ é™¤ã€‚`, () => {
                const tabIndex = state.tabs.findIndex(t => t.id === tabId);
                if (tabIndex !== -1) {
                    state.tabs.splice(tabIndex, 1);
                    
                    if (tabId === state.currentTabId) {
                        state.currentTabId = state.tabs[0].id;
                        updateCurrentTab();
                        renderMessages();
                    }
                    
                    updateTabsList();
                    saveToLocalStorage();
                }
            });
        }

        // åˆ›å»ºæ–°æ ‡ç­¾
        function createNewTab() {
            const newTabId = Date.now();
            const newTab = {
                id: newTabId,
                name: `èŠå¤© ${state.tabs.length + 1}`,
                messages: [],
                active: false,
                pinned: false
            };
            
            state.tabs.push(newTab);
            state.currentTabId = newTabId;
            
            updateCurrentTab();
            updateTabsList();
            renderMessages();
            
            closeSideMenu();
            
            saveToLocalStorage();
        }

        // åˆ‡æ¢ä¸»é¢˜
        function toggleTheme() {
            if (state.settings.theme === 'light') {
                state.settings.theme = 'dark';
                document.body.style.backgroundColor = '#2c3e50';
                document.body.style.color = '#ffffff';
                document.querySelector('.top-bar').style.backgroundColor = '#34495e';
                document.querySelector('.top-bar').style.borderBottomColor = '#2c3e50';
                document.querySelector('.chat-container').style.backgroundColor = '#2c3e50';
                document.querySelector('.input-container').style.backgroundColor = '#34495e';
                document.querySelector('.input-container').style.borderTopColor = '#2c3e50';
                document.querySelector('.message-input').style.backgroundColor = '#34495e';
                document.querySelector('.message-input').style.color = '#ffffff';
                document.querySelector('.input-toolbar').style.borderTopColor = '#2c3e50';
                document.querySelectorAll('.format-btn').forEach(btn => {
                    btn.style.backgroundColor = '#2c3e50';
                    btn.style.color = '#ecf0f1';
                });
                
                showConfirmDialog('ä¸»é¢˜åˆ‡æ¢', 'å·²åˆ‡æ¢ä¸ºæ·±è‰²ä¸»é¢˜', null, true);
            } else {
                state.settings.theme = 'light';
                document.body.style.backgroundColor = '#f8f9fa';
                document.body.style.color = '#2c3e50';
                document.querySelector('.top-bar').style.backgroundColor = '#ffffff';
                document.querySelector('.top-bar').style.borderBottomColor = '#eaeaea';
                document.querySelector('.chat-container').style.backgroundColor = '#f8f9fa';
                document.querySelector('.input-container').style.backgroundColor = '#ffffff';
                document.querySelector('.input-container').style.borderTopColor = '#eaeaea';
                document.querySelector('.message-input').style.backgroundColor = '#ffffff';
                document.querySelector('.message-input').style.color = '#2c3e50';
                document.querySelector('.input-toolbar').style.borderTopColor = '#f1f1f1';
                document.querySelectorAll('.format-btn').forEach(btn => {
                    btn.style.backgroundColor = '#ecf0f1';
                    btn.style.color = '#3498db';
                });
                
                showConfirmDialog('ä¸»é¢˜åˆ‡æ¢', 'å·²åˆ‡æ¢ä¸ºæµ…è‰²ä¸»é¢˜', null, true);
            }
            
            saveToLocalStorage();
        }

        // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
        function saveToLocalStorage() {
            const data = {
                username: state.username,
                assistantName: state.assistantName,
                tabs: state.tabs,
                currentTabId: state.currentTabId,
                autoReplyProbability: state.autoReplyProbability,
                autoReplies: state.autoReplies,
                completedTodos: state.completedTodos,
                assistantTodoMap: state.assistantTodoMap,
                assistantTodoStates: state.assistantTodoStates,
                settings: state.settings
            };
            
            localStorage.setItem('chatNotepad_mobile', JSON.stringify(data));
        }

        // ä»æœ¬åœ°å­˜å‚¨åŠ è½½
        function loadFromLocalStorage() {
            try {
                const saved = localStorage.getItem('chatNotepad_mobile');
                if (saved) {
                    const data = JSON.parse(saved);
                    
                    state.username = data.username || 'æˆ‘';
                    state.assistantName = data.assistantName || 'åŠ©æ‰‹';
                    state.tabs = data.tabs || state.tabs;
                    state.currentTabId = data.currentTabId || 1;
                    state.autoReplyProbability = data.autoReplyProbability || 70;
                    state.autoReplies = data.autoReplies || state.autoReplies;
                    state.completedTodos = data.completedTodos || {};
                    state.assistantTodoMap = data.assistantTodoMap || {};
                    state.assistantTodoStates = data.assistantTodoStates || {};
                    state.settings = data.settings || state.settings;
                    
                    if (state.settings.theme === 'dark') {
                        document.body.style.backgroundColor = '#2c3e50';
                        document.body.style.color = '#ffffff';
                        document.querySelector('.top-bar').style.backgroundColor = '#34495e';
                        document.querySelector('.top-bar').style.borderBottomColor = '#2c3e50';
                        document.querySelector('.chat-container').style.backgroundColor = '#2c3e50';
                        document.querySelector('.input-container').style.backgroundColor = '#34495e';
                        document.querySelector('.input-container').style.borderTopColor = '#2c3e50';
                        document.querySelector('.message-input').style.backgroundColor = '#34495e';
                        document.querySelector('.message-input').style.color = '#ffffff';
                        document.querySelector('.input-toolbar').style.borderTopColor = '#2c3e50';
                        document.querySelectorAll('.format-btn').forEach(btn => {
                            btn.style.backgroundColor = '#2c3e50';
                            btn.style.color = '#ecf0f1';
                        });
                    }
                }
            } catch (error) {
                console.error('åŠ è½½æœ¬åœ°å­˜å‚¨å¤±è´¥:', error);
            }
        }
        
// å®Œæ•´çš„å¿«æ·æ–¹å¼å¤„ç†
function handleShortcutActions() {
    const urlParams = new URLSearchParams(window.location.search);
    
    // æ£€æµ‹å„ç§å‚æ•°
    const action = urlParams.get('action');
    const newParam = urlParams.get('new');
    const todoParam = urlParams.get('todo');
    const completedParam = urlParams.get('completed');
    const importantParam = urlParams.get('important');
    
    // æ£€æµ‹æ˜¯å¦æ˜¯ä»æœç´¢é¡µé¢è·³è½¬å›æ¥çš„
    const searchJumpData = localStorage.getItem('chat_search_jump');
    if (searchJumpData) {
        try {
            const jumpData = JSON.parse(searchJumpData);
            const now = Date.now();
            
            // æ£€æŸ¥æ˜¯å¦åœ¨5ç§’å†…çš„è·³è½¬ï¼ˆé˜²æ­¢æ—§çš„è·³è½¬æ•°æ®ï¼‰
            if (now - jumpData.timestamp < 5000) {
                // åˆ‡æ¢åˆ°å¯¹åº”çš„æ ‡ç­¾
                const tab = state.tabs.find(t => t.id === jumpData.tabId);
                if (tab) {
                    state.currentTabId = jumpData.tabId;
                    updateCurrentTab();
                    renderMessages();
                    
                    // æ»šåŠ¨åˆ°å¯¹åº”çš„æ¶ˆæ¯
                    setTimeout(() => {
                        const messageElement = document.querySelector(`.message[data-message-id="${jumpData.messageId}"]`);
                        if (messageElement) {
                            messageElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            
                            // æ·»åŠ é«˜äº®æ•ˆæœ
                            messageElement.style.backgroundColor = 'rgba(52, 152, 219, 0.2)';
                            messageElement.style.borderRadius = '8px';
                            setTimeout(() => {
                                messageElement.style.backgroundColor = '';
                            }, 3000);
                        }
                    }, 500);
                }
            }
            
            // æ¸…é™¤è·³è½¬æ•°æ®
            localStorage.removeItem('chat_search_jump');
        } catch (error) {
            console.error('å¤„ç†æœç´¢è·³è½¬å¤±è´¥:', error);
            localStorage.removeItem('chat_search_jump');
        }
    }
       
    // å»¶è¿Ÿæ‰§è¡Œï¼Œç¡®ä¿é¡µé¢å®Œå…¨åŠ è½½
    setTimeout(() => {
        // ä¼˜å…ˆå¤„ç† action å‚æ•°
        if (action) {
            switch(action) {
                case 'new':
                    focusOnInput('è¯·è¾“å…¥æ–°æ¶ˆæ¯...');
                    break;
                case 'todo':
                    sendQueryToAssistant('todo');
                    break;
                case 'completed':
                    sendQueryToAssistant('completed');
                    break;
                case 'important':
                    sendQueryToAssistant('important');
                    break;
            }
        }
        // å…¼å®¹æ—§çš„å‚æ•°æ ¼å¼
        else if (newParam === 'true') {
            focusOnInput('è¯·è¾“å…¥æ–°æ¶ˆæ¯...');
        }
        else if (todoParam === 'true') {
            sendQueryToAssistant('todo');
        }
        else if (completedParam === 'true') {
            sendQueryToAssistant('completed');
        }
        else if (importantParam === 'true') {
            sendQueryToAssistant('important');
        }
    }, 800); // ç­‰å¾…é¡µé¢å®Œå…¨åŠ è½½
    
    // æ¸…é™¤URLå‚æ•°
    clearUrlParams();
}

// èšç„¦åˆ°è¾“å…¥æ¡†
function focusOnInput(hintText) {
    messageInput.focus();
    
    // æ˜¾ç¤ºæç¤º
    if (typeof window.showTemporaryMessage === 'function') {
    window.showTemporaryMessage(hintText);
} else {
    console.log(hintText); // é™çº§
    }
    
    // æ·»åŠ è§†è§‰åé¦ˆ
    messageInput.style.boxShadow = '0 0 0 2px rgba(52, 152, 219, 0.5)';
    setTimeout(() => {
        messageInput.style.boxShadow = '';
    }, 1500);
}

// æ¸…é™¤URLå‚æ•°
function clearUrlParams() {
    if (window.history.replaceState) {
        // ä¿å­˜æ»šåŠ¨ä½ç½®
        const scrollY = window.scrollY;
        
        // æ›¿æ¢URLï¼Œå»æ‰å‚æ•°
        const cleanUrl = window.location.pathname + window.location.hash;
        window.history.replaceState({}, document.title, cleanUrl);
        
        // æ¢å¤æ»šåŠ¨ä½ç½®
        window.scrollTo(0, scrollY);
    }
}      
    </script>
<!-- è¯­éŸ³æ¨¡å— - çº¯æœ¬åœ°ç¦»çº¿ï¼ˆçŸ­æŒ‰å¼€å§‹/åœæ­¢ï¼‰ -->
<script type="module">
    import { pipeline, env } from 'https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.2';

    env.allowLocalModels = true;
    env.useBrowserCache = true;
    env.useFS = true;

    // ç­‰å¾…ä¸» state æŒ‚è½½
    function waitForState() {
        return new Promise(resolve => {
            if (window.state) return resolve(window.state);
            const check = setInterval(() => {
                if (window.state) {
                    clearInterval(check);
                    resolve(window.state);
                }
            }, 50);
        });
    }

    const mainState = await waitForState();
    if (!mainState.voice) mainState.voice = {};
    const voiceState = mainState.voice;
    voiceState.modelLoaded = false;
    voiceState.modelLoading = false;
    voiceState.modelDownloadProgress = 0;
    voiceState.transcriber = null;
    voiceState.modelName = 'Xenova/whisper-base';
    voiceState.modelSize = '142MB';

    // DOM å…ƒç´ 
    const get = id => document.getElementById(id);
    const micBtn = get('micBtn');
    const modelStatusValue = get('modelStatusValue');
    const voiceModelOption = get('voiceModelOption');
    const voiceModelDialog = get('voiceModelDialog');
    const downloadModelBtn = get('downloadModelBtn');
    const deleteModelBtn = get('deleteModelBtn');
    const closeModelDialogBtn = get('closeModelDialogBtn');
    const modelProgressContainer = get('modelProgressContainer');
    const modelProgressBar = get('modelProgressBar');
    const modelProgressPercent = get('modelProgressPercent');
    const modelDetailText = get('modelDetailText');
    const messageInput = get('messageInput');
    const menuOverlay = get('menuOverlay');

    // å…¨å±€æç¤ºå‡½æ•°ï¼ˆä¾›ä¸»è„šæœ¬è°ƒç”¨ï¼‰
    window.showTemporaryMessage = function(msg) {
        const toast = document.createElement('div');
        toast.textContent = msg;
        toast.style.position = 'fixed';
        toast.style.bottom = '100px';
        toast.style.left = '50%';
        toast.style.transform = 'translateX(-50%)';
        toast.style.backgroundColor = 'rgba(0,0,0,0.8)';
        toast.style.color = 'white';
        toast.style.padding = '12px 24px';
        toast.style.borderRadius = '30px';
        toast.style.zIndex = '9999';
        toast.style.fontSize = '14px';
        toast.style.boxShadow = '0 4px 12px rgba(0,0,0,0.2)';
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 2000);
    };

    // ---------- æ£€æŸ¥ç¼“å­˜ ----------
    async function checkLocalModel() {
        try {
            const cached = await env.localModelManager?.getModelInfo(voiceState.modelName);
            if (cached) {
                voiceState.modelLoaded = true;
                micBtn && (micBtn.disabled = false, micBtn.classList.add('active'));
                modelStatusValue && (modelStatusValue.textContent = 'å·²ä¸‹è½½');
            } else {
                voiceState.modelLoaded = false;
                micBtn && (micBtn.disabled = true, micBtn.classList.remove('active'));
                modelStatusValue && (modelStatusValue.textContent = 'æœªä¸‹è½½');
            }
        } catch (e) { console.warn('æ£€æŸ¥æ¨¡å‹ç¼“å­˜å¤±è´¥', e); }
    }

    // ---------- ä¸‹è½½æ¨¡å‹ ----------
    async function loadVoiceModel(force = false) {
        if (voiceState.modelLoading) return;
        if (!force && voiceState.modelLoaded) return window.showTemporaryMessage('æ¨¡å‹å·²å°±ç»ª');

        voiceState.modelLoading = true;
        voiceState.modelDownloadProgress = 0;

        modelProgressContainer && (modelProgressContainer.style.display = 'block');
        downloadModelBtn && (downloadModelBtn.disabled = true, downloadModelBtn.textContent = 'ä¸‹è½½ä¸­...');
        modelDetailText && (modelDetailText.textContent = 'æ­£åœ¨ä¸‹è½½æ¨¡å‹ï¼ˆçº¦142MBï¼‰ï¼Œè¯·å‹¿å…³é—­é¡µé¢...');

        try {
            const progressCallback = p => {
                const percent = Math.round(p * 100);
                voiceState.modelDownloadProgress = percent;
                modelProgressBar && (modelProgressBar.style.width = percent + '%');
                modelProgressPercent && (modelProgressPercent.textContent = percent + '%');
            };

            voiceState.transcriber = await pipeline('automatic-speech-recognition', voiceState.modelName, {
                quantized: true,
                progress_callback: progressCallback
            });

            voiceState.modelLoaded = true;
            voiceState.modelLoading = false;

            micBtn && (micBtn.disabled = false, micBtn.classList.add('active'));
            modelStatusValue && (modelStatusValue.textContent = 'å·²ä¸‹è½½');
            modelDetailText && (modelDetailText.textContent = 'æ¨¡å‹å·²å°±ç»ªï¼Œå¯ä»¥ç¦»çº¿ä½¿ç”¨');
            downloadModelBtn && (downloadModelBtn.disabled = false, downloadModelBtn.textContent = 'é‡æ–°ä¸‹è½½');
            deleteModelBtn && (deleteModelBtn.style.display = 'block');
            modelProgressContainer && (modelProgressContainer.style.display = 'none');

            window.showTemporaryMessage('è¯­éŸ³æ¨¡å‹ä¸‹è½½å®Œæˆï¼');
        } catch (error) {
            console.error('æ¨¡å‹åŠ è½½å¤±è´¥:', error);
            voiceState.modelLoaded = false;
            voiceState.modelLoading = false;
            micBtn && (micBtn.disabled = true, micBtn.classList.remove('active'));
            modelStatusValue && (modelStatusValue.textContent = 'ä¸‹è½½å¤±è´¥');
            downloadModelBtn && (downloadModelBtn.disabled = false, downloadModelBtn.textContent = 'é‡è¯•ä¸‹è½½');
            modelDetailText && (modelDetailText.textContent = 'ä¸‹è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œåé‡è¯•ã€‚');
            window.showTemporaryMessage('æ¨¡å‹ä¸‹è½½å¤±è´¥: ' + error.message);
        }
    }

    // ---------- åˆ é™¤æ¨¡å‹ ----------
    async function deleteLocalModel() {
        try {
            if (env.localModelManager) {
                await env.localModelManager.deleteModel(voiceState.modelName);
                voiceState.modelLoaded = false;
                voiceState.transcriber = null;
                micBtn && (micBtn.disabled = true, micBtn.classList.remove('active'));
                modelStatusValue && (modelStatusValue.textContent = 'æœªä¸‹è½½');
                modelDetailText && (modelDetailText.textContent = 'æ¨¡å‹å·²åˆ é™¤ï¼Œå¯é‡æ–°ä¸‹è½½ã€‚');
                downloadModelBtn && (downloadModelBtn.textContent = 'ä¸‹è½½æ¨¡å‹');
                deleteModelBtn && (deleteModelBtn.style.display = 'none');
                window.showTemporaryMessage('æ¨¡å‹å·²åˆ é™¤');
            }
        } catch (e) { console.error('åˆ é™¤æ¨¡å‹å¤±è´¥', e); window.showTemporaryMessage('åˆ é™¤å¤±è´¥'); }
    }

    // ---------- å½•éŸ³ç›¸å…³ ----------
    let mediaRecorder;
    let audioChunks = [];
    let isRecording = false;

    // å¼€å§‹å½•éŸ³
    async function startRecording() {
        // é˜²æ­¢é‡å¤å¼€å§‹
        if (isRecording) {
            window.showTemporaryMessage('æ­£åœ¨å½•éŸ³ä¸­');
            return;
        }

        if (!voiceState.modelLoaded || !voiceState.transcriber) {
            window.showTemporaryMessage('è¯·å…ˆä¸‹è½½è¯­éŸ³æ¨¡å‹');
            return;
        }

        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            audioChunks = [];

            mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
            mediaRecorder.onstop = async () => {
                const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                const audioCtx = new AudioContext({ sampleRate: 16000 });
                const arrayBuffer = await audioBlob.arrayBuffer();
                const audioBuffer = await audioCtx.decodeAudioData(arrayBuffer);
                const audioData = audioBuffer.getChannelData(0);
                const gain = 2.0;
                for (let i = 0; i < audioData.length; i++) {
                    audioData[i] = Math.max(-1, Math.min(1, audioData[i] * gain));
                }
                // é«˜é€šæ»¤æ³¢å™¨ï¼Œå»é™¤ 100Hz ä»¥ä¸‹å™ªéŸ³
                const ctx = new OfflineAudioContext(1, audioData.length, 16000);
                const src = ctx.createBufferSource();
                src.buffer = audioBuffer;
                const filter = ctx.createBiquadFilter();
                filter.type = 'highpass';
                filter.frequency.value = 100;
                src.connect(filter);
                filter.connect(ctx.destination);
                src.start();
                const filteredBuffer = await ctx.startRendering();
                const filteredData = filteredBuffer.getChannelData(0);

                // æ¢å¤æŒ‰é’®çŠ¶æ€
                if (micBtn) {
                    micBtn.classList.remove('recording');
                    micBtn.querySelector('i').className = 'fas fa-microphone';
                }
                window.showTemporaryMessage('æ­£åœ¨è¯†åˆ«...');

                try {
                    const result = await voiceState.transcriber(audioData, {
                        language: 'zh',
                        task: 'transcribe'
                    });
                    if (messageInput) {
                        messageInput.value = result.text.trim();
                        messageInput.dispatchEvent(new Event('input', { bubbles: true }));
                    }
                    window.showTemporaryMessage('è¯­éŸ³è¾“å…¥å®Œæˆ');
                } catch (e) {
                    console.error('è¯†åˆ«å¤±è´¥', e);
                    window.showTemporaryMessage('è¯†åˆ«å¤±è´¥ï¼Œè¯·é‡è¯•');
                }

                // å…³é—­éŸ³é¢‘æµ
                stream.getTracks().forEach(t => t.stop());
            };

            mediaRecorder.start();
            isRecording = true;
            if (micBtn) {
                micBtn.classList.add('recording');
                micBtn.querySelector('i').className = 'fas fa-stop';
            }
            window.showTemporaryMessage('å½•éŸ³ä¸­...ç‚¹å‡»ç»“æŸ');
        } catch (e) {
            console.error('æ— æ³•è·å–éº¦å…‹é£', e);
            window.showTemporaryMessage('æ— æ³•è®¿é—®éº¦å…‹é£');
        }
    }

    // åœæ­¢å½•éŸ³
    function stopRecording() {
        if (mediaRecorder && isRecording) {
            mediaRecorder.stop();
            isRecording = false;
        }
    }

    // ---------- çŸ­æŒ‰åˆ‡æ¢å½•éŸ³/åœæ­¢ ----------
    function bindMicClick() {
        if (!micBtn) return;

        micBtn.addEventListener('click', async (e) => {
            e.preventDefault(); // é˜²æ­¢ç§»åŠ¨ç«¯åŒå‡»ç¼©æ”¾

            if (!voiceState.modelLoaded || !voiceState.transcriber) {
                window.showTemporaryMessage('è¯·å…ˆä¸‹è½½è¯­éŸ³æ¨¡å‹');
                return;
            }

            if (isRecording) {
                stopRecording();
            } else {
                await startRecording();
            }
        });
    }

    // ---------- å¯¹è¯æ¡†æ§åˆ¶ ----------
    function openVoiceModelDialog() {
        modelDetailText && (modelDetailText.textContent = voiceState.modelLoaded ? 'æ¨¡å‹å·²ç¼“å­˜ï¼Œå¯ç¦»çº¿ä½¿ç”¨ã€‚' : 'æ¨¡å‹æœªä¸‹è½½ï¼Œéœ€è¦çº¦75MBæµé‡ã€‚');
        downloadModelBtn && (downloadModelBtn.textContent = voiceState.modelLoaded ? 'é‡æ–°ä¸‹è½½' : 'ä¸‹è½½æ¨¡å‹');
        deleteModelBtn && (deleteModelBtn.style.display = voiceState.modelLoaded ? 'block' : 'none');
        modelProgressContainer && (modelProgressContainer.style.display = 'none');
        voiceModelDialog && voiceModelDialog.classList.add('show');
        menuOverlay && menuOverlay.classList.add('show');
    }
    function closeVoiceModelDialog() {
        voiceModelDialog && voiceModelDialog.classList.remove('show');
        menuOverlay && menuOverlay.classList.remove('show');
    }

    // ---------- è‡ªå®šä¹‰ç¡®è®¤æ¡† ----------
    function showCustomConfirm(title, message) {
        return new Promise(resolve => {
            const dlg = get('confirmDialog'), titleEl = get('confirmTitle'), msgEl = get('confirmMessage');
            const confirmBtn = get('confirmBtn'), cancelBtn = get('cancelConfirmBtn'), overlay = get('menuOverlay');
            if (!dlg || !titleEl || !msgEl || !confirmBtn || !cancelBtn) return resolve(false);
            titleEl.textContent = title;
            msgEl.textContent = message;
            dlg.classList.add('show');
            overlay && overlay.classList.add('show');
            const onConfirm = () => {
                confirmBtn.removeEventListener('click', onConfirm);
                cancelBtn.removeEventListener('click', onCancel);
                dlg.classList.remove('show');
                overlay && overlay.classList.remove('show');
                resolve(true);
            };
            const onCancel = () => {
                confirmBtn.removeEventListener('click', onConfirm);
                cancelBtn.removeEventListener('click', onCancel);
                dlg.classList.remove('show');
                overlay && overlay.classList.remove('show');
                resolve(false);
            };
            confirmBtn.addEventListener('click', onConfirm);
            cancelBtn.addEventListener('click', onCancel);
        });
    }

    // ---------- åˆå§‹åŒ– ----------
    async function initVoiceModule() {
        await checkLocalModel();

        voiceModelOption && voiceModelOption.addEventListener('click', () => {
            typeof window.closeSettingsMenu === 'function' && window.closeSettingsMenu();
            openVoiceModelDialog();
        });

        downloadModelBtn && downloadModelBtn.addEventListener('click', async () => {
            if (!voiceState.modelLoaded) {
                const ok = await showCustomConfirm('ä¸‹è½½æ¨¡å‹', 'é¦–æ¬¡ä¸‹è½½éœ€è¦çº¦75MBæµé‡ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ');
                if (!ok) return;
            }
            await loadVoiceModel(true);
        });

        deleteModelBtn && deleteModelBtn.addEventListener('click', async () => {
            const ok = await showCustomConfirm('åˆ é™¤æ¨¡å‹', 'ç¡®å®šè¦åˆ é™¤å·²ä¸‹è½½çš„è¯­éŸ³æ¨¡å‹å—ï¼Ÿ');
            if (ok) await deleteLocalModel();
        });

        closeModelDialogBtn && closeModelDialogBtn.addEventListener('click', closeVoiceModelDialog);

        // å…³é”®ï¼šç»‘å®šçŸ­æŒ‰ç‚¹å‡»
        bindMicClick();
    }

    setTimeout(initVoiceModule, 300);
</script>
</body>
</html>
